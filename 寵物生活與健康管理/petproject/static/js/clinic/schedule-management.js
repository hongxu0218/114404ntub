// static/js/clinic/schedule-management.js

// ========== ÂÖ®ÂüüËÆäÊï∏ ==========
let schedulesData = [];
let filteredSchedules = [];
let currentView = 'calendar';
let currentFilter = 'all';
let editingScheduleId = null;
let pageData = {};

// ========== DOM ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñ ==========
document.addEventListener('DOMContentLoaded', function() {
    initializeScheduleManagement();
});

// ========== ‰∏ªË¶ÅÂàùÂßãÂåñÂáΩÊï∏ ==========
function initializeScheduleManagement() {
    console.log('üöÄ ÂàùÂßãÂåñÊéíÁè≠ÁÆ°ÁêÜÁ≥ªÁµ±...');
    
    // ËºâÂÖ•È†ÅÈù¢Êï∏Êìö
    loadPageData();
    
    // ÂàùÂßãÂåñÂêÑÁ®ÆÂäüËÉΩ
    initializeViewToggle();
    initializeFilters();
    initializeCalendarView();
    initializeListView();
    initializeModals();
    initializeFormValidation();
    initializeActionButtons();
    initializeKeyboardShortcuts();
    
    // ËºâÂÖ•‰∏¶Ê∏≤ÊüìÊéíÁè≠Ë≥áÊñô
    loadSchedulesData();
    renderSchedules();
    
    console.log('‚úÖ ÊéíÁè≠ÁÆ°ÁêÜÁ≥ªÁµ±ÂàùÂßãÂåñÂÆåÊàê');
}

// ========== ËºâÂÖ•È†ÅÈù¢Êï∏Êìö ==========
function loadPageData() {
    if (window.schedulePageData) {
        pageData = window.schedulePageData;
        schedulesData = pageData.schedules || [];
        filteredSchedules = [...schedulesData];
        console.log('üìä ËºâÂÖ•È†ÅÈù¢Êï∏Êìö:', pageData);
    }
}

// ========== Ê™¢Ë¶ñÂàáÊèõÂäüËÉΩ ==========
function initializeViewToggle() {
    const viewToggles = document.querySelectorAll('.view-toggle');
    
    viewToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
            const view = this.dataset.view;
            switchView(view);
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            viewToggles.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function switchView(view) {
    currentView = view;
    
    // Èö±ËóèÊâÄÊúâÊ™¢Ë¶ñ
    document.querySelectorAll('.schedule-view').forEach(v => v.classList.remove('active'));
    
    // È°ØÁ§∫ÁõÆÊ®ôÊ™¢Ë¶ñ
    const targetView = document.getElementById(view + 'View');
    if (targetView) {
        targetView.classList.add('active');
        
        // Ê†πÊìöÊ™¢Ë¶ñÈ°ûÂûãÊ∏≤ÊüìÂÖßÂÆπ
        if (view === 'calendar') {
            renderCalendarView();
        } else if (view === 'list') {
            renderListView();
        }
    }
    
    console.log(`üîÑ ÂàáÊèõÂà∞ ${view} Ê™¢Ë¶ñ`);
}

// ========== ÁØ©ÈÅ∏ÂäüËÉΩ ==========
function initializeFilters() {
    const filterChips = document.querySelectorAll('.filter-chip');
    
    filterChips.forEach(chip => {
        chip.addEventListener('click', function() {
            // ÁßªÈô§ÂÖ∂‰ªñ active ÁãÄÊÖã
            filterChips.forEach(c => c.classList.remove('active'));
            
            // Ë®≠ÂÆöÁï∂Ââç active
            this.classList.add('active');
            
            // Êõ¥Êñ∞ÁØ©ÈÅ∏Ê¢ù‰ª∂
            currentFilter = this.dataset.filter;
            
            // ÊáâÁî®ÁØ©ÈÅ∏
            filterSchedules();
            
            // Ë¶ñË¶∫ÂõûÈ•ã
            animateFilterChange(this);
        });
    });
}

function filterSchedules() {
    filteredSchedules = schedulesData.filter(schedule => {
        if (currentFilter === 'all') return true;
        if (currentFilter === 'active') return schedule.isActive;
        if (currentFilter === 'morning') return isTimeInPeriod(schedule.startTime, 'morning');
        if (currentFilter === 'evening') return isTimeInPeriod(schedule.startTime, 'afternoon');
        return true;
    });
    
    renderSchedules();
    updateScheduleStats();
    
    console.log(`üîç ÁØ©ÈÅ∏ÁµêÊûú: ${filteredSchedules.length}/${schedulesData.length}`);
}

function isTimeInPeriod(timeString, period) {
    const hour = parseInt(timeString.split(':')[0]);
    
    if (period === 'morning') {
        return hour >= 6 && hour < 12;
    } else if (period === 'afternoon') {
        return hour >= 12 && hour < 18;
    } else if (period === 'evening') {
        return hour >= 18 && hour < 22;
    }
    
    return false;
}

// ========== Ë°å‰∫ãÊõÜÊ™¢Ë¶ñ ==========
function initializeCalendarView() {
    // ÂàùÂßãÂåñË°å‰∫ãÊõÜÁõ∏Èóú‰∫ã‰ª∂Áõ£ËÅΩ
    console.log('üìÖ ÂàùÂßãÂåñË°å‰∫ãÊõÜÊ™¢Ë¶ñ');
}

function renderCalendarView() {
    console.log('üé® Ê∏≤ÊüìË°å‰∫ãÊõÜÊ™¢Ë¶ñ');
    
    // Ê∏ÖÈô§ÁèæÊúâÁöÑÊéíÁè≠ÂçÄÂ°ä
    clearCalendarSchedules();
    
    // Êõ¥Êñ∞Êó•ÊúüÁµ±Ë®à
    updateDayCounters();
    
    // Ê∏≤ÊüìÊéíÁè≠ÂçÄÂ°ä
    filteredSchedules.forEach(schedule => {
        renderScheduleBlock(schedule);
    });
}

function clearCalendarSchedules() {
    document.querySelectorAll('.schedule-block').forEach(block => {
        block.remove();
    });
}

function renderScheduleBlock(schedule) {
    const timeCell = findTimeCellForSchedule(schedule);
    if (!timeCell) return;
    
    const block = document.createElement('div');
    block.className = `schedule-block ${schedule.isActive ? '' : 'inactive'}`;
    block.dataset.scheduleId = schedule.id;
    
    block.innerHTML = `
        <div class="schedule-time">${schedule.startTime}-${schedule.endTime}</div>
        <div>${schedule.appointmentDuration}min</div>
    `;
    
    // Ë®àÁÆóÈ´òÂ∫¶ÔºàÂü∫ÊñºÊåÅÁ∫åÊôÇÈñìÔºâ
    const duration = calculateDurationMinutes(schedule.startTime, schedule.endTime);
    const slotHeight = 60; // ÊØèÂ∞èÊôÇÁöÑÂÉèÁ¥†È´òÂ∫¶
    const height = (duration / 60) * slotHeight - 4; // Ê∏õÂéª margin
    
    block.style.height = `${height}px`;
    
    // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
    block.addEventListener('click', () => {
        if (pageData.canEdit) {
            editSchedule(schedule.id);
        }
    });
    
    timeCell.appendChild(block);
}

function findTimeCellForSchedule(schedule) {
    const hour = schedule.startTime.split(':')[0].padStart(2, '0') + ':00';
    return document.querySelector(`[data-weekday="${schedule.weekday}"][data-time="${hour}"]`);
}

function calculateDurationMinutes(startTime, endTime) {
    const [startHour, startMin] = startTime.split(':').map(Number);
    const [endHour, endMin] = endTime.split(':').map(Number);
    
    return (endHour * 60 + endMin) - (startHour * 60 + startMin);
}

function updateDayCounters() {
    for (let day = 0; day <= 6; day++) {
        const daySchedules = filteredSchedules.filter(s => s.weekday === day);
        const counter = document.getElementById(`dayCount${day}`);
        if (counter) {
            counter.textContent = `${daySchedules.length} ÂÄãÊéíÁè≠`;
        }
    }
}

// ========== ÂàóË°®Ê™¢Ë¶ñ ==========
function initializeListView() {
    console.log('üìã ÂàùÂßãÂåñÂàóË°®Ê™¢Ë¶ñ');
}

function renderListView() {
    console.log('üé® Ê∏≤ÊüìÂàóË°®Ê™¢Ë¶ñ');
    // ÂàóË°®Ê™¢Ë¶ñÁî±‰º∫ÊúçÂô®Á´ØÊ∏≤ÊüìÔºåÈÄôË£°‰∏ªË¶ÅËôïÁêÜÁØ©ÈÅ∏È°ØÁ§∫
    
    const scheduleCards = document.querySelectorAll('.schedule-card-modern');
    
    scheduleCards.forEach(card => {
        const scheduleId = parseInt(card.dataset.scheduleId);
        const shouldShow = filteredSchedules.some(s => s.id === scheduleId);
        
        if (shouldShow) {
            showScheduleCard(card);
        } else {
            hideScheduleCard(card);
        }
    });
}

function showScheduleCard(card) {
    card.style.display = 'block';
    card.style.animation = 'fadeInUp 0.3s ease-out';
}

function hideScheduleCard(card) {
    card.style.animation = 'fadeOut 0.3s ease-out';
    setTimeout(() => {
        card.style.display = 'none';
    }, 300);
}

// ========== Modal ÁÆ°ÁêÜ ==========
function initializeModals() {
    // Modal Â§ñÈÉ®ÈªûÊìäÈóúÈñâ
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeAllModals();
            }
        });
    });
    
    // ESC ÈçµÈóúÈñâ Modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
}

function showAddScheduleModal() {
    const modal = document.getElementById('scheduleModal');
    const form = document.getElementById('scheduleForm');
    const title = document.getElementById('modalTitle');
    const saveButton = document.getElementById('saveButtonText');
    
    // ÈáçË®≠Ë°®ÂñÆ
    form.reset();
    document.getElementById('scheduleId').value = '';
    editingScheduleId = null;
    
    // Ë®≠ÂÆöÊ®ôÈ°å
    title.textContent = 'Êñ∞Â¢ûÊéíÁè≠';
    saveButton.textContent = 'ÂÑ≤Â≠òÊéíÁè≠';
    
    // È°ØÁ§∫ Modal
    showModal(modal);
    
    console.log('‚ûï ÈñãÂïüÊñ∞Â¢ûÊéíÁè≠ Modal');
}

function editSchedule(scheduleId) {
    const schedule = schedulesData.find(s => s.id === scheduleId);
    if (!schedule) return;
    
    const modal = document.getElementById('scheduleModal');
    const form = document.getElementById('scheduleForm');
    const title = document.getElementById('modalTitle');
    const saveButton = document.getElementById('saveButtonText');
    
    // Â°´ÂÖ•ÁèæÊúâË≥áÊñô
    document.getElementById('scheduleId').value = schedule.id;
    document.getElementById('weekday').value = schedule.weekday;
    document.getElementById('startTime').value = schedule.startTime;
    document.getElementById('endTime').value = schedule.endTime;
    document.getElementById('appointmentDuration').value = schedule.appointmentDuration;
    document.getElementById('maxAppointments').value = schedule.maxAppointmentsPerSlot;
    document.getElementById('notes').value = schedule.notes || '';
    
    editingScheduleId = scheduleId;
    
    // Ë®≠ÂÆöÊ®ôÈ°å
    title.textContent = 'Á∑®ËºØÊéíÁè≠';
    saveButton.textContent = 'Êõ¥Êñ∞ÊéíÁè≠';
    
    // È°ØÁ§∫È†êË¶Ω
    updateSchedulePreview();
    
    // È°ØÁ§∫ Modal
    showModal(modal);
    
    console.log('‚úèÔ∏è ÈñãÂïüÁ∑®ËºØÊéíÁè≠ Modal:', schedule);
}

function showCopyWeekModal() {
    const modal = document.getElementById('copyWeekModal');
    showModal(modal);
    console.log('üìã ÈñãÂïüË§áË£ΩÊéíÁè≠ Modal');
}

function showModal(modal) {
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
}

function closeScheduleModal() {
    const modal = document.getElementById('scheduleModal');
    closeModal(modal);
}

function closeCopyWeekModal() {
    const modal = document.getElementById('copyWeekModal');
    closeModal(modal);
}

function closeModal(modal) {
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 250);
}

function closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        closeModal(modal);
    });
}

// ========== Ë°®ÂñÆÈ©óË≠â ==========
function initializeFormValidation() {
    const form = document.getElementById('scheduleForm');
    
    // Âç≥ÊôÇÈ†êË¶Ω
    const timeInputs = form.querySelectorAll('input[type="time"], select');
    timeInputs.forEach(input => {
        input.addEventListener('change', updateSchedulePreview);
    });
    
    // ÊôÇÈñìÈ©óË≠â
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');
    
    endTimeInput.addEventListener('change', function() {
        validateTimeRange();
    });
}

function validateTimeRange() {
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    
    if (startTime && endTime && startTime >= endTime) {
        showFormError('ÁµêÊùüÊôÇÈñìÂøÖÈ†àÊôöÊñºÈñãÂßãÊôÇÈñì');
        return false;
    }
    
    clearFormErrors();
    return true;
}

function updateSchedulePreview() {
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const duration = parseInt(document.getElementById('appointmentDuration').value);
    
    if (!startTime || !endTime || !duration) {
        hideSchedulePreview();
        return;
    }
    
    if (!validateTimeRange()) {
        hideSchedulePreview();
        return;
    }
    
    const slots = generateTimeSlots(startTime, endTime, duration);
    renderSchedulePreview(slots);
}

function generateTimeSlots(startTime, endTime, duration) {
    const slots = [];
    const [startHour, startMin] = startTime.split(':').map(Number);
    const [endHour, endMin] = endTime.split(':').map(Number);
    
    let currentMinutes = startHour * 60 + startMin;
    const endMinutes = endHour * 60 + endMin;
    
    while (currentMinutes + duration <= endMinutes) {
        const slotStart = formatMinutesToTime(currentMinutes);
        const slotEnd = formatMinutesToTime(currentMinutes + duration);
        
        slots.push(`${slotStart}-${slotEnd}`);
        currentMinutes += duration;
    }
    
    return slots;
}

function formatMinutesToTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
}

function renderSchedulePreview(slots) {
    const preview = document.getElementById('schedulePreview');
    const slotsContainer = document.getElementById('previewSlots');
    
    slotsContainer.innerHTML = '';
    
    slots.forEach(slot => {
        const slotElement = document.createElement('div');
        slotElement.className = 'preview-slot';
        slotElement.textContent = slot;
        slotsContainer.appendChild(slotElement);
    });
    
    preview.style.display = 'block';
}

function hideSchedulePreview() {
    const preview = document.getElementById('schedulePreview');
    preview.style.display = 'none';
}

// ========== ÂÑ≤Â≠òÊéíÁè≠ ==========
function saveSchedule() {
    const form = document.getElementById('scheduleForm');
    const formData = new FormData(form);
    
    // È©óË≠âË°®ÂñÆ
    if (!validateScheduleForm()) {
        return;
    }
    
    // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
    showSaveLoading(true);
    
    // Ê∫ñÂÇô AJAX Ë≥áÊñô
    const data = {
        weekday: formData.get('weekday'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        appointment_duration: formData.get('appointment_duration'),
        max_appointments_per_slot: formData.get('max_appointments_per_slot'),
        notes: formData.get('notes') || ''
    };
    
    // Ê±∫ÂÆö URL ÂíåÊñπÊ≥ï
    const isEditing = !!editingScheduleId;
    const url = isEditing 
        ? pageData.urls.editSchedule.replace('{id}', editingScheduleId)
        : pageData.urls.addSchedule;
    
    console.log(`üíæ ${isEditing ? 'Êõ¥Êñ∞' : 'Êñ∞Â¢û'}ÊéíÁè≠:`, data);
    
    // ÁôºÈÄÅË´ãÊ±Ç
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': pageData.csrfToken,
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showSuccessMessage(result.message);
            closeScheduleModal();
            
            // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢ÊàñÊõ¥Êñ∞Ë≥áÊñô
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showErrorMessage(result.message || 'Êìç‰ΩúÂ§±Êïó');
            if (result.errors) {
                showFormErrors(result.errors);
            }
        }
    })
    .catch(error => {
        console.error('ÂÑ≤Â≠òÊéíÁè≠ÈåØË™§:', error);
        showErrorMessage('Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
    })
    .finally(() => {
        showSaveLoading(false);
    });
}

function validateScheduleForm() {
    const requiredFields = ['weekday', 'start_time', 'end_time', 'appointment_duration', 'max_appointments_per_slot'];
    
    for (const field of requiredFields) {
        const element = document.getElementById(field.replace('_', ''));
        if (!element || !element.value) {
            showFormError(`Ë´ãÂ°´ÂØ´${element?.labels?.[0]?.textContent || field}`);
            element?.focus();
            return false;
        }
    }
    
    return validateTimeRange();
}

function showSaveLoading(show) {
    const button = document.querySelector('#scheduleModal .btn-primary-modern');
    const buttonText = document.getElementById('saveButtonText');
    
    if (show) {
        button.disabled = true;
        buttonText.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>ÂÑ≤Â≠ò‰∏≠...';
    } else {
        button.disabled = false;
        buttonText.innerHTML = editingScheduleId ? 
            '<i class="bi bi-check me-2"></i>Êõ¥Êñ∞ÊéíÁè≠' : 
            '<i class="bi bi-check me-2"></i>ÂÑ≤Â≠òÊéíÁè≠';
    }
}

// ========== Âø´ÈÄüÊñ∞Â¢ûÊéíÁè≠ ==========
function quickAddSchedule(weekday, timeString) {
    const hour = parseInt(timeString.split(':')[0]);
    const startTime = `${hour.toString().padStart(2, '0')}:00`;
    const endTime = `${(hour + 1).toString().padStart(2, '0')}:00`;
    
    // ÈñãÂïüÊñ∞Â¢û Modal ‰∏¶È†êÂ°´Ë≥áÊñô
    showAddScheduleModal();
    
    // È†êÂ°´Ë≥áÊñô
    setTimeout(() => {
        document.getElementById('weekday').value = weekday;
        document.getElementById('startTime').value = startTime;
        document.getElementById('endTime').value = endTime;
        updateSchedulePreview();
    }, 100);
    
    console.log(`‚ö° Âø´ÈÄüÊñ∞Â¢ûÊéíÁè≠: ÊòüÊúü${weekday + 1} ${startTime}-${endTime}`);
}

// ========== Êìç‰ΩúÊåâÈàïÂäüËÉΩ ==========
function initializeActionButtons() {
    // ÂïüÁî®/ÂÅúÁî®ÊéíÁè≠ÊåâÈàï
    initializeToggleButtons();
    
    // ÂÖ∂‰ªñÊìç‰ΩúÊåâÈàï
    initializeOtherActionButtons();
}

function initializeToggleButtons() {
    const toggleButtons = document.querySelectorAll('.toggle-schedule-btn');
    
    toggleButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            handleToggleScheduleStatus(this);
        });
    });
}

function handleToggleScheduleStatus(button) {
    const scheduleId = button.dataset.scheduleId;
    const action = button.dataset.action;
    const isDeactivating = action === 'deactivate';
    
    // È°ØÁ§∫Á¢∫Ë™çÂ∞çË©±Ê°Ü
    showConfirmDialog({
        title: isDeactivating ? 'ÂÅúÁî®ÊéíÁè≠' : 'ÂïüÁî®ÊéíÁè≠',
        message: `Á¢∫ÂÆöË¶Å${isDeactivating ? 'ÂÅúÁî®' : 'ÂïüÁî®'}Ê≠§ÊéíÁè≠ÂóéÔºü`,
        confirmText: isDeactivating ? 'ÂÅúÁî®' : 'ÂïüÁî®',
        confirmClass: isDeactivating ? 'btn-warning' : 'btn-success',
        onConfirm: () => {
            executeToggleScheduleStatus(button, scheduleId);
        }
    });
}

function executeToggleScheduleStatus(button, scheduleId) {
    const card = button.closest('.schedule-card-modern');
    
    // È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
    showCardLoading(card);
    
    // ÁôºÈÄÅ AJAX Ë´ãÊ±Ç
    fetch(pageData.urls.toggleSchedule.replace('{id}', scheduleId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': pageData.csrfToken,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(data.message);
            
            // Êõ¥Êñ∞Êú¨Âú∞Ë≥áÊñô
            updateScheduleStatusInData(scheduleId, data.is_active);
            
            // ÈáçÊñ∞Ê∏≤Êüì
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showErrorMessage(data.message || 'Êìç‰ΩúÂ§±Êïó');
        }
    })
    .catch(error => {
        console.error('ÂàáÊèõÊéíÁè≠ÁãÄÊÖãÈåØË™§:', error);
        showErrorMessage('Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
    })
    .finally(() => {
        hideCardLoading(card);
    });
}

function updateScheduleStatusInData(scheduleId, newStatus) {
    const schedule = schedulesData.find(s => s.id === parseInt(scheduleId));
    if (schedule) {
        schedule.isActive = newStatus;
    }
    
    // ÈáçÊñ∞ÁØ©ÈÅ∏
    filterSchedules();
}

function initializeOtherActionButtons() {
    // Ë§áË£ΩÊéíÁè≠ÊåâÈàïÂ∑≤Âú® HTML ‰∏≠ÂÆöÁæ© onclick
    console.log('üîò ÂÖ∂‰ªñÊìç‰ΩúÊåâÈàïÂ∑≤ÂàùÂßãÂåñ');
}

// ========== Ë§áË£ΩÊéíÁè≠ÂäüËÉΩ ==========
function copySchedule(scheduleId) {
    const schedule = schedulesData.find(s => s.id === scheduleId);
    if (!schedule) return;
    
    // ÈñãÂïüÊñ∞Â¢û Modal ‰∏¶Ë§áË£ΩË≥áÊñô
    showAddScheduleModal();
    
    setTimeout(() => {
        document.getElementById('weekday').value = schedule.weekday;
        document.getElementById('startTime').value = schedule.startTime;
        document.getElementById('endTime').value = schedule.endTime;
        document.getElementById('appointmentDuration').value = schedule.appointmentDuration;
        document.getElementById('maxAppointments').value = schedule.maxAppointmentsPerSlot;
        document.getElementById('notes').value = schedule.notes || '';
        
        updateSchedulePreview();
    }, 100);
    
    console.log('üìã Ë§áË£ΩÊéíÁè≠:', schedule);
}

function executeCopyWeek() {
    const copySource = document.querySelector('input[name="copySource"]:checked')?.value;
    const overwrite = document.getElementById('overwriteExisting').checked;
    
    if (!copySource) {
        showErrorMessage('Ë´ãÈÅ∏ÊìáË§áË£Ω‰æÜÊ∫ê');
        return;
    }
    
    showConfirmDialog({
        title: 'Á¢∫Ë™çË§áË£ΩÊéíÁè≠',
        message: `Á¢∫ÂÆöË¶ÅË§áË£Ω${copySource === 'last_week' ? '‰∏äÈÄ±ÊéíÁè≠' : 'ÊéíÁè≠ÁØÑÊú¨'}ÂóéÔºü${overwrite ? 'Â∞áË¶ÜËìãÁèæÊúâÊéíÁè≠„ÄÇ' : ''}`,
        confirmText: 'ÈñãÂßãË§áË£Ω',
        onConfirm: () => {
            performCopyWeek(copySource, overwrite);
        }
    });
}

function performCopyWeek(source, overwrite) {
    closeCopyWeekModal();
    
    // ÁôºÈÄÅË§áË£ΩË´ãÊ±Ç
    fetch(pageData.urls.copyWeek, {
        method: 'POST',
        headers: {
            'X-CSRFToken': pageData.csrfToken,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            source: source,
            overwrite: overwrite
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(data.message);
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showErrorMessage(data.message || 'Ë§áË£ΩÂ§±Êïó');
        }
    })
    .catch(error => {
        console.error('Ë§áË£ΩÊéíÁè≠ÈåØË™§:', error);
        showErrorMessage('Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
    });
}

// ========== Âà™Èô§ÊéíÁè≠ ==========
function deleteSchedule(scheduleId) {
    const schedule = schedulesData.find(s => s.id === scheduleId);
    if (!schedule) return;
    
    showConfirmDialog({
        title: 'Âà™Èô§ÊéíÁè≠',
        message: `Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${schedule.weekdayDisplay} ${schedule.startTime}-${schedule.endTime}„ÄçÁöÑÊéíÁè≠ÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`,
        confirmText: 'Âà™Èô§',
        confirmClass: 'btn-danger',
        onConfirm: () => {
            executeDeleteSchedule(scheduleId);
        }
    });
}

function executeDeleteSchedule(scheduleId) {
    fetch(pageData.urls.deleteSchedule.replace('{id}', scheduleId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': pageData.csrfToken,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessMessage(data.message);
            
            // ÁßªÈô§Êú¨Âú∞Ë≥áÊñô
            schedulesData = schedulesData.filter(s => s.id !== parseInt(scheduleId));
            filterSchedules();
            
            // ÁßªÈô§ DOM ÂÖÉÁ¥†
            const card = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
            if (card) {
                card.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    card.remove();
                }, 300);
            }
        } else {
            showErrorMessage(data.message || 'Âà™Èô§Â§±Êïó');
        }
    })
    .catch(error => {
        console.error('Âà™Èô§ÊéíÁè≠ÈåØË™§:', error);
        showErrorMessage('Á∂≤Ë∑ØÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
    });
}

// ========== ÈçµÁõ§Âø´Êç∑Èçµ ==========
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + N: Êñ∞Â¢ûÊéíÁè≠
        if ((e.ctrlKey || e.metaKey) && e.key === 'n' && pageData.canEdit) {
            e.preventDefault();
            showAddScheduleModal();
        }
        
        // Ctrl/Cmd + 1/2: ÂàáÊèõÊ™¢Ë¶ñ
        if ((e.ctrlKey || e.metaKey) && e.key === '1') {
            e.preventDefault();
            switchView('calendar');
            document.querySelector('[data-view="calendar"]').click();
        }
        
        if ((e.ctrlKey || e.metaKey) && e.key === '2') {
            e.preventDefault();
            switchView('list');
            document.querySelector('[data-view="list"]').click();
        }
    });
}

// ========== Â∑•ÂÖ∑ÂáΩÊï∏ ==========

function loadSchedulesData() {
    // Ë≥áÊñôÂ∑≤Âú®È†ÅÈù¢ËºâÂÖ•ÊôÇÊ≥®ÂÖ•ÔºåÈÄôË£°ËôïÁêÜË≥áÊñôÂàùÂßãÂåñ
    filteredSchedules = [...schedulesData];
    console.log('üìä ËºâÂÖ•ÊéíÁè≠Ë≥áÊñô:', schedulesData);
}

function renderSchedules() {
    if (currentView === 'calendar') {
        renderCalendarView();
    } else {
        renderListView();
    }
}

function updateScheduleStats() {
    const statsElement = document.getElementById('scheduleStats');
    if (statsElement) {
        const total = schedulesData.length;
        const visible = filteredSchedules.length;
        
        let text = '';
        if (currentFilter !== 'all') {
            text = `È°ØÁ§∫ ${visible} / ${total} ÂÄãÊéíÁè≠`;
        } else {
            text = `ÂÖ± ${total} ÂÄãÊéíÁè≠`;
        }
        
        statsElement.textContent = text;
    }
}

function animateFilterChange(chip) {
    chip.style.transform = 'scale(1.1)';
    setTimeout(() => {
        chip.style.transform = 'scale(1)';
    }, 150);
}

// ========== ËºâÂÖ•ÂíåÈåØË™§ËôïÁêÜÔºàÁπºÊâøËá™ doctor-management.jsÔºâ ==========
function showCardLoading(card) {
    let overlay = card.querySelector('.loading-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.innerHTML = '<div class="loading-spinner-modern"></div>';
        card.appendChild(overlay);
    }
    overlay.classList.add('show');
}

function hideCardLoading(card) {
    const overlay = card.querySelector('.loading-overlay');
    if (overlay) {
        overlay.classList.remove('show');
    }
}

function showConfirmDialog(options) {
    const dialog = document.createElement('div');
    dialog.className = 'confirm-dialog-overlay';
    dialog.innerHTML = `
        <div class="confirm-dialog">
            <h3>${options.title}</h3>
            <p>${options.message}</p>
            <div class="dialog-buttons">
                <button class="btn-cancel">ÂèñÊ∂à</button>
                <button class="btn-confirm ${options.confirmClass || 'btn-primary'}">${options.confirmText}</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    
    dialog.querySelector('.btn-cancel').addEventListener('click', () => {
        document.body.removeChild(dialog);
    });
    
    dialog.querySelector('.btn-confirm').addEventListener('click', () => {
        options.onConfirm();
        document.body.removeChild(dialog);
    });
    
    dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
            document.body.removeChild(dialog);
        }
    });
}

function showSuccessMessage(message) {
    showMessage(message, 'success');
}

function showErrorMessage(message) {
    showMessage(message, 'error');
}

function showMessage(message, type) {
    const messageEl = document.createElement('div');
    messageEl.className = `message-toast message-${type}`;
    messageEl.innerHTML = `
        <div class="message-content">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
            <span>${message}</span>
        </div>
        <button class="message-close">&times;</button>
    `;
    
    document.body.appendChild(messageEl);
    
    setTimeout(() => {
        if (messageEl.parentNode) {
            messageEl.classList.add('fade-out');
            setTimeout(() => {
                if (messageEl.parentNode) {
                    document.body.removeChild(messageEl);
                }
            }, 300);
        }
    }, 5000);
    
    messageEl.querySelector('.message-close').addEventListener('click', () => {
        messageEl.classList.add('fade-out');
        setTimeout(() => {
            if (messageEl.parentNode) {
                document.body.removeChild(messageEl);
            }
        }, 300);
    });
}

function showFormError(message) {
    const errorEl = document.querySelector('.form-error') || document.createElement('div');
    errorEl.className = 'form-error';
    errorEl.textContent = message;
    errorEl.style.color = 'var(--danger-color)';
    errorEl.style.fontSize = '0.875rem';
    errorEl.style.marginTop = 'var(--spacing-sm)';
    
    if (!document.querySelector('.form-error')) {
        document.querySelector('.modal-body').appendChild(errorEl);
    }
}

function clearFormErrors() {
    const errorEl = document.querySelector('.form-error');
    if (errorEl) {
        errorEl.remove();
    }
}

function showFormErrors(errors) {
    Object.keys(errors).forEach(field => {
        const input = document.getElementById(field);
        if (input) {
            input.style.borderColor = 'var(--danger-color)';
            // ÂèØ‰ª•Ê∑ªÂä†Êõ¥Â§öÈåØË™§È°ØÁ§∫ÈÇèËºØ
        }
    });
}

// ========== CSS ÂãïÁï´Ê≥®ÂÖ•ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ ==========
const scheduleAnimationCSS = `
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.95); }
}

.fade-out {
    animation: fadeOut 0.3s ease-out forwards;
}

.confirm-dialog-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.5); display: flex;
    align-items: center; justify-content: center; z-index: 1000;
}

.confirm-dialog {
    background: white; padding: 2rem; border-radius: 1rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    max-width: 400px; width: 90%;
}

.dialog-buttons {
    display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;
}

.message-toast {
    position: fixed; top: 2rem; right: 2rem; background: white;
    padding: 1rem 1.5rem; border-radius: 0.75rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    border-left: 4px solid; z-index: 1000;
    display: flex; align-items: center; gap: 1rem; max-width: 400px;
}

.message-success { border-left-color: #10b981; }
.message-error { border-left-color: #ef4444; }

.message-content { display: flex; align-items: center; gap: 0.5rem; }
.message-close { background: none; border: none; font-size: 1.25rem; cursor: pointer; opacity: 0.5; }
.message-close:hover { opacity: 1; }
`;

// Ê≥®ÂÖ• CSS
if (!document.getElementById('schedule-animations')) {
    const style = document.createElement('style');
    style.id = 'schedule-animations';
    style.textContent = scheduleAnimationCSS;
    document.head.appendChild(style);
}

console.log('‚úÖ ÊéíÁè≠ÁÆ°ÁêÜ JavaScript ËºâÂÖ•ÂÆåÊàê');