{% extends 'base.html' %}
{% load static %}

{% block title %}é ç´„ç®¡ç† - {{ clinic.clinic_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clinic/appointment-management.css' %}">
{% endblock %}

{% block content %}
<div class="appointment-management-container">
  
  <!-- ç¾ä»£åŒ–é é¢æ¨™é¡Œ -->
  <div class="page-header-modern">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="page-title-modern">
          <i class="bi bi-calendar-check-fill me-3"></i>
          é ç´„ç®¡ç†ä¸­å¿ƒ
        </h1>
        <div class="page-subtitle-modern">
          <div class="clinic-info-header">
            <div class="clinic-avatar">
              <i class="bi bi-hospital-fill"></i>
            </div>
            <div class="clinic-details">
              <div class="clinic-name">
                <span>{{ clinic.clinic_name }}</span>
              </div>
              <div class="clinic-status">
                <i class="bi bi-shield-check me-2"></i>
                <span class="text-success">å·²é©—è­‰è¨ºæ‰€</span>
                <span class="mx-2">â€¢</span>
                <i class="bi bi-clock me-2"></i>
                <span>å³æ™‚é ç´„ç®¡ç†</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- é ç´„çµ±è¨ˆæ¦‚è¦½ -->
        <div class="appointment-stats">
          <div class="stat-item">
            <div class="stat-number">{{ appointments|length }}</div>
            <div class="stat-label">ç¸½é ç´„</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="confirmedCount">0</div>
            <div class="stat-label">å·²ç¢ºèª</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="pendingCount">0</div>
            <div class="stat-label">å¾…ç¢ºèª</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="todayCount">0</div>
            <div class="stat-label">ä»Šæ—¥é ç´„</div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="action-buttons-modern">
          <a href="{% url 'manage_schedules' %}" class="btn-modern btn-primary-modern">
            <i class="bi bi-calendar3"></i>
            <span>æ’ç­ç®¡ç†</span>
          </a>
          <button class="btn-modern btn-secondary-modern" onclick="refreshAppointments()">
            <i class="bi bi-arrow-clockwise"></i>
            <span>é‡æ–°æ•´ç†</span>
          </button>
          <a href="{% url 'clinic_dashboard' %}" class="btn-modern btn-outline-modern">
            <i class="bi bi-arrow-left"></i>
            <span>è¿”å›ä¸»æ§å°</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- æ™ºèƒ½ç¯©é¸å·¥å…·åˆ— -->
  <div class="filter-toolbar-modern">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <div class="filter-controls">
          <div class="filter-group">
            <label class="filter-label">æ—¥æœŸç¯„åœ</label>
            <div class="filter-chip-group">
              <button class="filter-chip {% if date_filter == 'today' %}active{% endif %}" data-filter="date" data-value="today">
                <i class="bi bi-calendar-day me-1"></i>ä»Šå¤©
              </button>
              <button class="filter-chip {% if date_filter == 'tomorrow' %}active{% endif %}" data-filter="date" data-value="tomorrow">
                <i class="bi bi-calendar-plus me-1"></i>æ˜å¤©
              </button>
              <button class="filter-chip {% if date_filter == 'week' %}active{% endif %}" data-filter="date" data-value="week">
                <i class="bi bi-calendar-week me-1"></i>æœ¬é€±
              </button>
              <button class="filter-chip {% if date_filter == 'all' %}active{% endif %}" data-filter="date" data-value="all">
                <i class="bi bi-calendar3 me-1"></i>å…¨éƒ¨
              </button>
            </div>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">é ç´„ç‹€æ…‹</label>
            <div class="filter-chip-group">
              <button class="filter-chip {% if status_filter == 'all' %}active{% endif %}" data-filter="status" data-value="all">
                <i class="bi bi-list-ul me-1"></i>å…¨éƒ¨
              </button>
              <button class="filter-chip {% if status_filter == 'pending' %}active{% endif %}" data-filter="status" data-value="pending">
                <i class="bi bi-clock me-1"></i>å¾…ç¢ºèª
              </button>
              <button class="filter-chip {% if status_filter == 'confirmed' %}active{% endif %}" data-filter="status" data-value="confirmed">
                <i class="bi bi-check-circle me-1"></i>å·²ç¢ºèª
              </button>
              <button class="filter-chip {% if status_filter == 'completed' %}active{% endif %}" data-filter="status" data-value="completed">
                <i class="bi bi-check2-circle me-1"></i>å·²å®Œæˆ
              </button>
            </div>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">ç¸é†«å¸«</label>
            <div class="doctor-filter-dropdown">
              <button class="dropdown-toggle" id="doctorFilterDropdown" data-bs-toggle="dropdown">
                <i class="bi bi-person-badge me-2"></i>
                <span id="selectedDoctorText">
                  {% if doctor_filter == 'all' %}å…¨éƒ¨é†«å¸«{% else %}
                    {% for doctor in doctors %}
                      {% if doctor.id|stringformat:"s" == doctor_filter %}
                        Dr. {{ doctor.user.first_name|default:doctor.user.username }}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                </span>
                <i class="bi bi-chevron-down ms-2"></i>
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item doctor-filter-item" data-doctor="all">
                  <i class="bi bi-people me-2"></i>å…¨éƒ¨é†«å¸«
                </a></li>
                <li><hr class="dropdown-divider"></li>
                {% for doctor in doctors %}
                <li><a class="dropdown-item doctor-filter-item" data-doctor="{{ doctor.id }}">
                  <div class="doctor-avatar-mini">
                    {{ doctor.user.first_name|first|default:doctor.user.username|first }}
                  </div>
                  <span>Dr. {{ doctor.user.first_name|default:doctor.user.username }}</span>
                  {% if doctor.specialization %}
                    <small class="text-muted ms-auto">{{ doctor.specialization }}</small>
                  {% endif %}
                </a></li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="search-and-actions">
          <div class="search-box">
            <input type="text" id="quickSearch" class="form-control" placeholder="æœå°‹å¯µç‰©åç¨±æˆ–é£¼ä¸»...">
            <button class="search-btn">
              <i class="bi bi-search"></i>
            </button>
          </div>
          <div class="view-toggle-modern">
            <button class="view-btn active" data-view="cards">
              <i class="bi bi-grid"></i>
            </button>
            <button class="view-btn" data-view="list">
              <i class="bi bi-list"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é ç´„åˆ—è¡¨å®¹å™¨ -->
  <div class="appointments-container">
    
    <!-- å¡ç‰‡æª¢è¦– -->
    <div id="cardsView" class="appointments-view active">
      <div class="appointments-grid" id="appointmentsGrid">
        {% for appointment in appointments %}
        <div class="appointment-card-modern" 
             data-appointment-id="{{ appointment.id }}"
             data-status="{{ appointment.status }}"
             data-doctor="{{ appointment.slot.doctor.id }}"
             data-date="{{ appointment.slot.date|date:'Y-m-d' }}"
             data-search-terms="{{ appointment.pet.name|lower }} {{ appointment.owner.first_name|default:appointment.owner.username|lower }}">
          
          <!-- å¡ç‰‡æ¨™é¡Œåˆ— -->
          <div class="card-header-modern">
            <div class="pet-info">
              <div class="pet-avatar-modern">
                {% if appointment.pet.picture %}
                  <img src="{{ appointment.pet.picture.url }}" alt="{{ appointment.pet.name }}">
                {% else %}
                  <span>{{ appointment.pet.name|first }}</span>
                {% endif %}
              </div>
              <div class="pet-details">
                <h3 class="pet-name">{{ appointment.pet.name }}</h3>
                <div class="owner-info">
                  <i class="bi bi-person me-1"></i>
                  {{ appointment.owner.first_name|default:appointment.owner.username }}
                </div>
              </div>
            </div>
            
            <div class="appointment-status">
              <span class="status-badge-modern status-{{ appointment.status }}">
                {% if appointment.status == 'confirmed' %}
                  <i class="bi bi-check-circle"></i>å·²ç¢ºèª
                {% elif appointment.status == 'pending' %}
                  <i class="bi bi-clock"></i>å¾…ç¢ºèª
                {% elif appointment.status == 'cancelled' %}
                  <i class="bi bi-x-circle"></i>å·²å–æ¶ˆ
                {% elif appointment.status == 'completed' %}
                  <i class="bi bi-check2-circle"></i>å·²å®Œæˆ
                {% endif %}
              </span>
            </div>
          </div>
          
          <!-- é ç´„æ™‚é–“è³‡è¨Š -->
          <div class="appointment-time-info">
            <div class="time-block">
              <div class="date-display">
                <i class="bi bi-calendar3 me-2"></i>
                <span class="date-text">{{ appointment.slot.date|date:"næœˆjæ—¥" }}</span>
                <span class="weekday-text">{{ appointment.slot.date|date:"l" }}</span>
              </div>
              <div class="time-display">
                <i class="bi bi-clock me-2"></i>
                <span class="time-range">
                  {{ appointment.slot.start_time|time:"H:i" }} - {{ appointment.slot.end_time|time:"H:i" }}
                </span>
              </div>
            </div>
            
            <div class="doctor-info">
              <i class="bi bi-person-badge me-2"></i>
              <span>Dr. {{ appointment.slot.doctor.user.first_name|default:appointment.slot.doctor.user.username }}</span>
              {% if appointment.slot.doctor.specialization %}
                <small class="specialty">{{ appointment.slot.doctor.specialization }}</small>
              {% endif %}
            </div>
          </div>
          
          <!-- é ç´„è©³æƒ… -->
          <div class="appointment-details">
            {% if appointment.reason %}
            <div class="detail-item">
              <i class="bi bi-note-text me-2"></i>
              <strong>é ç´„åŸå› ï¼š</strong>
              <span>{{ appointment.reason|truncatechars:80 }}</span>
            </div>
            {% endif %}
            
            {% if appointment.notes %}
            <div class="detail-item">
              <i class="bi bi-chat-dots me-2"></i>
              <strong>å‚™è¨»ï¼š</strong>
              <span>{{ appointment.notes|truncatechars:80 }}</span>
            </div>
            {% endif %}
            
            <div class="contact-info">
              <i class="bi bi-telephone me-2"></i>
              <span>{{ appointment.contact_phone|default:"æœªæä¾›è¯çµ¡é›»è©±" }}</span>
            </div>
          </div>
          
          <!-- æ“ä½œæŒ‰éˆ•å€åŸŸ -->
          <div class="card-actions">
            <button class="action-btn btn-info" onclick="viewAppointmentDetail({{ appointment.id }})">
              <i class="bi bi-eye"></i>
              <span>æŸ¥çœ‹è©³æƒ…</span>
            </button>
            
            {% if appointment.status == 'pending' %}
            <button class="action-btn btn-success" onclick="confirmAppointment({{ appointment.id }})">
              <i class="bi bi-check"></i>
              <span>ç¢ºèªé ç´„</span>
            </button>
            {% endif %}
            
            {% if appointment.status in 'pending,confirmed' %}
            <button class="action-btn btn-warning" onclick="showCancelModal({{ appointment.id }})">
              <i class="bi bi-x"></i>
              <span>å–æ¶ˆé ç´„</span>
            </button>
            {% endif %}
            
            {% if appointment.status == 'confirmed' %}
            <button class="action-btn btn-secondary" onclick="markCompleted({{ appointment.id }})">
              <i class="bi bi-check2"></i>
              <span>æ¨™è¨˜å®Œæˆ</span>
            </button>
            {% endif %}
          </div>
          
          <!-- æ™‚é–“æˆ³è¨˜ -->
          <div class="card-footer-modern">
            <small class="timestamp">
              <i class="bi bi-clock-history me-1"></i>
              å»ºç«‹æ–¼ {{ appointment.created_at|date:"m/d H:i" }}
              {% if appointment.updated_at != appointment.created_at %}
                | æ›´æ–°æ–¼ {{ appointment.updated_at|date:"m/d H:i" }}
              {% endif %}
            </small>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- åˆ—è¡¨æª¢è¦– -->
    <div id="listView" class="appointments-view">
      <div class="appointments-table-container">
        <table class="appointments-table">
          <thead>
            <tr>
              <th>å¯µç‰© & é£¼ä¸»</th>
              <th>é ç´„æ™‚é–“</th>
              <th>é†«å¸«</th>
              <th>ç‹€æ…‹</th>
              <th>é ç´„åŸå› </th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="appointmentsTableBody">
            {% for appointment in appointments %}
            <tr class="appointment-row" data-appointment-id="{{ appointment.id }}">
              <td>
                <div class="pet-owner-cell">
                  <div class="pet-avatar-small">{{ appointment.pet.name|first }}</div>
                  <div>
                    <div class="pet-name">{{ appointment.pet.name }}</div>
                    <div class="owner-name">{{ appointment.owner.first_name|default:appointment.owner.username }}</div>
                  </div>
                </div>
              </td>
              <td>
                <div class="datetime-cell">
                  <div class="date">{{ appointment.slot.date|date:"m/d" }}</div>
                  <div class="time">{{ appointment.slot.start_time|time:"H:i" }}</div>
                </div>
              </td>
              <td>
                <div class="doctor-cell">
                  Dr. {{ appointment.slot.doctor.user.first_name|default:appointment.slot.doctor.user.username }}
                </div>
              </td>
              <td>
                <span class="status-badge-modern status-{{ appointment.status }}">
                  {% if appointment.status == 'confirmed' %}å·²ç¢ºèª
                  {% elif appointment.status == 'pending' %}å¾…ç¢ºèª
                  {% elif appointment.status == 'cancelled' %}å·²å–æ¶ˆ
                  {% elif appointment.status == 'completed' %}å·²å®Œæˆ
                  {% endif %}
                </span>
              </td>
              <td>
                <span class="reason-text">{{ appointment.reason|default:"æœªå¡«å¯«"|truncatechars:30 }}</span>
              </td>
              <td>
                <div class="table-actions">
                  <button class="table-action-btn" onclick="viewAppointmentDetail({{ appointment.id }})">
                    <i class="bi bi-eye"></i>
                  </button>
                  {% if appointment.status == 'pending' %}
                  <button class="table-action-btn btn-success" onclick="confirmAppointment({{ appointment.id }})">
                    <i class="bi bi-check"></i>
                  </button>
                  {% endif %}
                  {% if appointment.status in 'pending,confirmed' %}
                  <button class="table-action-btn btn-warning" onclick="showCancelModal({{ appointment.id }})">
                    <i class="bi bi-x"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- ç©ºç‹€æ…‹ -->
    {% if not appointments %}
    <div class="empty-state-modern">
      <div class="empty-icon">
        <i class="bi bi-calendar-x"></i>
      </div>
      <h3 class="empty-title">ç›®å‰æ²’æœ‰é ç´„è¨˜éŒ„</h3>
      <p class="empty-description">
        {% if date_filter != 'all' %}
          åœ¨é¸å®šçš„æ™‚é–“ç¯„åœå…§æš«ç„¡é ç´„è¨˜éŒ„
        {% else %}
          è¨ºæ‰€å°šæœªæ”¶åˆ°ä»»ä½•é ç´„ï¼Œå¯ä»¥é–‹å§‹è¨­å®šæ’ç­ä¾†æ¥å—é ç´„
        {% endif %}
      </p>
      <a href="{% url 'manage_schedules' %}" class="btn-modern btn-primary-modern">
        <i class="bi bi-calendar3 me-2"></i>
        è¨­å®šæ’ç­æ™‚é–“
      </a>
    </div>
    {% endif %}
  </div>

  <!-- é ç´„è©³æƒ… Modal -->
  <div id="appointmentDetailModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3>é ç´„è©³æƒ…</h3>
        <button class="modal-close" onclick="closeAppointmentDetailModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <div class="modal-body" id="appointmentDetailContent">
        <!-- å‹•æ…‹è¼‰å…¥é ç´„è©³æƒ… -->
      </div>
    </div>
  </div>

  <!-- å–æ¶ˆé ç´„ Modal -->
  <div id="cancelAppointmentModal" class="modal-overlay">
    <div class="modal-container modal-sm">
      <div class="modal-header">
        <h3>å–æ¶ˆé ç´„</h3>
        <button class="modal-close" onclick="closeCancelModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <form id="cancelAppointmentForm">
        {% csrf_token %}
        <input type="hidden" id="cancelAppointmentId">
        <div class="modal-body">
          <div class="cancel-appointment-info">
            <p>ç¢ºå®šè¦å–æ¶ˆä»¥ä¸‹é ç´„å—ï¼Ÿ</p>
            <div class="appointment-summary" id="cancelAppointmentSummary">
              <!-- å‹•æ…‹è¼‰å…¥é ç´„æ‘˜è¦ -->
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">å–æ¶ˆåŸå›  <span class="required">*</span></label>
            <textarea id="cancelReason" name="cancel_reason" class="form-control" rows="3" 
                      placeholder="è«‹èªªæ˜å–æ¶ˆåŸå› ï¼Œæ­¤è¨Šæ¯å°‡ç™¼é€çµ¦é£¼ä¸»" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern btn-outline-modern" onclick="closeCancelModal()">
            <i class="bi bi-x me-2"></i>å–æ¶ˆ
          </button>
          <button type="submit" class="btn-modern btn-danger-modern">
            <i class="bi bi-trash me-2"></i>ç¢ºèªå–æ¶ˆé ç´„
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ“ä½œæŒ‡å— -->
  <div class="help-section-modern">
    <h6 class="help-title">
      <i class="bi bi-lightbulb me-2"></i>
      é ç´„ç®¡ç†æ“ä½œæŒ‡å—
    </h6>
    
    <div class="row">
      <div class="col-md-4">
        <h6 class="text-muted mb-3">ğŸ“‹ é ç´„ç‹€æ…‹èªªæ˜</h6>
        <ul class="help-list">
          <li class="help-item">
            <span class="status-badge-modern status-pending me-2">å¾…ç¢ºèª</span>
            æ–°é ç´„ï¼Œéœ€è¦è¨ºæ‰€ç¢ºèª
          </li>
          <li class="help-item">
            <span class="status-badge-modern status-confirmed me-2">å·²ç¢ºèª</span>
            è¨ºæ‰€å·²ç¢ºèªçš„é ç´„
          </li>
          <li class="help-item">
            <span class="status-badge-modern status-completed me-2">å·²å®Œæˆ</span>
            å·²å®Œæˆçœ‹è¨ºçš„é ç´„
          </li>
        </ul>
      </div>
      
      <div class="col-md-4">
        <h6 class="text-muted mb-3">ğŸ”§ å¿«é€Ÿæ“ä½œ</h6>
        <ul class="help-list">
          <li class="help-item">
            <strong>æ‰¹é‡ç¢ºèªï¼š</strong>æŒ‰ä½ Ctrl éµå¤šé¸é ç´„é€²è¡Œæ‰¹é‡æ“ä½œ
          </li>
          <li class="help-item">
            <strong>å¿«é€Ÿæœå°‹ï¼š</strong>ä½¿ç”¨æœå°‹æ¡†å¿«é€Ÿæ‰¾åˆ°ç‰¹å®šé ç´„
          </li>
          <li class="help-item">
            <strong>æ™ºèƒ½ç¯©é¸ï¼š</strong>ä½¿ç”¨ç¯©é¸æ¢ä»¶å¿«é€Ÿåˆ†é¡æŸ¥çœ‹é ç´„
          </li>
        </ul>
      </div>
      
      <div class="col-md-4">
        <h6 class="text-muted mb-3">âš¡ éµç›¤å¿«æ·éµ</h6>
        <ul class="help-list">
          <li class="help-item">
            <kbd>Ctrl</kbd> + <kbd>R</kbd> : é‡æ–°æ•´ç†é ç´„åˆ—è¡¨
          </li>
          <li class="help-item">
            <kbd>Ctrl</kbd> + <kbd>F</kbd> : èšç„¦æœå°‹æ¡†
          </li>
          <li class="help-item">
            <kbd>Ctrl</kbd> + <kbd>1/2</kbd> : åˆ‡æ›æª¢è¦–æ¨¡å¼
          </li>
        </ul>
      </div>
    </div>
  </div>

</div>

<!-- éš±è—è¡¨å–®ç”¨æ–¼AJAX -->
<form id="ajaxForm" style="display: none;">
  {% csrf_token %}
</form>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/clinic/appointment-management.js' %}"></script>

<script>
// å‚³é Django æ•¸æ“šåˆ° JavaScript
document.addEventListener('DOMContentLoaded', function() {
  window.appointmentPageData = {
    clinic: {
      id: {{ clinic.id }},
      name: '{{ clinic.clinic_name|escapejs }}'
    },
    appointments: [
      {% for appointment in appointments %}
      {
        id: {{ appointment.id }},
        petName: '{{ appointment.pet.name|escapejs }}',
        ownerName: '{{ appointment.owner.first_name|default:appointment.owner.username|escapejs }}',
        doctorId: {{ appointment.slot.doctor.id }},
        doctorName: '{{ appointment.slot.doctor.user.first_name|default:appointment.slot.doctor.user.username|escapejs }}',
        date: '{{ appointment.slot.date|date:"Y-m-d" }}',
        startTime: '{{ appointment.slot.start_time|time:"H:i" }}',
        endTime: '{{ appointment.slot.end_time|time:"H:i" }}',
        status: '{{ appointment.status }}',
        reason: '{{ appointment.reason|default:""|escapejs }}',
        notes: '{{ appointment.notes|default:""|escapejs }}',
        contactPhone: '{{ appointment.contact_phone|default:""|escapejs }}',
        createdAt: '{{ appointment.created_at|date:"Y-m-d H:i" }}'
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ],
    currentFilters: {
      date: '{{ date_filter|escapejs }}',
      status: '{{ status_filter|escapejs }}',
      doctor: '{{ doctor_filter|escapejs }}'
    },
    csrfToken: '{{ csrf_token }}',
    urls: {
      appointmentDetail: '/clinic/appointments/{id}/',
      confirmAppointment: '/clinic/appointments/{id}/confirm/',
      cancelAppointment: '/clinic/appointments/{id}/cancel/',
      completeAppointment: '/clinic/appointments/{id}/complete/'
    }
  };
  
  // åˆå§‹åŒ–é ç´„ç®¡ç†ç³»çµ±
  initializeAppointmentManagement();
});
</script>
{% endblock %}