{% extends 'base.html' %}
{% load static %}

{% block title %}æ’ç­ç®¡ç† - {{ doctor.user.get_full_name|default:doctor.user.username }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clinic/schedule-management.css' %}">
{% endblock %}

{% block content %}
<div class="schedule-management-container">
  
  <!-- ç¾ä»£åŒ–é é¢æ¨™é¡Œ -->
  <div class="page-header-modern">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="page-title-modern">
          <i class="bi bi-calendar3 me-3"></i>
          æ’ç­ç®¡ç†ä¸­å¿ƒ
        </h1>
        <div class="page-subtitle-modern">
          <div class="doctor-info-header">
            <div class="doctor-avatar-small">
              {% if doctor.user.first_name %}
                {{ doctor.user.first_name|first }}
              {% else %}
                {{ doctor.user.username|first|upper }}
              {% endif %}
            </div>
            <div class="doctor-details">
              <div class="doctor-name">
                <i class="bi bi-person-fill me-2"></i>
                <span>{{ doctor.user.get_full_name|default:doctor.user.username }}</span>
                {% if doctor.is_clinic_admin %}
                  <span class="admin-badge">
                    <i class="bi bi-crown"></i>
                    ç®¡ç†å“¡
                  </span>
                {% endif %}
              </div>
              <div class="clinic-info">
                <i class="bi bi-hospital me-2"></i>
                <span>{{ doctor.clinic.clinic_name }}</span>
                <span class="mx-2">â€¢</span>
                <i class="bi bi-shield-check me-2"></i>
                <span class="{% if doctor.is_verified %}text-success{% else %}text-warning{% endif %}">
                  {% if doctor.is_verified %}åŸ·ç…§å·²é©—è­‰{% else %}å¾…é©—è­‰{% endif %}
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- æ’ç­çµ±è¨ˆ -->
        <div class="schedule-stats">
          <div class="stat-item">
            <div class="stat-number">{{ stats.total_schedules }}</div>
            <div class="stat-label">å€‹æ’ç­</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ stats.active_schedules }}</div>
            <div class="stat-label">å•Ÿç”¨ä¸­</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ stats.weekly_hours|floatformat:1 }}</div>
            <div class="stat-label">é€±ç¸½æ™‚æ•¸</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ stats.avg_duration|floatformat:0 }}</div>
            <div class="stat-label">åˆ†é˜/æ™‚æ®µ</div>
          </div>
        </div>  

        <!-- æ’ç­å¡ç‰‡ä¸­ä½¿ç”¨ -->
        <div class="schedule-time">
          <i class="bi bi-clock me-2"></i>
          {{ schedule.time_display }}
        </div>
        <div class="schedule-duration">
          æ™‚é•·ï¼š{{ schedule.duration_hours }} å°æ™‚ ({{ schedule.period_display }})
        </div>

        <!-- è©³ç´°è³‡è¨Š -->
        <div class="detail-item">
          <div class="detail-label">æ™‚æ®µç¸½æ•¸</div>
          <div class="detail-value">{{ schedule.total_slots }} å€‹</div>
        </div>

      <div class="col-lg-4">
        <div class="action-buttons-modern">
          {% if can_edit %}
          <button class="btn-modern btn-primary-modern" onclick="showAddScheduleModal()">
            <i class="bi bi-plus-circle"></i>
            <span>æ–°å¢æ’ç­</span>
          </button>
          <button class="btn-modern btn-secondary-modern" onclick="showCopyWeekModal()">
            <i class="bi bi-arrow-repeat"></i>
            <span>è¤‡è£½æ’ç­</span>
          </button>
          {% endif %}
          <a href="{% url 'manage_doctors' %}" class="btn-modern btn-outline-modern">
            <i class="bi bi-arrow-left"></i>
            <span>è¿”å›é†«å¸«</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- æ“ä½œå·¥å…·åˆ— -->
  <div class="toolbar-section">
    <div class="row align-items-center">
      <div class="col-lg-6">
        <div class="view-controls">
          <div class="view-toggle-group">
            <button class="view-toggle active" data-view="calendar">
              <i class="bi bi-calendar3"></i>
              <span>é€±è¡Œäº‹æ›†</span>
            </button>
            <button class="view-toggle" data-view="list">
              <i class="bi bi-list-ul"></i>
              <span>åˆ—è¡¨æ¨¡å¼</span>
            </button>
          </div>
        </div>
      </div>
      
      <div class="col-lg-6">
        <div class="d-flex justify-content-between align-items-center">
          <div class="filter-chips">
            <div class="filter-chip active" data-filter="all">
              <i class="bi bi-calendar-week me-1"></i>
              å…¨éƒ¨æ’ç­
            </div>
            <div class="filter-chip" data-filter="active">
              <i class="bi bi-check-circle me-1"></i>
              å•Ÿç”¨ä¸­
            </div>
            <div class="filter-chip" data-filter="morning">
              <i class="bi bi-sunrise me-1"></i>
              ä¸Šåˆæ™‚æ®µ
            </div>
            <div class="filter-chip" data-filter="evening">
              <i class="bi bi-sunset me-1"></i>
              ä¸‹åˆæ™‚æ®µ
            </div>
          </div>
          
          <div class="text-muted small" id="scheduleStats">
            å…± {{ schedules.count }} å€‹æ’ç­
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é€±è¡Œäº‹æ›†æª¢è¦– -->
  <div id="calendarView" class="schedule-view active">
    <div class="weekly-calendar">
      <div class="calendar-header">
        <div class="time-column-header">æ™‚é–“</div>
        {% for day_num, day_name in weekdays %}
        <div class="day-header" data-weekday="{{ day_num }}">
          <div class="day-name">{{ day_name }}</div>
          <div class="day-count" id="dayCount{{ day_num }}">0 å€‹æ’ç­</div>
        </div>
        {% endfor %}
      </div>
      
      <div class="calendar-body">
        <!-- æ™‚é–“è»¸ -->
        <div class="time-column">
          {% for hour in time_slots %}
          <div class="time-slot">{{ hour }}</div>
          {% endfor %}
        </div>
        
        <!-- é€±æ’ç­æ ¼å­ -->
        {% for day_num, day_name in weekdays %}
        <div class="day-column" data-weekday="{{ day_num }}">
          {% for hour in time_slots %}
          <div class="time-cell" data-time="{{ hour }}" data-weekday="{{ day_num }}">
            <div class="schedule-slot-placeholder">
              {% if can_edit %}
              <button class="add-schedule-btn" onclick="quickAddSchedule({{ day_num }}, '{{ hour }}')" title="å¿«é€Ÿæ–°å¢æ’ç­">
                <i class="bi bi-plus"></i>
              </button>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- åˆ—è¡¨æª¢è¦– -->
  <div id="listView" class="schedule-view">
    <div class="schedules-list">
      {% for schedule in schedules %}
      <div class="schedule-card-modern" data-schedule-id="{{ schedule.id }}">
        
        <!-- æ’ç­æ¨™é¡Œåˆ— -->
        <div class="schedule-header">
          <div class="schedule-day-badge">
            {{ schedule.get_weekday_display }}
          </div>
          
          <div class="schedule-time-info">
            <div class="schedule-time">
              <i class="bi bi-clock me-2"></i>
              {{ schedule.start_time|time:"H:i" }} - {{ schedule.end_time|time:"H:i" }}
            </div>
            <div class="schedule-duration">
              ç¸½æ™‚é•·ï¼š
              {% widthratio schedule.end_time|time:"H" schedule.start_time|time:"H" 1 %}
              å°æ™‚
            </div>
          </div>
          
          <div class="schedule-status">
            {% if schedule.is_active %}
              <span class="status-badge-modern status-active-modern">
                <i class="bi bi-check-circle"></i>
                <span>å•Ÿç”¨ä¸­</span>
              </span>
            {% else %}
              <span class="status-badge-modern status-inactive-modern">
                <i class="bi bi-pause-circle"></i>
                <span>å·²åœç”¨</span>
              </span>
            {% endif %}
          </div>
        </div>
        
        <!-- æ’ç­è©³ç´°è³‡è¨Š -->
        <div class="schedule-details">
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">é ç´„æ™‚é•·</div>
              <div class="detail-value">{{ schedule.appointment_duration }} åˆ†é˜</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">æ¯æ™‚æ®µæœ€å¤§é ç´„</div>
              <div class="detail-value">{{ schedule.max_appointments_per_slot }} äºº</div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">æ™‚æ®µç¸½æ•¸</div>
              <div class="detail-value">
                {% widthratio schedule.end_time|time:"H" schedule.start_time|time:"H" 1 %}å€‹
              </div>
            </div>
            
            <div class="detail-item">
              <div class="detail-label">å»ºç«‹æ™‚é–“</div>
              <div class="detail-value">{{ schedule.created_at|date:"m/d H:i" }}</div>
            </div>
          </div>
          
          {% if schedule.notes %}
          <div class="schedule-notes">
            <div class="notes-label">
              <i class="bi bi-sticky me-1"></i>
              å‚™è¨»
            </div>
            <div class="notes-content">{{ schedule.notes }}</div>
          </div>
          {% endif %}
        </div>
        
        <!-- æ“ä½œæŒ‰éˆ•çµ„ -->
        {% if can_edit %}
        <div class="action-buttons-group">
          <button 
            class="action-btn btn-edit"
            onclick="editSchedule({{ schedule.id }})"
            title="ç·¨è¼¯æ’ç­"
          >
            <i class="bi bi-pencil"></i>
          </button>
          
          <button 
            class="action-btn btn-copy"
            onclick="copySchedule({{ schedule.id }})"
            title="è¤‡è£½æ’ç­"
          >
            <i class="bi bi-files"></i>
          </button>
          
          {% if schedule.is_active %}
            <button 
              class="action-btn btn-toggle-active toggle-schedule-btn"
              data-schedule-id="{{ schedule.id }}"
              data-action="deactivate"
              title="åœç”¨æ’ç­"
            >
              <i class="bi bi-pause"></i>
              <div class="loading-spinner-modern"></div>
            </button>
          {% else %}
            <button 
              class="action-btn btn-toggle-inactive toggle-schedule-btn"
              data-schedule-id="{{ schedule.id }}"
              data-action="activate"
              title="å•Ÿç”¨æ’ç­"
            >
              <i class="bi bi-play"></i>
              <div class="loading-spinner-modern"></div>
            </button>
          {% endif %}
          
          <button 
            class="action-btn btn-delete"
            onclick="deleteSchedule({{ schedule.id }})"
            title="åˆªé™¤æ’ç­"
          >
            <i class="bi bi-trash"></i>
          </button>
        </div>
        {% endif %}
        
      </div>
      {% empty %}
      
      <!-- ç©ºç‹€æ…‹ -->
      <div class="empty-state-modern">
        <div class="empty-icon">
          <i class="bi bi-calendar-x"></i>
        </div>
        <h3 class="empty-title">å°šæœªè¨­å®šä»»ä½•æ’ç­</h3>
        <p class="empty-description">
          é–‹å§‹è¨­å®šæ‚¨çš„çœ‹è¨ºæ™‚é–“å§ï¼<br>
          è¨­å®šæ’ç­å¾Œï¼Œç—…æ‚£å°±èƒ½åœ¨ç·šä¸Šé ç´„æ‚¨çš„çœ‹è¨ºæ™‚æ®µã€‚
        </p>
        {% if can_edit %}
        <button class="btn-modern btn-primary-modern" onclick="showAddScheduleModal()">
          <i class="bi bi-plus-circle"></i>
          <span>æ–°å¢ç¬¬ä¸€å€‹æ’ç­</span>
        </button>
        {% endif %}
      </div>
      
      {% endfor %}
    </div>
  </div>

  <!-- æ–°å¢/ç·¨è¼¯æ’ç­ Modal -->
  <div id="scheduleModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h3 id="modalTitle">æ–°å¢æ’ç­</h3>
        <button class="modal-close" onclick="closeScheduleModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      
      <form id="scheduleForm" class="modal-body">
        {% csrf_token %}
        <input type="hidden" id="scheduleId" name="schedule_id">
        
        <div class="form-row">
          <div class="form-group">
            <label for="weekday">æ˜ŸæœŸ <span class="required">*</span></label>
            <select id="weekday" name="weekday" class="form-control" required>
              <option value="">è«‹é¸æ“‡æ˜ŸæœŸ</option>
              <option value="0">æ˜ŸæœŸä¸€</option>
              <option value="1">æ˜ŸæœŸäºŒ</option>
              <option value="2">æ˜ŸæœŸä¸‰</option>
              <option value="3">æ˜ŸæœŸå››</option>
              <option value="4">æ˜ŸæœŸäº”</option>
              <option value="5">æ˜ŸæœŸå…­</option>
              <option value="6">æ˜ŸæœŸæ—¥</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="startTime">é–‹å§‹æ™‚é–“ <span class="required">*</span></label>
            <input type="time" id="startTime" name="start_time" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label for="endTime">çµæŸæ™‚é–“ <span class="required">*</span></label>
            <input type="time" id="endTime" name="end_time" class="form-control" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="appointmentDuration">é ç´„æ™‚é•· <span class="required">*</span></label>
            <select id="appointmentDuration" name="appointment_duration" class="form-control" required>
              <option value="15">15 åˆ†é˜</option>
              <option value="20">20 åˆ†é˜</option>
              <option value="30" selected>30 åˆ†é˜</option>
              <option value="45">45 åˆ†é˜</option>
              <option value="60">60 åˆ†é˜</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="maxAppointments">æ¯æ™‚æ®µæœ€å¤§é ç´„æ•¸ <span class="required">*</span></label>
            <select id="maxAppointments" name="max_appointments_per_slot" class="form-control" required>
              <option value="1" selected>1 äºº</option>
              <option value="2">2 äºº</option>
              <option value="3">3 äºº</option>
              <option value="4">4 äºº</option>
              <option value="5">5 äºº</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="notes">å‚™è¨»</label>
          <textarea id="notes" name="notes" class="form-control" rows="3" 
            placeholder="ä¾‹å¦‚ï¼šç‰¹æ®Šé–€è¨ºã€åƒ…é™æ€¥è¨ºç­‰..."></textarea>
        </div>
        
        <!-- é è¨ˆç”Ÿæˆçš„æ™‚æ®µé è¦½ -->
        <div class="schedule-preview" id="schedulePreview" style="display: none;">
          <h6>é è¨ˆç”Ÿæˆæ™‚æ®µé è¦½ï¼š</h6>
          <div class="preview-slots" id="previewSlots"></div>
        </div>
      </form>
      
      <div class="modal-footer">
        <button type="button" class="btn-modern btn-outline-modern" onclick="closeScheduleModal()">
          å–æ¶ˆ
        </button>
        <button type="button" class="btn-modern btn-primary-modern" onclick="saveSchedule()">
          <i class="bi bi-check"></i>
          <span id="saveButtonText">å„²å­˜æ’ç­</span>
        </button>
      </div>
    </div>
  </div>

  <!-- è¤‡è£½æ’ç­ Modal -->
  <div id="copyWeekModal" class="modal-overlay" style="display: none;">
    <div class="modal-container modal-sm">
      <div class="modal-header">
        <h3>è¤‡è£½æ’ç­</h3>
        <button class="modal-close" onclick="closeCopyWeekModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <p>é¸æ“‡è¦è¤‡è£½çš„æ’ç­ä¾†æºï¼š</p>
        
        <div class="copy-options">
          <label class="copy-option">
            <input type="radio" name="copySource" value="last_week" checked>
            <div class="option-content">
              <i class="bi bi-arrow-left-circle"></i>
              <span>ä¸Šé€±æ’ç­</span>
            </div>
          </label>
          
          <label class="copy-option">
            <input type="radio" name="copySource" value="template">
            <div class="option-content">
              <i class="bi bi-bookmark"></i>
              <span>æ’ç­ç¯„æœ¬</span>
            </div>
          </label>
        </div>
        
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="overwriteExisting">
          <label class="form-check-label" for="overwriteExisting">
            è¦†è“‹ç¾æœ‰æ’ç­
          </label>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-modern btn-outline-modern" onclick="closeCopyWeekModal()">
          å–æ¶ˆ
        </button>
        <button type="button" class="btn-modern btn-primary-modern" onclick="executeCopyWeek()">
          <i class="bi bi-copy"></i>
          é–‹å§‹è¤‡è£½
        </button>
      </div>
    </div>
  </div>

  <!-- æ“ä½œèªªæ˜ -->
  <div class="help-section-modern">
    <h6 class="help-title">
      <i class="bi bi-lightbulb"></i>
      æ’ç­è¨­å®šèªªæ˜èˆ‡æ“ä½œæŒ‡å—
    </h6>
    
    <div class="row">
      <div class="col-md-6">
        <h6 class="text-muted mb-3">ğŸ“… æ’ç­è¨­å®š</h6>
        <ul class="help-list">
          <li class="help-item">
            <strong>é€±è¡Œäº‹æ›†ï¼š</strong>ç›´è§€é¡¯ç¤ºä¸€é€±æ’ç­ï¼Œé»æ“Šç©ºç™½æ™‚æ®µå¿«é€Ÿæ–°å¢
          </li>
          <li class="help-item">
            <strong>é ç´„æ™‚é•·ï¼š</strong>æ¯å€‹é ç´„æ™‚æ®µçš„é•·åº¦ï¼ˆ15-60åˆ†é˜ï¼‰
          </li>
          <li class="help-item">
            <strong>æœ€å¤§é ç´„æ•¸ï¼š</strong>åŒä¸€æ™‚æ®µå¯æ¥å—çš„é ç´„äººæ•¸ä¸Šé™
          </li>
          <li class="help-item">
            <strong>æ’ç­ç‹€æ…‹ï¼š</strong>å¯éš¨æ™‚å•Ÿç”¨æˆ–åœç”¨ï¼Œåœç”¨å¾Œä¸é–‹æ”¾é ç´„
          </li>
        </ul>
      </div>
      
      <div class="col-md-6">
        <h6 class="text-muted mb-3">ğŸ› ï¸ æ“ä½œåŠŸèƒ½</h6>
        <ul class="help-list">
          <li class="help-item">
            <strong>å¿«é€Ÿæ–°å¢ï¼š</strong>åœ¨é€±è¡Œäº‹æ›†é»æ“Šç©ºç™½æ™‚æ®µå³å¯å¿«é€Ÿè¨­å®š
          </li>
          <li class="help-item">
            <strong>è¤‡è£½æ’ç­ï¼š</strong>å¿«é€Ÿè¤‡è£½ä¸Šé€±æˆ–ç¯„æœ¬æ’ç­åˆ°æœ¬é€±
          </li>
          <li class="help-item">
            <strong>æ‰¹é‡ç®¡ç†ï¼š</strong>å¯åŒæ™‚å•Ÿç”¨æˆ–åœç”¨å¤šå€‹æ’ç­
          </li>
          <li class="help-item">
            <strong>è¡çªæª¢æŸ¥ï¼š</strong>ç³»çµ±è‡ªå‹•æª¢æŸ¥æ’ç­æ™‚é–“æ˜¯å¦é‡ç–Š
          </li>
        </ul>
      </div>
    </div>
  </div>

</div>

<!-- éš±è—çš„è¡¨å–®ç”¨æ–¼ AJAX è«‹æ±‚ -->
<form id="ajaxForm" style="display: none;">
  {% csrf_token %}
</form>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/clinic/schedule-management.js' %}"></script>

<script>
// é é¢å°ˆç”¨åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ¯ æ’ç­ç®¡ç†é é¢è¼‰å…¥å®Œæˆ');
  
  // å‚³é Django æ•¸æ“šåˆ° JavaScript
  window.schedulePageData = {
    doctorId: {{ doctor.id }},
    doctorName: '{{ doctor.user.get_full_name|default:doctor.user.username|escapejs }}',
    canEdit: {{ can_edit|yesno:"true,false" }},
    csrfToken: '{{ csrf_token }}',
    schedules: [
      {% for schedule in schedules %}
      {
        id: {{ schedule.id }},
        weekday: {{ schedule.weekday }},
        weekdayDisplay: '{{ schedule.get_weekday_display|escapejs }}',
        startTime: '{{ schedule.start_time|time:"H:i" }}',
        endTime: '{{ schedule.end_time|time:"H:i" }}',
        appointmentDuration: {{ schedule.appointment_duration }},
        maxAppointmentsPerSlot: {{ schedule.max_appointments_per_slot }},
        notes: '{{ schedule.notes|default:""|escapejs }}',
        isActive: {{ schedule.is_active|yesno:"true,false" }}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ],
    urls: {
      addSchedule: '{% url "add_schedule" doctor.id %}',
      editSchedule: '/clinic/schedules/{id}/edit/',
      deleteSchedule: '/clinic/schedules/{id}/delete/',
      toggleSchedule: '/clinic/schedules/toggle/{id}/',
      copyWeek: '{% url "copy_week_schedule" doctor.id %}'
    }
  };
  
  // é¡¯ç¤ºè¨Šæ¯
  {% if messages %}
    {% for message in messages %}
      {% if message.tags == 'success' %}
        showSuccessMessage('{{ message|escapejs }}');
      {% elif message.tags == 'error' %}
        showErrorMessage('{{ message|escapejs }}');
      {% endif %}
    {% endfor %}
  {% endif %}
  
  // åˆå§‹åŒ–æ’ç­ç³»çµ±
  initializeScheduleManagement();
});
</script>
{% endblock %}