{% extends 'base.html' %}
{% load static %}

{% block title %}é†«å¸«ç®¡ç† - {{ clinic.clinic_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clinic/doctor-management.css' %}">
{% endblock %}

{% block content %}
<div class="doctor-management-container">
  
  <!-- å„ªåŒ–å¾Œçš„é é¢æ¨™é¡Œ -->
  <div class="page-header-enhanced">
    <div class="header-background"></div>
    
    <div class="row align-items-center position-relative">
      <div class="col-lg-8">
        <div class="title-section">
          <div class="title-icon-wrapper">
            <div class="title-icon">
              <i class="bi bi-people-fill"></i>
            </div>
          </div>
          
          <div class="title-content">
            <h1 class="page-title-enhanced">é†«å¸«ç®¡ç†ä¸­å¿ƒ</h1>
            <div class="page-subtitle-enhanced">ç®¡ç†æ‚¨çš„é†«ç™‚åœ˜éšŠï¼Œæ‰“é€ å°ˆæ¥­æœå‹™</div>
          </div>
        </div>
        
        <div class="clinic-info-card">
          <div class="clinic-avatar">
            <i class="bi bi-hospital-fill"></i>
          </div>
          <div class="clinic-details">
            <h3 class="clinic-name">{{ clinic.clinic_name }}</h3>
            <div class="clinic-meta">
              <div class="meta-item">
                <i class="bi bi-geo-alt-fill"></i>
                <span>{{ clinic.clinic_address }}</span>
              </div>
              <div class="meta-item">
                <i class="bi bi-telephone-fill"></i>
                <span>{{ clinic.clinic_phone }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- å„ªåŒ–å¾Œçš„çµ±è¨ˆå¡ç‰‡ -->
        <div class="stats-container">
          <div class="stat-card stat-primary">
            <div class="stat-icon">
              <i class="bi bi-people"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="totalDoctors">{{ doctors.count }}</div>
              <div class="stat-label">ç¸½é†«å¸«æ•¸</div>
            </div>
          </div>
          
          <div class="stat-card stat-success">
            <div class="stat-icon">
              <i class="bi bi-person-check"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="activeDoctors">
                {% for doctor in doctors %}{% if doctor.is_active %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}
              </div>
              <div class="stat-label">å•Ÿç”¨ä¸­</div>
            </div>
          </div>
          
          <div class="stat-card stat-info">
            <div class="stat-icon">
              <i class="bi bi-shield-check"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="verifiedDoctors">
                {% for doctor in doctors %}{% if doctor.is_verified %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}
              </div>
              <div class="stat-label">å·²é©—è­‰</div>
            </div>
          </div>
          
          <div class="stat-card stat-warning">
            <div class="stat-icon">
              <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number" id="pendingDoctors">
                {% for doctor in doctors %}{% if not doctor.license_verified_with_moa %}{{ forloop.counter0|add:1 }}{% endif %}{% endfor %}
              </div>
              <div class="stat-label">å¾…é©—è­‰</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="action-panel">
          <a href="{% url 'add_doctor' %}" class="btn-enhanced btn-primary-enhanced">
            <div class="btn-icon">
              <i class="bi bi-person-plus"></i>
            </div>
            <div class="btn-content">
              <div class="btn-title">æ–°å¢é†«å¸«</div>
              <div class="btn-subtitle">å»ºç«‹æ–°çš„é†«å¸«å¸³è™Ÿ</div>
            </div>
          </a>
          
          <button class="btn-enhanced btn-secondary-enhanced" onclick="showBatchActionsModal()">
            <div class="btn-icon">
              <i class="bi bi-gear-fill"></i>
            </div>
            <div class="btn-content">
              <div class="btn-title">æ‰¹é‡æ“ä½œ</div>
              <div class="btn-subtitle">ç®¡ç†å¤šä½é†«å¸«</div>
            </div>
          </button>
          
          <a href="{% url 'clinic_dashboard' %}" class="btn-enhanced btn-outline-enhanced">
            <div class="btn-icon">
              <i class="bi bi-arrow-left-circle"></i>
            </div>
            <div class="btn-content">
              <div class="btn-title">è¿”å›ä¸»æ§å°</div>
              <div class="btn-subtitle">å›åˆ°ç®¡ç†ä»‹é¢</div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- æœå°‹èˆ‡ç¯©é¸å·¥å…·åˆ— -->
  <div class="toolbar-section">
    <div class="row align-items-center">
      <div class="col-lg-6">
        <div class="search-section">
          <div class="search-input-group">
            <div class="search-icon">
              <i class="bi bi-search"></i>
            </div>
            <input 
              type="text" 
              id="doctorSearch" 
              class="search-input" 
              placeholder="æœå°‹é†«å¸«å§“åã€å°ˆé•·ã€åŸ·ç…§è™Ÿç¢¼..."
              autocomplete="off"
            >
            <button class="search-clear" id="clearSearch" style="display: none;">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div class="col-lg-6">
        <div class="d-flex justify-content-between align-items-center">
          <div class="filter-chips">
            <div class="filter-chip active" data-filter="all">
              <i class="bi bi-people me-1"></i>
              å…¨éƒ¨é†«å¸«
            </div>
            <div class="filter-chip" data-filter="active">
              <i class="bi bi-check-circle me-1"></i>
              å•Ÿç”¨ä¸­
            </div>
            <div class="filter-chip" data-filter="verified">
              <i class="bi bi-shield-check me-1"></i>
              å·²é©—è­‰
            </div>
            <div class="filter-chip" data-filter="pending">
              <i class="bi bi-hourglass-split me-1"></i>
              å¾…é©—è­‰
            </div>
          </div>
          
          <div class="view-options">
            <div class="sort-dropdown">
              <select id="sortBy" class="sort-select">
                <option value="name">ä¾å§“åæ’åº</option>
                <option value="created">ä¾åŠ å…¥æ™‚é–“</option>
                <option value="specialization">ä¾å°ˆé•·æ’åº</option>
                <option value="status">ä¾ç‹€æ…‹æ’åº</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é†«å¸«å¡ç‰‡åˆ—è¡¨ -->
  <div class="doctors-grid" id="doctorsGrid">
    {% for doctor in doctors %}
    <div class="doctor-card-modern" data-doctor-id="{{ doctor.id }}" data-filter-tags="{{ doctor.user.get_full_name|default:doctor.user.username|lower }} {{ doctor.specialization|lower }} {{ doctor.vet_license_number|lower }}">
      
      <!-- é†«å¸«é ­åƒèˆ‡åŸºæœ¬è³‡è¨Š -->
      <div class="doctor-header">
        <div class="doctor-avatar">
          {% if doctor.user.first_name %}
            {{ doctor.user.first_name|first }}{{ doctor.user.last_name|first|default:"" }}
          {% else %}
            {{ doctor.user.username|first|upper }}
          {% endif %}
        </div>
        
        <div class="doctor-info">
          <h3 class="doctor-name">
            {{ doctor.user.get_full_name|default:doctor.user.username }}
            {% if doctor.is_clinic_admin %}
              <span class="admin-badge">
                <i class="bi bi-crown"></i>
                ç®¡ç†å“¡
              </span>
            {% endif %}
          </h3>
          
          <div class="doctor-meta">
            <div class="meta-item">
              <i class="bi bi-envelope"></i>
              <span>{{ doctor.user.email }}</span>
            </div>
            
            {% if doctor.user.profile.phone_number %}
            <div class="meta-item">
              <i class="bi bi-telephone"></i>
              <span>{{ doctor.user.profile.phone_number }}</span>
            </div>
            {% endif %}
          </div>
        </div>
        
        <div class="doctor-status">
          <!-- å•Ÿç”¨ç‹€æ…‹ -->
          {% if doctor.is_active %}
            <div class="status-badge-modern status-active-modern">
              <i class="bi bi-check-circle"></i>
              <span>å•Ÿç”¨ä¸­</span>
            </div>
          {% else %}
            <div class="status-badge-modern status-inactive-modern">
              <i class="bi bi-pause-circle"></i>
              <span>å·²åœç”¨</span>
            </div>
          {% endif %}
          
          <!-- é©—è­‰ç‹€æ…‹ -->
          {% if doctor.license_verified_with_moa %}
            <div class="verification-badge verified">
              <i class="bi bi-shield-check"></i>
              <span>åŸ·ç…§å·²é©—è­‰</span>
            </div>
          {% elif doctor.vet_license_number %}
            <div class="verification-badge pending">
              <i class="bi bi-hourglass-split"></i>
              <span>å¾…é©—è­‰</span>
            </div>
          {% else %}
            <div class="verification-badge none">
              <i class="bi bi-shield-x"></i>
              <span>æœªå¡«å¯«åŸ·ç…§</span>
            </div>
          {% endif %}
        </div>
      </div>
      
      <!-- é†«å¸«è©³ç´°è³‡è¨Š -->
      <div class="doctor-details">
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">å°ˆé•·é ˜åŸŸ</div>
            <div class="detail-value">{{ doctor.specialization|default:"æœªå¡«å¯«" }}</div>
          </div>
          
          <div class="detail-item">
            <div class="detail-label">åŸ·æ¥­å¹´è³‡</div>
            <div class="detail-value">{{ doctor.years_of_experience|default:0 }} å¹´</div>
          </div>
          
          <div class="detail-item">
            <div class="detail-label">åŸ·ç…§è™Ÿç¢¼</div>
            <div class="detail-value">
              {% if doctor.vet_license_number %}
                {{ doctor.vet_license_number }}
              {% else %}
                <span class="text-muted">æœªå¡«å¯«</span>
              {% endif %}
            </div>
          </div>
          
          <div class="detail-item">
            <div class="detail-label">åŠ å…¥æ™‚é–“</div>
            <div class="detail-value">{{ doctor.created_at|date:"Y/m/d" }}</div>
          </div>
        </div>
        
        {% if doctor.bio %}
        <div class="doctor-bio">
          <div class="bio-label">
            <i class="bi bi-card-text me-1"></i>
            å€‹äººç°¡ä»‹
          </div>
          <div class="bio-content">{{ doctor.bio }}</div>
        </div>
        {% endif %}
        
        <!-- æ¬Šé™é¡¯ç¤º -->
        <div class="permissions-display">
          <div class="permission-item {% if doctor.can_manage_appointments %}active{% endif %}">
            <i class="bi bi-calendar-check"></i>
            <span>ç®¡ç†é ç´„</span>
          </div>
          {% if doctor.is_clinic_admin %}
          <div class="permission-item active">
            <i class="bi bi-people"></i>
            <span>ç®¡ç†é†«å¸«</span>
          </div>
          {% endif %}
          {% if doctor.can_write_medical_records %}
          <div class="permission-item active">
            <i class="bi bi-file-medical"></i>
            <span>å¡«å¯«ç—…æ­·</span>
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- æ“ä½œæŒ‰éˆ•çµ„ -->
      <div class="action-buttons-group">
        <a 
          href="{% url 'edit_doctor' doctor.id %}" 
          class="action-btn btn-edit"
          title="ç·¨è¼¯é†«å¸«è³‡æ–™"
        >
          <i class="bi bi-pencil"></i>
        </a>
        
        <a 
          href="{% url 'manage_doctor_schedules' doctor.id %}" 
          class="action-btn btn-schedule"
          title="ç®¡ç†æ’ç­"
        >
          <i class="bi bi-calendar3"></i>
        </a>
        
        <button 
          class="action-btn btn-info"
          onclick="viewDoctorDetails({{ doctor.id }})"
          title="æŸ¥çœ‹è©³ç´°è³‡æ–™"
        >
          <i class="bi bi-info-circle"></i>
        </button>
        
        {% if not doctor.is_clinic_admin %}
        <button 
          class="action-btn {% if doctor.is_active %}btn-toggle-active{% else %}btn-toggle-inactive{% endif %} toggle-doctor-btn"
          data-doctor-id="{{ doctor.id }}"
          data-action="{% if doctor.is_active %}deactivate{% else %}activate{% endif %}"
          title="{% if doctor.is_active %}åœç”¨é†«å¸«{% else %}å•Ÿç”¨é†«å¸«{% endif %}"
        >
          <i class="bi bi-{% if doctor.is_active %}pause{% else %}play{% endif %}"></i>
          <div class="loading-spinner-modern"></div>
        </button>
        {% endif %}
        
        {% if not doctor.license_verified_with_moa and doctor.vet_license_number %}
        <button 
          class="action-btn btn-verify"
          onclick="verifyDoctorLicense({{ doctor.id }})"
          title="é©—è­‰åŸ·ç…§"
        >
          <i class="bi bi-shield-check"></i>
        </button>
        {% endif %}
      </div>
      
    </div>
    {% empty %}
    
    <!-- ç©ºç‹€æ…‹ -->
    <div class="empty-state-modern">
      <div class="empty-icon">
        <i class="bi bi-people"></i>
      </div>
      <h3 class="empty-title">å°šæœªæ–°å¢ä»»ä½•é†«å¸«</h3>
      <p class="empty-description">
        é–‹å§‹å»ºç«‹æ‚¨çš„é†«ç™‚åœ˜éšŠå§ï¼<br>
        æ–°å¢é†«å¸«å¾Œï¼Œä»–å€‘å°±èƒ½é–‹å§‹æ¥å—é ç´„ä¸¦æä¾›é†«ç™‚æœå‹™ã€‚
      </p>
      <a href="{% url 'add_doctor' %}" class="btn-modern btn-primary-modern">
        <i class="bi bi-person-plus"></i>
        <span>æ–°å¢ç¬¬ä¸€ä½é†«å¸«</span>
      </a>
    </div>
    
    {% endfor %}
  </div>

  <!-- æœå°‹çµæœç‚ºç©ºçš„ç‹€æ…‹ -->
  <div id="noResultsState" class="empty-state-modern" style="display: none;">
    <div class="empty-icon">
      <i class="bi bi-search"></i>
    </div>
    <h3 class="empty-title">æ‰¾ä¸åˆ°ç›¸ç¬¦çš„é†«å¸«</h3>
    <p class="empty-description">
      è«‹å˜—è©¦ï¼š<br>
      â€¢ èª¿æ•´æœå°‹é—œéµå­—<br>
      â€¢ ä½¿ç”¨ä¸åŒçš„ç¯©é¸æ¢ä»¶<br>
      â€¢ æª¢æŸ¥æ‹¼å­—æ˜¯å¦æ­£ç¢º
    </p>
    <button class="btn-modern btn-outline-modern" onclick="clearAllFilters()">
      <i class="bi bi-arrow-clockwise"></i>
      <span>æ¸…é™¤ç¯©é¸</span>
    </button>
  </div>

  <!-- é†«å¸«è©³ç´°è³‡æ–™ Modal -->
  <div id="doctorDetailsModal" class="modal-overlay" style="display: none;">
    <div class="modal-container modal-lg">
      <div class="modal-header">
        <h3 id="doctorDetailsTitle">é†«å¸«è©³ç´°è³‡æ–™</h3>
        <button class="modal-close" onclick="closeDoctorDetailsModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      
      <div class="modal-body" id="doctorDetailsContent">
        <!-- è©³ç´°è³‡æ–™å°‡é€é JavaScript å‹•æ…‹è¼‰å…¥ -->
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-modern btn-outline-modern" onclick="closeDoctorDetailsModal()">
          é—œé–‰
        </button>
        <button type="button" class="btn-modern btn-primary-modern" id="editDoctorFromModal">
          ç·¨è¼¯è³‡æ–™
        </button>
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡æ“ä½œ Modal -->
  <div id="batchActionsModal" class="modal-overlay" style="display: none;">
    <div class="modal-container modal-sm">
      <div class="modal-header">
        <h3>æ‰¹é‡æ“ä½œ</h3>
        <button class="modal-close" onclick="closeBatchActionsModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <p>é¸æ“‡è¦åŸ·è¡Œçš„æ‰¹é‡æ“ä½œï¼š</p>
        
        <div class="batch-options">
          <button class="batch-option-btn" onclick="batchActivateAll()">
            <i class="bi bi-check-circle-fill text-success"></i>
            <div class="option-content">
              <div class="option-title">å•Ÿç”¨æ‰€æœ‰é†«å¸«</div>
              <div class="option-desc">å°‡æ‰€æœ‰åœç”¨çš„é†«å¸«è¨­ç‚ºå•Ÿç”¨ç‹€æ…‹</div>
            </div>
          </button>
          
          <button class="batch-option-btn" onclick="batchSendWelcomeEmails()">
            <i class="bi bi-envelope-heart text-info"></i>
            <div class="option-content">
              <div class="option-title">ç™¼é€æ­¡è¿ä¿¡</div>
              <div class="option-desc">å‘æ‰€æœ‰æ–°åŠ å…¥çš„é†«å¸«ç™¼é€æ­¡è¿ä¿¡ä»¶</div>
            </div>
          </button>
          
          <button class="batch-option-btn" onclick="exportDoctorsList()">
            <i class="bi bi-download text-primary"></i>
            <div class="option-content">
              <div class="option-title">åŒ¯å‡ºé†«å¸«æ¸…å–®</div>
              <div class="option-desc">ä¸‹è¼‰åŒ…å«æ‰€æœ‰é†«å¸«è³‡æ–™çš„ Excel æª”æ¡ˆ</div>
            </div>
          </button>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-modern btn-outline-modern" onclick="closeBatchActionsModal()">
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>


<!-- éš±è—çš„è¡¨å–®ç”¨æ–¼ AJAX è«‹æ±‚ -->
<form id="ajaxForm" style="display: none;">
  {% csrf_token %}
</form>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/clinic/doctor-management.js' %}"></script>

<script>
// é é¢å°ˆç”¨åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ¯ é†«å¸«ç®¡ç†é é¢è¼‰å…¥å®Œæˆ');
  
  // å‚³é Django æ•¸æ“šåˆ° JavaScript
  window.doctorPageData = {
    clinicId: {{ clinic.id }},
    clinicName: '{{ clinic.clinic_name|escapejs }}',
    canManage: {{ vet_profile.can_manage_doctors|yesno:"true,false" }},
    csrfToken: '{{ csrf_token }}',
    doctors: [
      {% for doctor in doctors %}
      {
        id: {{ doctor.id }},
        name: '{{ doctor.user.get_full_name|default:doctor.user.username|escapejs }}',
        email: '{{ doctor.user.email|escapejs }}',
        phone: '{{ doctor.user.profile.phone_number|default:""|escapejs }}',
        specialization: '{{ doctor.specialization|default:""|escapejs }}',
        yearsOfExperience: {{ doctor.years_of_experience|default:0 }},
        bio: '{{ doctor.bio|default:""|escapejs }}',
        vetLicenseNumber: '{{ doctor.vet_license_number|default:""|escapejs }}',
        isActive: {{ doctor.is_active|yesno:"true,false" }},
        isVerified: {{ doctor.license_verified_with_moa|yesno:"true,false" }},
        isAdmin: {{ doctor.is_clinic_admin|yesno:"true,false" }},
        createdAt: '{{ doctor.created_at|date:"Y-m-d" }}'
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ],
    urls: {
      toggleDoctor: '{% url "toggle_doctor_status" 0 %}'.replace('0', '{id}'),
      editDoctor: '{% url "edit_doctor" 0 %}'.replace('0', '{id}'),
      manageSchedules: '{% url "manage_doctor_schedules" 0 %}'.replace('0', '{id}')
    }
  };
  
  // é¡¯ç¤ºè¨Šæ¯
  {% if messages %}
    {% for message in messages %}
      {% if message.tags == 'success' %}
        showSuccessMessage('{{ message|escapejs }}');
      {% elif message.tags == 'error' %}
        showErrorMessage('{{ message|escapejs }}');
      {% endif %}
    {% endfor %}
  {% endif %}
  
  // åˆå§‹åŒ–é†«å¸«ç®¡ç†ç³»çµ±
  initializeDoctorManagement();
});
</script>
{% endblock %}