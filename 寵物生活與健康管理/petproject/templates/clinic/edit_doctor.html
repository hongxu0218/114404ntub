{% extends 'base.html' %}
{% load static %}

{% block title %}ç·¨è¼¯é†«å¸« - {{ doctor.user.get_full_name|default:doctor.user.username }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clinic/edit-doctor.css' %}">
{% endblock %}

{% block content %}
<div class="edit-doctor-container">
  
  <!-- ç¾ä»£åŒ–é é¢æ¨™é¡Œ -->
  <div class="page-header-modern">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="page-title-modern">
          <i class="bi bi-person-gear me-3"></i>
          ç·¨è¼¯é†«å¸«è³‡æ–™
        </h1>
        <div class="page-subtitle-modern">
          <div class="doctor-info-quick">
            <div class="doctor-avatar-mini">
              {% if doctor.user.first_name %}
                {{ doctor.user.first_name|first }}
              {% else %}
                {{ doctor.user.username|first|upper }}
              {% endif %}
            </div>
            <div class="doctor-details-mini">
              <span class="doctor-name">
                {% if doctor.user.first_name %}
                  Dr. {{ doctor.user.first_name }}
                {% else %}
                  Dr. {{ doctor.user.username }}
                {% endif %}
              </span>
              <span class="doctor-email">{{ doctor.user.email }}</span>
            </div>
          </div>
        </div>
        
        <!-- é†«å¸«ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
        <div class="doctor-status-indicators">
          {% if doctor.is_active %}
            <span class="status-indicator status-active">
              <i class="bi bi-check-circle"></i>
              å¸³è™Ÿå•Ÿç”¨
            </span>
          {% else %}
            <span class="status-indicator status-inactive">
              <i class="bi bi-pause-circle"></i>
              å¸³è™Ÿåœç”¨
            </span>
          {% endif %}
          
          {% if doctor.license_verified_with_moa %}
            <span class="status-indicator status-verified">
              <i class="bi bi-shield-check"></i>
              åŸ·ç…§å·²é©—è­‰
            </span>
          {% else %}
            <span class="status-indicator status-unverified">
              <i class="bi bi-clock"></i>
              å¾…é©—è­‰åŸ·ç…§
            </span>
          {% endif %}
          
          {% if doctor.is_clinic_admin %}
            <span class="status-indicator status-admin">
              <i class="bi bi-crown"></i>
              è¨ºæ‰€ç®¡ç†å“¡
            </span>
          {% endif %}
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="action-buttons-modern">
          <a href="javascript:history.back()" class="btn-modern btn-outline-modern">
            <i class="bi bi-arrow-left"></i>
            <span>è¿”å›åˆ—è¡¨</span>
          </a>
          
          {% if doctor.license_verified_with_moa %}
          <a href="#" class="btn-modern btn-info-modern">
            <i class="bi bi-calendar3"></i>
            <span>ç®¡ç†æ’ç­</span>
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- è¡¨å–®æ¨™ç±¤é å°èˆª -->
  <div class="tabs-navigation-modern">
    <div class="nav nav-tabs-modern" role="tablist">
      <button class="nav-link-modern active" data-tab="basic" type="button" role="tab" aria-selected="true">
        <i class="bi bi-person-badge me-2"></i>
        åŸºæœ¬è³‡æ–™
      </button>
      <button class="nav-link-modern" data-tab="professional" type="button" role="tab" aria-selected="false">
        <i class="bi bi-award me-2"></i>
        å°ˆæ¥­è³‡è¨Š
      </button>
      <button class="nav-link-modern" data-tab="permissions" type="button" role="tab" aria-selected="false">
        <i class="bi bi-shield-check me-2"></i>
        æ¬Šé™è¨­å®š
      </button>
      <button class="nav-link-modern" data-tab="security" type="button" role="tab" aria-selected="false">
        <i class="bi bi-lock me-2"></i>
        å®‰å…¨è¨­å®š
      </button>
    </div>
  </div>

  <!-- ä¸»è¦è¡¨å–®å€åŸŸ -->
  <div class="form-container-modern">
    <form method="post" id="editDoctorForm" novalidate>
      {% csrf_token %}
      
      <!-- åŸºæœ¬è³‡æ–™æ¨™ç±¤ -->
      <div class="tab-content-modern active" data-content="basic" aria-hidden="false">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-person-badge me-2"></i>
            åŸºæœ¬å€‹äººè³‡æ–™
          </h3>
          <p class="section-description">
            æ›´æ–°é†«å¸«çš„åŸºæœ¬å€‹äººè³‡è¨Šå’Œè¯çµ¡æ–¹å¼
          </p>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group-modern">
              <label for="{{ form.first_name.id_for_label }}" class="form-label-modern">
                <i class="bi bi-person me-1"></i>
                {{ form.first_name.label }}
                <span class="required-mark">*</span>
              </label>
              {{ form.first_name }}
              <div class="form-help">é†«å¸«çš„çœŸå¯¦å§“å</div>
              <div class="invalid-feedback"></div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="form-group-modern">
              <label for="{{ form.email.id_for_label }}" class="form-label-modern">
                <i class="bi bi-envelope me-1"></i>
                {{ form.email.label }}
                <span class="required-mark">*</span>
              </label>
              {{ form.email }}
              <div class="form-help">ç”¨æ–¼æ¥æ”¶ç³»çµ±é€šçŸ¥</div>
              <div class="invalid-feedback"></div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group-modern">
              <label for="{{ form.phone_number.id_for_label }}" class="form-label-modern">
                <i class="bi bi-telephone me-1"></i>
                {{ form.phone_number.label }}
              </label>
              {{ form.phone_number }}
              <div class="form-help">è¯çµ¡é›»è©±ï¼Œæ ¼å¼ï¼š09xxxxxxxx</div>
              <div class="invalid-feedback"></div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="form-group-modern">
              <label class="form-label-modern">
                <i class="bi bi-at me-1"></i>
                ä½¿ç”¨è€…åç¨±
              </label>
              <input type="text" class="form-control" value="{{ doctor.user.username }}" readonly>
              <div class="form-help">ä½¿ç”¨è€…åç¨±ç„¡æ³•ä¿®æ”¹</div>
            </div>
          </div>
        </div>
        
        <!-- å¸³è™Ÿå»ºç«‹è³‡è¨Š -->
        <div class="account-info-card">
          <h6 class="info-title">
            <i class="bi bi-info-circle me-2"></i>
            å¸³è™Ÿè³‡è¨Š
          </h6>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">å»ºç«‹æ—¥æœŸï¼š</span>
              <span class="info-value">{{ doctor.user.date_joined|date:"Yå¹´mæœˆdæ—¥ H:i" }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">æœ€å¾Œç™»å…¥ï¼š</span>
              <span class="info-value">
                {% if doctor.user.last_login %}
                  {{ doctor.user.last_login|date:"Yå¹´mæœˆdæ—¥ H:i" }}
                {% else %}
                  å¾æœªç™»å…¥
                {% endif %}
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">å¸³è™Ÿç‹€æ…‹ï¼š</span>
              <span class="info-value">
                {% if doctor.is_active %}
                  <span class="text-success">å•Ÿç”¨ä¸­</span>
                {% else %}
                  <span class="text-warning">å·²åœç”¨</span>
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- å°ˆæ¥­è³‡è¨Šæ¨™ç±¤ -->
      <div class="tab-content-modern" data-content="professional" aria-hidden="true">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-award me-2"></i>
            å°ˆæ¥­èƒŒæ™¯èˆ‡åŸ·ç…§
          </h3>
          <p class="section-description">
            ç®¡ç†é†«å¸«çš„å°ˆæ¥­è³‡è¨Šå’ŒåŸ·ç…§é©—è­‰ç‹€æ…‹
          </p>
        </div>
        
        <!-- åŸ·ç…§é©—è­‰å€åŸŸ -->
        <div class="license-verification-card">
          <div class="license-header">
            <h6 class="license-title">
              <i class="bi bi-card-text me-2"></i>
              ç¸é†«å¸«åŸ·ç…§é©—è­‰
            </h6>
            {% if doctor.license_verified_with_moa %}
              <span class="verification-badge verified">
                <i class="bi bi-shield-check me-1"></i>
                å·²é€šéè¾²å§”æœƒé©—è­‰
              </span>
            {% else %}
              <span class="verification-badge unverified">
                <i class="bi bi-clock me-1"></i>
                å¾…é©—è­‰
              </span>
            {% endif %}
          </div>
          
          {% if doctor.license_verified_with_moa %}
            <!-- å·²é©—è­‰çš„åŸ·ç…§é¡¯ç¤º -->
            <div class="license-number-protected">
              <div class="license-info">
                <div class="license-status-verified">
                  <i class="bi bi-shield-check-fill me-2"></i>
                  <span>åŸ·ç…§å·²é€šéè¾²å§”æœƒé©—è­‰</span>
                </div>
                {% if doctor.vet_license_number %}
                  <div class="license-number-masked">
                    åŸ·ç…§è™Ÿç¢¼ï¼š{{ doctor.vet_license_number|slice:":2" }}****{{ doctor.vet_license_number|slice:"-2:" }}
                  </div>
                {% endif %}
                {% if doctor.moa_license_type %}
                  <div class="license-type">
                    <i class="bi bi-check-circle text-success me-1"></i>
                    åŸ·ç…§é¡åˆ¥ï¼š{{ doctor.moa_license_type }}
                  </div>
                {% endif %}
              </div>
              <div class="license-actions">
                {% if doctor.vet_license_number %}
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleLicenseVisibility">
                  <i class="bi bi-eye"></i> é¡¯ç¤ºå®Œæ•´è™Ÿç¢¼
                </button>
                {% endif %}
                <button type="button" class="btn btn-sm btn-outline-warning" id="updateLicenseBtn">
                  <i class="bi bi-pencil"></i> æ›´æ–°åŸ·ç…§
                </button>
              </div>
            </div>
            
            <!-- éš±è—çš„åŸ·ç…§è¼¸å…¥æ¡†ä¾›è¡¨å–®æäº¤ä½¿ç”¨ -->
            <input type="hidden" name="vet_license_number" value="{{ doctor.vet_license_number }}">
            
            <!-- é©—è­‰è©³ç´°è³‡è¨Š -->
            <div class="verification-info">
              <div class="verification-details">
                <!-- åŸ·ç…§é©—è­‰ç‹€æ…‹ -->
                <div class="detail-item verification-status">
                  <span class="detail-label">
                    <i class="bi bi-shield-check me-1"></i>
                    åŸ·ç…§é©—è­‰ç‹€æ…‹ï¼š
                  </span>
                  <span class="detail-value">
                    {% if doctor.license_verified_with_moa %}
                      <span class="status-badge verified">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        å·²é€šéè¾²å§”æœƒé©—è­‰
                      </span>
                    {% else %}
                      <span class="status-badge pending">
                        <i class="bi bi-clock me-1"></i>
                        ç­‰å¾…é©—è­‰
                      </span>
                    {% endif %}
                  </span>
                </div>
                
                <!-- é©—è­‰æ™‚é–“ -->
                {% if doctor.license_verified_with_moa and doctor.verification_date %}
                <div class="detail-item">
                  <span class="detail-label">
                    <i class="bi bi-calendar-check me-1"></i>
                    é©—è­‰å®Œæˆæ™‚é–“ï¼š
                  </span>
                  <span class="detail-value verification-time">
                    {{ doctor.verification_date|date:"Yå¹´mæœˆdæ—¥ H:i" }}
                    <small class="text-muted ms-2">
                      ({{ doctor.verification_date|timesince }}å‰)
                    </small>
                  </span>
                </div>
                {% elif not doctor.license_verified_with_moa %}
                <div class="detail-item">
                  <span class="detail-label">
                    <i class="bi bi-info-circle me-1"></i>
                    é©—è­‰èªªæ˜ï¼š
                  </span>
                  <span class="detail-value">
                    {% if doctor.vet_license_number %}
                      <span class="text-warning">
                        åŸ·ç…§è™Ÿç¢¼å·²å¡«å¯«ï¼Œç­‰å¾…ç®¡ç†å“¡æˆ–æœ¬äººé€²è¡Œé©—è­‰
                      </span>
                      <div class="verification-action mt-2">
                        <button type="button" class="btn btn-sm btn-success" id="verifyLicenseBtn">
                          <i class="bi bi-shield-check me-1"></i>
                          ç«‹å³é©—è­‰åŸ·ç…§
                        </button>
                      </div>
                    {% else %}
                      <span class="text-muted">
                        è«‹å…ˆå¡«å¯«åŸ·ç…§è™Ÿç¢¼æ‰èƒ½é€²è¡Œé©—è­‰
                      </span>
                    {% endif %}
                  </span>
                </div>
                {% endif %}
                
                <!-- åŸ·ç…§è©³ç´°è³‡è¨Š (å·²é©—è­‰æ‰é¡¯ç¤º) -->
                {% if doctor.license_verified_with_moa %}
                  {% if doctor.moa_license_type %}
                  <div class="detail-item">
                    <span class="detail-label">
                      <i class="bi bi-award me-1"></i>
                      åŸ·ç…§é¡åˆ¥ï¼š
                    </span>
                    <span class="detail-value">{{ doctor.moa_license_type }}</span>
                  </div>
                  {% endif %}
                  
                  {% if doctor.moa_clinic_name %}
                  <div class="detail-item">
                    <span class="detail-label">
                      <i class="bi bi-building me-1"></i>
                      è¾²å§”æœƒç™»è¨˜è¨ºæ‰€ï¼š
                    </span>
                    <span class="detail-value">{{ doctor.moa_clinic_name }}</span>
                  </div>
                  {% endif %}
                {% endif %}
                
                <!-- å¸³è™Ÿæ™‚é–“è³‡è¨Š -->
                <div class="detail-item">
                  <span class="detail-label">
                    <i class="bi bi-person-plus me-1"></i>
                    å¸³è™Ÿå»ºç«‹æ™‚é–“ï¼š
                  </span>
                  <span class="detail-value">
                    {{ doctor.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}
                    <small class="text-muted ms-2">
                      ({{ doctor.created_at|timesince }}å‰å»ºç«‹)
                    </small>
                  </span>
                </div>
                
                {% if doctor.updated_at %}
                <div class="detail-item">
                  <span class="detail-label">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š
                  </span>
                  <span class="detail-value">
                    {{ doctor.updated_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}
                    <small class="text-muted ms-2">
                      ({{ doctor.updated_at|timesince }}å‰)
                    </small>
                  </span>
                </div>
                {% endif %}
              </div>
            </div>
          {% else %}
            <!-- æœªé©—è­‰çš„åŸ·ç…§è¼¸å…¥ -->
            <div class="row">
              <div class="col-md-8">
                <div class="form-group-modern">
                  <label for="{{ form.vet_license_number.id_for_label }}" class="form-label-modern">
                    <i class="bi bi-card-text me-1"></i>
                    {{ form.vet_license_number.label }}
                  </label>
                  <input type="text" 
                         name="vet_license_number" 
                         id="id_vet_license_number"
                         class="form-control" 
                         value="{{ doctor.vet_license_number|default:'' }}"
                         placeholder="è«‹è¼¸å…¥å®Œæ•´åŸ·ç…§è™Ÿç¢¼ï¼Œä¾‹å¦‚ï¼š**åºœè¾²**å­—ç¬¬****è™Ÿ"
                         {% if not doctor.vet_license_number %}required{% endif %}>
                  <div class="form-help privacy-protected">è¾²å§”æœƒæ ¸ç™¼çš„ç¸é†«å¸«åŸ·ç…§è™Ÿç¢¼ï¼ˆéš±ç§ä¿è­·ï¼‰</div>
                  <div class="invalid-feedback"></div>
                </div>
              </div>
              
              <div class="col-md-4">
                {% if doctor.vet_license_number and not doctor.license_verified_with_moa %}
                  <div class="verify-action">
                    <button type="button" class="btn-verify-license" id="verifyLicenseBtn">
                      <i class="bi bi-shield-check"></i>
                      ç«‹å³é©—è­‰
                    </button>
                    <div class="verify-help">é»æ“Šé€²è¡Œè¾²å§”æœƒAPIé©—è­‰</div>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-group-modern">
              <label for="{{ form.specialization.id_for_label }}" class="form-label-modern">
                <i class="bi bi-star me-1"></i>
                {{ form.specialization.label }}
              </label>
              {{ form.specialization }}
              <div class="invalid-feedback"></div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="form-group-modern">
              <label for="{{ form.years_of_experience.id_for_label }}" class="form-label-modern">
                <i class="bi bi-calendar-check me-1"></i>
                {{ form.years_of_experience.label }}
              </label>
              {{ form.years_of_experience }}
              <div class="form-help">å¾å–å¾—åŸ·ç…§é–‹å§‹è¨ˆç®—çš„å¹´è³‡</div>
              <div class="invalid-feedback"></div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-12">
            <div class="form-group-modern">
              <label for="{{ form.bio.id_for_label }}" class="form-label-modern">
                <i class="bi bi-file-text me-1"></i>
                {{ form.bio.label }}
              </label>
              {{ form.bio }}
              <div class="form-help">é†«å¸«çš„å°ˆæ¥­èƒŒæ™¯å’Œæ²»ç™‚ç†å¿µä»‹ç´¹</div>
              <div class="character-counter">
                <span class="current">{{ form.bio.value|length|default:0 }}</span> / <span class="max">500</span>
              </div>
              <div class="invalid-feedback"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ¬Šé™è¨­å®šæ¨™ç±¤ -->
      <div class="tab-content-modern" data-content="permissions" aria-hidden="true">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-shield-check me-2"></i>
            ç³»çµ±æ¬Šé™ç®¡ç†
          </h3>
          <p class="section-description">
            è¨­å®šé†«å¸«åœ¨ç³»çµ±ä¸­çš„æ¬Šé™å’Œå¯ä½¿ç”¨çš„åŠŸèƒ½
          </p>
        </div>
        
        <div class="permission-cards">
          <!-- é ç´„ç®¡ç†æ¬Šé™ -->
          <div class="permission-card">
            <div class="permission-header">
              <h4 class="permission-title">
                <i class="bi bi-calendar3 me-2"></i>
                é ç´„ç®¡ç†æ¬Šé™
              </h4>
              <div class="permission-toggle">
                <div class="form-check form-switch">
                  {{ form.can_manage_appointments }}
                  <label for="{{ form.can_manage_appointments.id_for_label }}" class="form-check-label">
                    å•Ÿç”¨é ç´„ç®¡ç†
                  </label>
                </div>
              </div>
            </div>
            <div class="permission-description">
              å…è¨±é†«å¸«æŸ¥çœ‹ã€ç¢ºèªã€å–æ¶ˆå’Œä¿®æ”¹é ç´„ã€‚å»ºè­°æ‰€æœ‰åŸ·æ¥­é†«å¸«éƒ½é–‹å•Ÿæ­¤æ¬Šé™ã€‚
            </div>
            <div class="permission-features">
              <div class="feature-item">
                <i class="bi bi-check text-success"></i>
                æŸ¥çœ‹è‡ªå·±çš„é ç´„åˆ—è¡¨
              </div>
              <div class="feature-item">
                <i class="bi bi-check text-success"></i>
                ç¢ºèªæˆ–å–æ¶ˆé ç´„
              </div>
              <div class="feature-item">
                <i class="bi bi-check text-success"></i>
                ç®¡ç†é ç´„æ™‚æ®µ
              </div>
            </div>
          </div>
          
          <!-- è¨ºæ‰€ç®¡ç†å“¡æ¬Šé™ -->
          <div class="permission-card admin-permission">
            <div class="permission-header">
              <h4 class="permission-title">
                <i class="bi bi-crown me-2"></i>
                è¨ºæ‰€ç®¡ç†å“¡æ¬Šé™
              </h4>
              <div class="permission-toggle">
                <div class="form-check form-switch">
                  <input type="checkbox" 
                         id="isClinicAdmin" 
                         name="is_clinic_admin" 
                         class="form-check-input"
                         {% if doctor.is_clinic_admin %}checked{% endif %}>
                  <label for="isClinicAdmin" class="form-check-label">
                    è¨­ç‚ºç®¡ç†å“¡
                  </label>
                </div>
              </div>
            </div>
            <div class="permission-description">
              <i class="bi bi-info-circle text-info me-1"></i>
              ç®¡ç†å“¡æ¬Šé™å°‡å…è¨±æ­¤é†«å¸«ç®¡ç†è¨ºæ‰€çš„æ‰€æœ‰è¨­å®šå’Œå…¶ä»–é†«å¸«å¸³è™Ÿã€‚é†«å¸«å¯ä»¥åŒæ™‚å…·æœ‰ç®¡ç†å“¡å’ŒåŸ·æ¥­é†«å¸«èº«ä»½ã€‚
            </div>
            <div class="permission-features">
              <div class="feature-item">
                <i class="bi bi-check text-warning"></i>
                ç®¡ç†å…¶ä»–é†«å¸«å¸³è™Ÿ
              </div>
              <div class="feature-item">
                <i class="bi bi-check text-warning"></i>
                è¨­å®šè¨ºæ‰€æ’ç­
              </div>
              <div class="feature-item">
                <i class="bi bi-check text-warning"></i>
                æŸ¥çœ‹æ‰€æœ‰é ç´„è¨˜éŒ„
              </div>
              <div class="feature-item">
                <i class="bi bi-check text-warning"></i>
                ç®¡ç†è¨ºæ‰€åŸºæœ¬è¨­å®š
              </div>
            </div>
          </div>
        </div>
        
        <!-- æ¬Šé™è®Šæ›´è¨˜éŒ„ -->
        <div class="permission-history">
          <h6 class="history-title">
            <i class="bi bi-clock-history me-2"></i>
            æœ€è¿‘æ¬Šé™è®Šæ›´
          </h6>
          <div class="history-list">
            <div class="history-item">
              <div class="history-date">{{ doctor.created_at|date:"Yå¹´mæœˆdæ—¥" }}</div>
              <div class="history-action">å¸³è™Ÿå»ºç«‹</div>
              <div class="history-by">ç³»çµ±è‡ªå‹•</div>
            </div>
            {% if doctor.is_clinic_admin %}
            <div class="history-item">
              <div class="history-date">{{ doctor.updated_at|date:"Yå¹´mæœˆdæ—¥" }}</div>
              <div class="history-action">æˆäºˆç®¡ç†å“¡æ¬Šé™</div>
              <div class="history-by">{{ user.get_full_name|default:user.username }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- å®‰å…¨è¨­å®šæ¨™ç±¤ -->
      <div class="tab-content-modern" data-content="security" aria-hidden="true">
        <div class="section-header">
          <h3 class="section-title">
            <i class="bi bi-lock me-2"></i>
            å¸³è™Ÿå®‰å…¨è¨­å®š
          </h3>
          <p class="section-description">
            ç®¡ç†é†«å¸«å¸³è™Ÿçš„å®‰å…¨ç›¸é—œè¨­å®š
          </p>
        </div>
        
        <!-- å¯†ç¢¼é‡è¨­å€åŸŸ -->
        <div class="security-card">
          <div class="security-header">
            <h6 class="security-title">
              <i class="bi bi-key me-2"></i>
              å¯†ç¢¼ç®¡ç†
            </h6>
          </div>
          <div class="security-content">
            <p class="security-description">
              ç‚ºäº†å¸³è™Ÿå®‰å…¨ï¼Œå»ºè­°å®šæœŸæ›´æ–°å¯†ç¢¼ã€‚é†«å¸«ä¹Ÿå¯ä»¥è‡ªè¡Œåœ¨å€‹äººè¨­å®šä¸­ä¿®æ”¹å¯†ç¢¼ã€‚
            </p>
            <div class="security-actions">
              <button type="button" class="btn-security" id="resetPasswordBtn">
                <i class="bi bi-arrow-clockwise"></i>
                ç™¼é€å¯†ç¢¼é‡è¨­ä¿¡ä»¶
              </button>
              <div class="security-help">
                å°‡ç™¼é€å¯†ç¢¼é‡è¨­é€£çµåˆ°é†«å¸«çš„è¨»å†Šä¿¡ç®±
              </div>
            </div>
          </div>
        </div>
        
        <!-- å¸³è™Ÿç‹€æ…‹æ§åˆ¶ -->
        <div class="security-card">
          <div class="security-header">
            <h6 class="security-title">
              <i class="bi bi-person-check me-2"></i>
              å¸³è™Ÿç‹€æ…‹æ§åˆ¶
            </h6>
          </div>
          <div class="security-content">
            <div class="status-control">
              <div class="status-info">
                <div class="status-current">
                  ç›®å‰ç‹€æ…‹ï¼š
                  {% if doctor.is_active %}
                    <span class="badge badge-success">å¸³è™Ÿå•Ÿç”¨</span>
                  {% else %}
                    <span class="badge badge-warning">å¸³è™Ÿåœç”¨</span>
                  {% endif %}
                </div>
                <div class="status-description">
                  {% if doctor.is_active %}
                    é†«å¸«å¯ä»¥æ­£å¸¸ç™»å…¥å’Œä½¿ç”¨ç³»çµ±åŠŸèƒ½
                  {% else %}
                    é†«å¸«æš«æ™‚ç„¡æ³•ç™»å…¥ï¼Œä¸æœƒå‡ºç¾åœ¨é ç´„é¸é …ä¸­
                  {% endif %}
                </div>
              </div>
              
              {% if doctor != vet_profile %}
              <div class="status-actions">
                {% if doctor.is_active %}
                  <button type="button" class="btn-security btn-warning" id="deactivateAccountBtn">
                    <i class="bi bi-pause-circle"></i>
                    åœç”¨å¸³è™Ÿ
                  </button>
                {% else %}
                  <button type="button" class="btn-security btn-success" id="activateAccountBtn">
                    <i class="bi bi-play-circle"></i>
                    å•Ÿç”¨å¸³è™Ÿ
                  </button>
                {% endif %}
              </div>
              {% else %}
              <div class="status-notice">
                <i class="bi bi-info-circle text-info me-1"></i>
                æ‚¨ç„¡æ³•ä¿®æ”¹è‡ªå·±çš„å¸³è™Ÿç‹€æ…‹
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- ç™»å…¥è¨˜éŒ„ -->
        <div class="security-card">
          <div class="security-header">
            <h6 class="security-title">
              <i class="bi bi-clock-history me-2"></i>
              æœ€è¿‘ç™»å…¥è¨˜éŒ„
            </h6>
          </div>
          <div class="security-content">
            {% if doctor.user.last_login %}
              <div class="login-record">
                <div class="login-time">{{ doctor.user.last_login|date:"Yå¹´mæœˆdæ—¥ H:i:s" }}</div>
                <div class="login-detail">æœ€å¾Œä¸€æ¬¡ç™»å…¥</div>
              </div>
            {% else %}
              <div class="no-login">
                <i class="bi bi-exclamation-circle text-muted me-1"></i>
                æ­¤é†«å¸«å¾æœªç™»å…¥éç³»çµ±
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- è¡¨å–®æ§åˆ¶æŒ‰éˆ• -->
      <div class="form-controls-modern">
        <div class="controls-left">
          <div class="save-status" id="saveStatus" style="display: none;">
            <i class="bi bi-check-circle text-success me-1"></i>
            <span>è®Šæ›´å·²å„²å­˜</span>
          </div>
        </div>
        
        <div class="controls-right">
          <button type="button" class="btn-modern btn-outline-modern" id="cancelBtn">
            <i class="bi bi-x"></i>
            <span>å–æ¶ˆ</span>
          </button>
          
          <button type="submit" class="btn-modern btn-primary-modern" id="saveBtn">
            <i class="bi bi-check-circle"></i>
            <span>å„²å­˜è®Šæ›´</span>
            <div class="loading-spinner-modern"></div>
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- å¹«åŠ©æç¤ºå€åŸŸ -->
  <div class="help-section-modern">
    <h6 class="help-title">
      <i class="bi bi-lightbulb"></i>
      ç·¨è¼¯é†«å¸«æ³¨æ„äº‹é …
    </h6>
    
    <div class="row">
      <div class="col-md-6">
        <ul class="help-list">
          <li class="help-item">
            <strong>åŸºæœ¬è³‡æ–™ï¼š</strong>ä¿®æ”¹ä¿¡ç®±å¾Œé†«å¸«æœƒæ”¶åˆ°é€šçŸ¥
          </li>
          <li class="help-item">
            <strong>åŸ·ç…§é©—è­‰ï¼š</strong>å·²é©—è­‰çš„åŸ·ç…§æœƒè‡ªå‹•éš±è—è™Ÿç¢¼ä¿è­·éš±ç§
          </li>
          <li class="help-item">
            <strong>æ¬Šé™è®Šæ›´ï¼š</strong>è®Šæ›´æœƒç«‹å³ç”Ÿæ•ˆï¼Œè«‹è¬¹æ…æ“ä½œ
          </li>
        </ul>
      </div>
      
      <div class="col-md-6">
        <ul class="help-list">
          <li class="help-item">
            <strong>ç®¡ç†å“¡èº«ä»½ï¼š</strong>å¯èˆ‡åŸ·æ¥­é†«å¸«èº«ä»½ä¸¦å­˜
          </li>
          <li class="help-item">
            <strong>å¸³è™Ÿç‹€æ…‹ï¼š</strong>åœç”¨å¸³è™Ÿä¸æœƒåˆªé™¤è³‡æ–™
          </li>
          <li class="help-item">
            <strong>è‡ªå‹•å„²å­˜ï¼š</strong>è¡¨å–®æœƒè‡ªå‹•å„²å­˜æ‚¨çš„è®Šæ›´
          </li>
        </ul>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/clinic/edit-doctor.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ¯ ç·¨è¼¯é†«å¸«é é¢è¼‰å…¥å®Œæˆ');
  
  // åˆå§‹åŒ–é†«å¸«è³‡æ–™ï¼ˆéš±ç§ä¿è­·ï¼‰
  window.doctorData = {
    id: {{ doctor.id }},
    isActive: {{ doctor.is_active|yesno:"true,false" }},
    isVerified: {{ doctor.license_verified_with_moa|yesno:"true,false" }},
    isAdmin: {{ doctor.is_clinic_admin|yesno:"true,false" }},
    name: '{% if doctor.user.first_name %}{{ doctor.user.first_name|escapejs }}{% else %}{{ doctor.user.username|escapejs }}{% endif %}',
    email: '{{ doctor.user.email|escapejs }}',
    // éš±ç§ä¿è­·ï¼šåªåœ¨å·²é©—è­‰ä¸”éœ€è¦æ™‚æ‰åŒ…å«åŸ·ç…§è™Ÿç¢¼
    {% if doctor.license_verified_with_moa and doctor.vet_license_number %}
    licenseNumber: '{{ doctor.vet_license_number|escapejs }}',
    licenseNumberMasked: '{{ doctor.vet_license_number|slice:":2"|escapejs }}****{{ doctor.vet_license_number|slice:"-2:"|escapejs }}',
    {% else %}
    licenseNumber: '{% if doctor.vet_license_number %}{{ doctor.vet_license_number|escapejs }}{% endif %}',
    licenseNumberMasked: '',
    {% endif %}
    verificationDate: '{% if doctor.verification_date %}{{ doctor.verification_date|date:"Yå¹´mæœˆdæ—¥ H:i"|escapejs }}{% elif doctor.license_verified_with_moa %}{{ doctor.updated_at|date:"Yå¹´mæœˆdæ—¥ H:i"|escapejs }}{% endif %}'
  };
  
  // é¡¯ç¤ºè¡¨å–®éŒ¯èª¤ï¼ˆå¦‚æœæœ‰ï¼‰
  {% if form.errors %}
    {% for field, errors in form.errors.items %}
      {% for error in errors %}
        showFieldError('{{ field|escapejs }}', '{{ error|escapejs }}');
      {% endfor %}
    {% endfor %}
  {% endif %}
  
  // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
  {% if messages %}
    {% for message in messages %}
      {% if message.tags == 'success' %}
        showSuccessMessage('{{ message|escapejs }}');
      {% elif message.tags == 'error' %}
        showErrorMessage('{{ message|escapejs }}');
      {% elif message.tags == 'info' %}
        showInfoMessage('{{ message|escapejs }}');
      {% endif %}
    {% endfor %}
  {% endif %}
});
</script>

<!-- ç„¡éšœç¤™æ”¯æ´ -->
<div id="aria-live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>
{% endblock %}