{% extends 'base.html' %}
{% load static %}

{% block title %}è¨ºæ‰€ç®¡ç†ä¸­å¿ƒ - {{ clinic.clinic_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clinic/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/clinic/business-hours.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
  
  <!-- è¨ºæ‰€è³‡è¨Šæ¨™é¡Œå€åŸŸ -->
  <div class="page-header-modern">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="page-title-modern">
          <i class="bi bi-hospital me-3"></i>
          è¨ºæ‰€ç®¡ç†ä¸­å¿ƒ
        </h1>
        
        <div class="clinic-info-header">
          <div class="clinic-avatar">
            <i class="bi bi-building"></i>
          </div>
          <div class="clinic-details">
            <div class="clinic-name">
              <span>{{ clinic.clinic_name }}</span>
              {% if clinic.is_verified %}
                <span class="verified-badge">
                  <i class="bi bi-patch-check"></i>
                  å·²é©—è­‰
                </span>
              {% endif %}
            </div>
            <div class="clinic-meta">
              <span><i class="bi bi-geo-alt me-1"></i><span data-clinic-address>{{ clinic.clinic_address }}</span></span>
              <span class="mx-2">â€¢</span>
              <span><i class="bi bi-telephone me-1"></i><span data-clinic-phone>{{ clinic.clinic_phone }}</span></span>
              <span class="mx-2">â€¢</span>
              <span><i class="bi bi-envelope me-1"></i><span data-clinic-email>{{ clinic.clinic_email }}</span></span>
            </div>
            <div class="admin-info">
              <i class="bi bi-person-badge me-2"></i>
              <span>ç®¡ç†å“¡ï¼š{{ vet_profile.user.get_full_name|default:vet_profile.user.username }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="quick-actions">
          <div class="action-buttons-modern">
            <a href="{% url 'add_doctor' %}" class="btn-modern btn-primary-modern">
              <i class="bi bi-person-plus"></i>
              <span>æ–°å¢é†«å¸«</span>
            </a>
            <a href="{% url 'clinic_appointments' %}" class="btn-modern btn-secondary-modern">
              <i class="bi bi-calendar-check"></i>
              <span>ç®¡ç†é ç´„</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- çµ±è¨ˆæ•¸æ“šå€åŸŸ -->
  <div class="stats-section">
    <div class="row">
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stat-card stat-primary">
          <div class="stat-card-body">
            <div class="stat-content">
              <div class="stat-info">
                <h3 class="stat-number">{{ today_appointments }}</h3>
                <p class="stat-label">ä»Šæ—¥é ç´„</p>
              </div>
              <div class="stat-icon">
                <i class="bi bi-calendar-day"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stat-card stat-warning">
          <div class="stat-card-body">
            <div class="stat-content">
              <div class="stat-info">
                <h3 class="stat-number">{{ pending_appointments }}</h3>
                <p class="stat-label">å¾…ç¢ºèªé ç´„</p>
                <div class="stat-change">
                  {% if pending_appointments > 0 %}
                    <i class="bi bi-exclamation-circle"></i>
                    <span>éœ€è¦è™•ç†</span>
                  {% else %}
                    <i class="bi bi-check-circle"></i>
                    <span>å…¨éƒ¨å·²è™•ç†</span>
                  {% endif %}
                </div>
              </div>
              <div class="stat-icon">
                <i class="bi bi-hourglass-split"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stat-card stat-success">
          <div class="stat-card-body">
            <div class="stat-content">
              <div class="stat-info">
                <h3 class="stat-number">{{ doctors_count }}</h3>
                <p class="stat-label">é†«å¸«åœ˜éšŠ</p>
                <div class="stat-change">
                  <i class="bi bi-people"></i>
                  <span>æ´»èºé†«å¸«</span>
                </div>
              </div>
              <div class="stat-icon">
                <i class="bi bi-person-hearts"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stat-card stat-info">
          <div class="stat-card-body">
            <div class="stat-content">
              <div class="stat-info">
                <h3 class="stat-number">{{ total_appointments_this_month }}</h3>
                <p class="stat-label">æœ¬æœˆç¸½é ç´„</p>
              </div>
              <div class="stat-icon">
                <i class="bi bi-bar-chart"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»è¦åŠŸèƒ½å€åŸŸ -->
  <div class="main-content-section">
    <div class="row">
      
      <!-- å·¦å´ï¼šç®¡ç†åŠŸèƒ½ -->
      <div class="col-lg-8">
        
        <!-- ç®¡ç†åŠŸèƒ½å¡ç‰‡ -->
        <div class="management-section">
          <h2 class="section-title">
            <i class="bi bi-gear me-2"></i>
            è¨ºæ‰€ç®¡ç†
          </h2>
          
          <div class="row">
            <!-- é†«å¸«ç®¡ç† -->
            <div class="col-md-6 mb-4">
              <div class="feature-card">
                <div class="feature-icon doctor-icon">
                  <i class="bi bi-people"></i>
                </div>
                <div class="feature-content">
                  <h4 class="feature-title">é†«å¸«ç®¡ç†</h4>
                  <p class="feature-description">æ–°å¢ã€ç·¨è¼¯é†«å¸«è³‡æ–™ï¼ŒåŸ·ç…§é©—è­‰ç®¡ç†</p>
                  <div class="feature-stats">
                    <span class="stat-item">
                      <strong>{{ doctors_count }}</strong> ä½é†«å¸«
                    </span>
                  </div>
                </div>
                <div class="feature-actions">
                  <a href="{% url 'manage_doctors' %}" class="btn-feature btn-primary">
                    <i class="bi bi-arrow-right"></i>
                    ç®¡ç†é†«å¸«
                  </a>
                </div>
              </div>
            </div>
            
            <!-- æ’ç­ç®¡ç† -->
            <div class="col-md-6 mb-4">
              <div class="feature-card">
                <div class="feature-icon schedule-icon">
                  <i class="bi bi-calendar3"></i>
                </div>
                <div class="feature-content">
                  <h4 class="feature-title">æ’ç­ç®¡ç†</h4>
                  <p class="feature-description">è¨­å®šé†«å¸«æ’ç­æ™‚é–“ï¼Œç®¡ç†çœ‹è¨ºæ™‚æ®µ</p>
                  <div class="feature-stats">
                    <span class="stat-item">
                      <strong id="activeSchedulesCount">--</strong> å€‹æ’ç­
                    </span>
                  </div>
                </div>
                <div class="feature-actions">
                  <a href="{% url 'manage_schedules' %}" class="btn-feature btn-success">
                    <i class="bi bi-arrow-right"></i>
                    ç®¡ç†æ’ç­
                  </a>
                </div>
              </div>
            </div>
            
            <!-- é ç´„ç®¡ç† -->
            <div class="col-md-6 mb-4">
              <div class="feature-card">
                <div class="feature-icon appointment-icon">
                  <i class="bi bi-calendar-check"></i>
                </div>
                <div class="feature-content">
                  <h4 class="feature-title">é ç´„ç®¡ç†</h4>
                  <p class="feature-description">æŸ¥çœ‹ã€ç¢ºèªã€å–æ¶ˆé ç´„ï¼Œé ç´„ç‹€æ…‹ç®¡ç†</p>
                  <div class="feature-stats">
                    <span class="stat-item">
                      <strong>{{ pending_appointments }}</strong> å¾…è™•ç†
                    </span>
                  </div>
                </div>
                <div class="feature-actions">
                  <a href="{% url 'clinic_appointments' %}" class="btn-feature btn-info">
                    <i class="bi bi-arrow-right"></i>
                    ç®¡ç†é ç´„
                  </a>
                </div>
              </div>
            </div>
            
            <!-- è¨ºæ‰€è¨­å®š -->
            <div class="col-md-6 mb-4">
              <div class="feature-card settings-card">
                <div class="feature-icon settings-icon">
                  <i class="bi bi-sliders"></i>
                </div>
                <div class="feature-content">
                  <h4 class="feature-title">è¨ºæ‰€è¨­å®š</h4>
                  <p class="feature-description">è¨ºæ‰€åŸºæœ¬è³‡æ–™ã€ç‡Ÿæ¥­æ™‚é–“è¨­å®š</p>
                  <div class="feature-stats">
                    <span class="stat-item">
                      {% if clinic.is_verified %}
                        <i class="bi bi-check-circle text-success"></i> å·²é©—è­‰
                      {% else %}
                        <i class="bi bi-hourglass text-warning"></i> å¾…é©—è­‰
                      {% endif %}
                    </span>
                  </div>
                </div>
                <div class="feature-actions">
                  <button type="button" class="btn-feature btn-secondary" id="settingsButton">
                    <i class="bi bi-arrow-right"></i>
                    è¨ºæ‰€è¨­å®š
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- è¿‘æœŸé ç´„åˆ—è¡¨ -->
        <div class="recent-appointments-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="bi bi-clock-history me-2"></i>
              è¿‘æœŸé ç´„
            </h2>
            <a href="{% url 'clinic_appointments' %}" class="btn-link">
              æŸ¥çœ‹å…¨éƒ¨ <i class="bi bi-arrow-right"></i>
            </a>
          </div>
          
          <div class="appointments-list">
            <div class="appointments-card">
              <div class="appointments-header">
                <div class="date-selector">
                  <button class="date-btn active" data-date="today">
                    ä»Šæ—¥ ({{ today_appointments }})
                  </button>
                  <button class="date-btn" data-date="tomorrow">
                    æ˜æ—¥
                  </button>
                  <button class="date-btn" data-date="week">
                    æœ¬é€±
                  </button>
                </div>
              </div>
              
              <div class="appointments-body" id="appointmentsList">
                <!-- é ç´„åˆ—è¡¨å°‡ç”±JavaScriptå‹•æ…‹è¼‰å…¥ -->
              </div>
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- å³å´ï¼šå¿«é€Ÿè³‡è¨Š -->
      <div class="col-lg-4">
        
        <!-- è¨ºæ‰€ç‹€æ…‹ - ä¿®æ­£ç‰ˆï¼Œæ”¯æ´å¯¦æ™‚ç‡Ÿæ¥­ç‹€æ…‹ -->
        <div class="clinic-status-card">
          <h3 class="card-title">
            <i class="bi bi-activity me-2"></i>
            è¨ºæ‰€ç‹€æ…‹
          </h3>
          
          <div class="status-items">
            <div class="status-item">
              <div class="status-icon online">
                <i class="bi bi-circle-fill"></i>
              </div>
              <div class="status-content">
                <div class="status-label">ç³»çµ±ç‹€æ…‹</div>
                <div class="status-value">æ­£å¸¸é‹è¡Œ</div>
              </div>
            </div>
            
            <div class="status-item">
              <div class="status-icon">
                <i class="bi bi-calendar-event"></i>
              </div>
              <div class="status-content">
                <div class="status-label">ç‡Ÿæ¥­ç‹€æ…‹</div>
                <div class="status-value" id="businessStatus">
                  <span class="status-indicator"></span>
                  <span class="status-text">æª¢æŸ¥ä¸­...</span>
                </div>
              </div>
            </div>
            
            <div class="status-item">
              <div class="status-icon">
                <i class="bi bi-wifi"></i>
              </div>
              <div class="status-content">
                <div class="status-label">ç·šä¸Šé ç´„</div>
                <div class="status-value">
                  <span class="status-indicator online"></span>
                  é–‹æ”¾ä¸­
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="quick-actions-card">
          <h3 class="card-title">
            <i class="bi bi-lightning me-2"></i>
            å¿«é€Ÿæ“ä½œ
          </h3>
          
          <div class="quick-actions-list">
            <button class="quick-action-btn" onclick="showAddDoctorModal()">
              <div class="action-icon">
                <i class="bi bi-person-plus"></i>
              </div>
              <div class="action-content">
                <div class="action-title">æ–°å¢é†«å¸«</div>
                <div class="action-desc">æ–°å¢è¨ºæ‰€é†«å¸«æˆå“¡</div>
              </div>
            </button>
            
            <button class="quick-action-btn" onclick="showAddScheduleModal()">
              <div class="action-icon">
                <i class="bi bi-calendar-plus"></i>
              </div>
              <div class="action-content">
                <div class="action-title">æ–°å¢æ’ç­</div>
                <div class="action-desc">å¿«é€Ÿè¨­å®šçœ‹è¨ºæ™‚é–“</div>
              </div>
            </button>
            
            <button class="quick-action-btn" onclick="viewTodayAppointments()">
              <div class="action-icon">
                <i class="bi bi-list-check"></i>
              </div>
              <div class="action-content">
                <div class="action-title">ä»Šæ—¥é ç´„</div>
                <div class="action-desc">æŸ¥çœ‹ä»Šæ—¥æ‰€æœ‰é ç´„</div>
              </div>
            </button>
            
            <button class="quick-action-btn" onclick="showNotifications()">
              <div class="action-icon">
                <i class="bi bi-bell"></i>
              </div>
              <div class="action-content">
                <div class="action-title">é€šçŸ¥ä¸­å¿ƒ</div>
                <div class="action-desc">æŸ¥çœ‹ç³»çµ±é€šçŸ¥</div>
              </div>
            </button>
          </div>
        </div>
        
        <!-- ç³»çµ±æç¤º -->
        <div class="tips-card">
          <h3 class="card-title">
            <i class="bi bi-lightbulb me-2"></i>
            ä½¿ç”¨æç¤º
          </h3>
          
          <div class="tips-list">
            <div class="tip-item">
              <div class="tip-icon">
                <i class="bi bi-info-circle"></i>
              </div>
              <div class="tip-content">
                <strong>ç‡Ÿæ¥­æ™‚é–“ï¼š</strong>è¨­ç½®å®Œç‡Ÿæ¥­æ™‚é–“æœƒè‡ªå‹•å„²å­˜ï¼Œä¸¦å³æ™‚æ›´æ–°é¦–é çš„ç‡Ÿæ¥­ç‹€æ…‹é¡¯ç¤ºã€‚
              </div>
            </div>
            
            <div class="tip-item">
              <div class="tip-icon">
                <i class="bi bi-shield-check"></i>
              </div>
              <div class="tip-content">
                <strong>åŸ·ç…§é©—è­‰ï¼š</strong>æ–°å¢çš„é†«å¸«éœ€è¦å®ŒæˆåŸ·ç…§é©—è­‰æ‰èƒ½å¡«å¯«é†«ç™‚è¨˜éŒ„ã€‚
              </div>
            </div>
            
            <div class="tip-item">
              <div class="tip-icon">
                <i class="bi bi-envelope"></i>
              </div>
              <div class="tip-content">
                <strong>é ç´„é€šçŸ¥ï¼š</strong>ç³»çµ±æœƒè‡ªå‹•ç™¼é€ç¢ºèªä¿¡çµ¦é ç´„çš„ç—…æ‚£ã€‚
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- è¨ºæ‰€è¨­å®š Modal - ä¿®æ­£ç‰ˆ -->
  <div id="settingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h3>
                <i class="bi bi-gear me-2"></i>
                è¨ºæ‰€è¨­å®š
            </h3>
            <button class="modal-close" onclick="closeSettingsModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        
        <div class="modal-tabs-wrapper">
            <div class="settings-tabs">
                <button class="tab-btn active" data-tab="basic">
                    <i class="bi bi-info-circle me-2"></i>
                    åŸºæœ¬è³‡æ–™
                </button>
                <button class="tab-btn" data-tab="business">
                    <i class="bi bi-calendar-week me-2"></i>
                    ç‡Ÿæ¥­æ™‚é–“
                </button>
            </div>
        </div>
        
        <div class="modal-body-scrollable">
            <!-- åŸºæœ¬è³‡æ–™æ¨™ç±¤ -->
            <div class="tab-content active" id="basicTab">
                <form id="clinicSettingsForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>
                            <i class="bi bi-building me-2"></i>
                            è¨ºæ‰€åç¨±
                        </label>
                        <input type="text" class="form-control" value="{{ clinic.clinic_name }}" readonly>
                        <small class="form-text">è¨ºæ‰€åç¨±éœ€èˆ‡è¾²å§”æœƒç™»è¨˜ä¸€è‡´ï¼Œç„¡æ³•ä¿®æ”¹</small>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <i class="bi bi-telephone me-2"></i>
                            è¨ºæ‰€é›»è©±
                        </label>
                        <input type="tel" class="form-control" value="{{ clinic.clinic_phone }}" name="clinic_phone">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <i class="bi bi-envelope me-2"></i>
                            è¨ºæ‰€ä¿¡ç®±
                        </label>
                        <input type="email" class="form-control" value="{{ clinic.clinic_email }}" name="clinic_email">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <i class="bi bi-geo-alt me-2"></i>
                            è¨ºæ‰€åœ°å€
                        </label>
                        <textarea class="form-control" name="clinic_address" rows="2">{{ clinic.clinic_address }}</textarea>
                    </div>
                </form>
            </div>
            
            <!-- ç‡Ÿæ¥­æ™‚é–“è¨­å®šæ¨™ç±¤å…§å®¹ - ä¿®æ­£ç‰ˆ -->
            <div class="tab-content" id="businessTab">
              <div class="business-hours-container">
                  <div class="business-hours-header">
                      <h5 class="section-title">
                          <i class="bi bi-calendar-week me-2"></i>
                          æ¯é€±ç‡Ÿæ¥­æ™‚é–“è¨­å®š
                      </h5>
                      <p class="section-description">
                          è¨­å®šè¨ºæ‰€æ¯å¤©çš„ç‡Ÿæ¥­æ™‚é–“ï¼Œå¯ä»¥ç‚ºæ¯å¤©æ–°å¢å¤šå€‹æ™‚æ®µã€‚
                          è¨­å®šå®Œæˆå¾Œæœƒè‡ªå‹•å„²å­˜ï¼Œä¸¦åŒæ­¥æ›´æ–°é¦–é çš„ç‡Ÿæ¥­ç‹€æ…‹é¡¯ç¤ºã€‚
                      </p>
                  </div>
                  
                  <div class="business-hours-editor">
                      <div class="days-container" id="businessHoursDays">
                          <!-- å¤©æ•¸å¡ç‰‡å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                      </div>
                  </div>

                  <!-- ç‡Ÿæ¥­æ™‚é–“é è¦½ -->
                  <div class="business-hours-preview">
                      <h6 class="preview-title">
                          <i class="bi bi-eye me-2"></i>
                          ç‡Ÿæ¥­æ™‚é–“ç¸½è¦½
                      </h6>
                      <div class="preview-content" id="businessHoursPreview">
                          <!-- é è¦½å…§å®¹å°‡ç”± JavaScript ç”Ÿæˆ -->
                      </div>
                  </div>
              </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn-modern btn-outline-modern" onclick="closeSettingsModal()">
                <i class="bi bi-x me-2"></i>
                å–æ¶ˆ
            </button>
            <button type="button" class="btn-modern btn-primary-modern" onclick="saveClinicSettings()">
                <i class="bi bi-check me-2"></i>
                å„²å­˜è¨­å®š
            </button>
        </div>
    </div>
  </div>
</div>

<!-- éš±è—çš„ CSRF Token -->
<form id="ajaxForm" style="display: none;">
  {% csrf_token %}
</form>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/clinic/dashboard.js' %}"></script>
<script src="{% static 'js/clinic/business-hours.js' %}"></script>
<script>
// å‚³é Django æ•¸æ“šåˆ° JavaScript
window.dashboardData = {
  clinic: {
    id: {{ clinic.id }},
    name: '{{ clinic.clinic_name|escapejs }}',
    phone: '{{ clinic.clinic_phone|escapejs }}',
    email: '{{ clinic.clinic_email|escapejs }}',
    address: '{{ clinic.clinic_address|escapejs }}',
    isVerified: {{ clinic.is_verified|yesno:"true,false" }}
  },
  stats: {
    todayAppointments: {{ today_appointments }},
    pendingAppointments: {{ pending_appointments }},
    doctorsCount: {{ doctors_count }},
    totalAppointmentsThisMonth: {{ total_appointments_this_month }}
  },
  urls: {
    appointments: '{% url "clinic_appointments" %}',
    doctors: '{% url "manage_doctors" %}',
    schedules: '{% url "manage_schedules"%}', 
    addDoctor: '{% url "add_doctor" %}'
  },
  csrfToken: '{{ csrf_token }}'
};

// é¡¯ç¤ºè¨Šæ¯
{% if messages %}
  {% for message in messages %}
    {% if message.tags == 'success' %}
      showSuccessMessage('{{ message|escapejs }}');
    {% elif message.tags == 'error' %}
      showErrorMessage('{{ message|escapejs }}');
    {% elif message.tags == 'warning' %}
      showWarningMessage('{{ message|escapejs }}');
    {% endif %}
  {% endfor %}
{% endif %}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„èª¿è©¦æª¢æŸ¥
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”„ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è¨ºæ–·...');
    
    // æª¢æŸ¥é—œéµå…ƒç´ 
    const settingsButton = document.getElementById('settingsButton');
    const settingsModal = document.getElementById('settingsModal');
    const businessContainer = document.getElementById('businessHoursDays');
    
    console.log('âœ… é—œéµå…ƒç´ æª¢æŸ¥ï¼š');
    console.log('  - è¨­å®šæŒ‰éˆ•:', settingsButton ? 'å­˜åœ¨' : 'âŒ ç¼ºå¤±');
    console.log('  - è¨­å®šModal:', settingsModal ? 'å­˜åœ¨' : 'âŒ ç¼ºå¤±');
    console.log('  - ç‡Ÿæ¥­æ™‚é–“å®¹å™¨:', businessContainer ? 'å­˜åœ¨' : 'âŒ ç¼ºå¤±');
    
    // å¦‚æœæŒ‰éˆ•å­˜åœ¨ä½†æ²’æœ‰äº‹ä»¶ï¼Œæ‰‹å‹•æ·»åŠ 
    if (settingsButton && typeof showSettingsModal === 'function') {
        // ç§»é™¤å¯èƒ½çš„èˆŠäº‹ä»¶
        const newButton = settingsButton.cloneNode(true);
        settingsButton.parentNode.replaceChild(newButton, settingsButton);
        
        // æ·»åŠ æ–°äº‹ä»¶
        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ğŸ”§ é»æ“Šè¨ºæ‰€è¨­å®š');
            showSettingsModal();
        });
        
        console.log('ğŸ”§ å·²æ‰‹å‹•æ·»åŠ è¨­å®šæŒ‰éˆ•äº‹ä»¶');
    }
});

// å…¼å®¹æ€§å‡½æ•¸ï¼ˆä¿ç•™åŸæœ‰å‡½æ•¸åï¼‰
function applyQuickSettings() {
    console.log('âš ï¸ å¿«é€Ÿè¨­å®šåŠŸèƒ½å·²ç§»é™¤ï¼Œè«‹ä½¿ç”¨å€‹åˆ¥å¤©æ•¸è¨­å®š');
}

function clearAllSchedules() {
    console.log('âš ï¸ æ¸…é™¤å…¨éƒ¨åŠŸèƒ½å·²ç§»é™¤');
}

function setMorningAfternoonSchedule() {
    console.log('ğŸ“… è¨­å®šä¸Šä¸‹åˆåˆ†æ®µç‡Ÿæ¥­æ™‚é–“');
    
    if (typeof businessHours !== 'undefined') {
        for (let day = 0; day < 5; day++) {
            businessHours.data[day] = [];
            
            // é–‹å•Ÿè©²å¤©ç‡Ÿæ¥­
            const checkbox = document.querySelector(`.day-card[data-day="${day}"] input[type="checkbox"]`);
            const toggleText = document.querySelector(`.day-card[data-day="${day}"] .toggle-text`);
            const dayCard = document.querySelector(`.day-card[data-day="${day}"]`);
            
            if (checkbox && toggleText && dayCard) {
                checkbox.checked = true;
                toggleText.textContent = 'ç‡Ÿæ¥­';
                dayCard.classList.add('active');
            }
            
            // æ·»åŠ ä¸Šåˆæ™‚æ®µ
            businessHours.addPeriod(day, '09:00', '12:00');
            // æ·»åŠ ä¸‹åˆæ™‚æ®µ
            businessHours.addPeriod(day, '14:00', '17:00');
        }
        
        businessHours.updatePreview();
        if (typeof showSuccessMessage === 'function') {
            showSuccessMessage('å·²è¨­å®šé€±ä¸€åˆ°é€±äº”ä¸Šä¸‹åˆåˆ†æ®µç‡Ÿæ¥­æ™‚é–“');
        }
    }
}

function setCommonClinicHours() {
    if (typeof businessHours !== 'undefined') {
        // é€±ä¸€åˆ°é€±äº”ï¼šä¸Šåˆ 09:00-12:00ï¼Œä¸‹åˆ 14:00-17:00
        for (let day = 0; day < 5; day++) {
            // æ¸…ç©ºç¾æœ‰æ•¸æ“š
            businessHours.data[day] = [];
            
            // é–‹å•Ÿç‡Ÿæ¥­
            const checkbox = document.querySelector(`.day-card[data-day="${day}"] input[type="checkbox"]`);
            const toggleText = document.querySelector(`.day-card[data-day="${day}"] .toggle-text`);
            const dayCard = document.querySelector(`.day-card[data-day="${day}"]`);
            
            if (checkbox && toggleText && dayCard) {
                checkbox.checked = true;
                toggleText.textContent = 'ç‡Ÿæ¥­';
                dayCard.classList.add('active');
            }
            
            // æ·»åŠ ä¸Šåˆæ™‚æ®µ
            businessHours.addPeriod(day, '09:00', '12:00');
            // æ·»åŠ ä¸‹åˆæ™‚æ®µ
            businessHours.addPeriod(day, '14:00', '17:00');
        }
        
        // é€±å…­åŠå¤©
        businessHours.data[5] = [];
        const satCheckbox = document.querySelector(`.day-card[data-day="5"] input[type="checkbox"]`);
        const satToggleText = document.querySelector(`.day-card[data-day="5"] .toggle-text`);
        const satDayCard = document.querySelector(`.day-card[data-day="5"]`);
        
        if (satCheckbox && satToggleText && satDayCard) {
            satCheckbox.checked = true;
            satToggleText.textContent = 'ç‡Ÿæ¥­';
            satDayCard.classList.add('active');
        }
        
        businessHours.addPeriod(5, '09:00', '12:00');
        
        // é€±æ—¥ä¼‘æ¯ï¼ˆé»˜èªå·²ç¶“æ˜¯ä¼‘æ¯ç‹€æ…‹ï¼‰
        businessHours.data[6] = [];
        
        if (typeof showSuccessMessage === 'function') {
            showSuccessMessage('å·²è¨­å®šå¸¸è¦‹è¨ºæ‰€ç‡Ÿæ¥­æ™‚é–“');
        }
    }
}

function initializeSettingsTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // ç§»é™¤æ‰€æœ‰æ´»èºç‹€æ…‹
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // è¨­å®šç•¶å‰æ´»èºç‹€æ…‹
            this.classList.add('active');
            
            const targetContent = document.getElementById(targetTab + 'Tab');
            if (targetContent) {
                targetContent.classList.add('active');
                
                // å¦‚æœæ˜¯ç‡Ÿæ¥­æ™‚é–“æ¨™ç±¤ï¼Œå»¶é²åˆå§‹åŒ–ä»¥ç¢ºä¿DOMå°±ç·’
                if (targetTab === 'business') {
                    console.log('ğŸ•˜ åˆ‡æ›åˆ°ç‡Ÿæ¥­æ™‚é–“æ¨™ç±¤ï¼Œé–‹å§‹åˆå§‹åŒ–...');
                    setTimeout(() => {
                        if (typeof businessHours !== 'undefined') {
                            businessHours.initialize();
                        } else if (typeof initializeBusinessHours === 'function') {
                            initializeBusinessHours();
                        } else {
                            console.error('âŒ businessHours ç‰©ä»¶æœªæ‰¾åˆ°');
                        }
                    }, 150); // æ¸›å°‘å»¶é²æ™‚é–“
                }
            }
        });
    });
}

// å„²å­˜è¨ºæ‰€è¨­å®šå‡½æ•¸
function saveClinicSettings() {
    console.log('ğŸ’¾ å„²å­˜è¨ºæ‰€è¨­å®š...');
    
    const activeTab = document.querySelector('.tab-btn.active');
    if (!activeTab) {
        showErrorMessage('è«‹é¸æ“‡è¦å„²å­˜çš„è¨­å®šåˆ†é¡');
        return;
    }
    
    const tabType = activeTab.dataset.tab;
    
    switch(tabType) {
        case 'basic':
            saveBasicSettings();
            break;
        case 'business':
            if (typeof businessHours !== 'undefined') {
                const result = businessHours.save();
                if (result) {
                    // è¨­å®šå„²å­˜æˆåŠŸå¾Œé—œé–‰ Modal
                    setTimeout(() => {
                        closeSettingsModal();
                    }, 1500);
                }
            } else {
                showErrorMessage('ç‡Ÿæ¥­æ™‚é–“ç³»çµ±å°šæœªè¼‰å…¥');
            }
            break;
        default:
            showErrorMessage('æœªçŸ¥çš„è¨­å®šé¡å‹');
    }
}

function saveBasicSettings() {
    console.log('ğŸ’¾ å„²å­˜åŸºæœ¬è¨­å®š...');
    
    const form = document.getElementById('clinicSettingsForm');
    if (!form) {
        showErrorMessage('æ‰¾ä¸åˆ°è¨­å®šè¡¨å–®');
        return;
    }
    
    const formData = new FormData(form);
    const data = {
        clinic_phone: formData.get('clinic_phone'),
        clinic_email: formData.get('clinic_email'),
        clinic_address: formData.get('clinic_address')
    };
    
    // ç°¡å–®é©—è­‰
    if (!data.clinic_phone || !data.clinic_email) {
        showErrorMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    showSaveLoading(true);
    
    // æš«æ™‚æ¨¡æ“¬æˆåŠŸ
    setTimeout(() => {
        showSaveLoading(false);
        showSuccessMessage('åŸºæœ¬è¨­å®šå·²æ›´æ–°');
        updateClinicInfo(data);
        setTimeout(() => {
            closeSettingsModal();
        }, 1000);
    }, 1500);
}

function updateClinicInfo(data) {
    try {
        // æ›´æ–°é›»è©±é¡¯ç¤º
        const phoneElement = document.querySelector('[data-clinic-phone]');
        if (phoneElement) {
            phoneElement.textContent = data.clinic_phone;
        }
        
        // æ›´æ–°ä¿¡ç®±é¡¯ç¤º
        const emailElement = document.querySelector('[data-clinic-email]');
        if (emailElement) {
            emailElement.textContent = data.clinic_email;
        }
        
        // æ›´æ–°åœ°å€é¡¯ç¤º
        const addressElement = document.querySelector('[data-clinic-address]');
        if (addressElement) {
            addressElement.textContent = data.clinic_address;
        }
        
        console.log('âœ… è¨ºæ‰€è³‡è¨Šé¡¯ç¤ºå·²æ›´æ–°');
    } catch (error) {
        console.error('âŒ æ›´æ–°è¨ºæ‰€è³‡è¨Šé¡¯ç¤ºå¤±æ•—:', error);
    }
}

// é¡¯ç¤ºå„²å­˜è¼‰å…¥ç‹€æ…‹
function showSaveLoading(show) {
    const saveButton = document.querySelector('.modal-footer .btn-primary-modern');
    if (!saveButton) return;
    
    if (show) {
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i> å„²å­˜ä¸­...';
        saveButton.style.pointerEvents = 'none';
    } else {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="bi bi-check me-2"></i> å„²å­˜è¨­å®š';
        saveButton.style.pointerEvents = 'auto';
    }
}

// å°å‡ºå¿…è¦çš„å…¨åŸŸå‡½æ•¸
window.saveClinicSettings = saveClinicSettings;
window.initializeSettingsTabs = initializeSettingsTabs;
window.applyQuickSettings = applyQuickSettings;
window.clearAllSchedules = clearAllSchedules;
window.setMorningAfternoonSchedule = setMorningAfternoonSchedule;
window.setCommonClinicHours = setCommonClinicHours;

console.log('âœ… ä¿®æ­£ç‰ˆè¨ºæ‰€ç®¡ç†é é¢è¼‰å…¥å®Œæˆï¼ˆæ”¯æ´ç‡Ÿæ¥­æ™‚é–“å„²å­˜å’Œç‹€æ…‹åŒæ­¥ï¼‰');
</script>
{% endblock %}