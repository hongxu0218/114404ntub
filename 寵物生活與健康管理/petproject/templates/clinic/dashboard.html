{% extends 'base.html' %}
{% load static %}

{% block title %}診所管理中心 - {{ clinic.clinic_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clinic/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/clinic/business-hours.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
  
  <!-- 診所資訊標題區域 -->
  <div class="page-header-modern">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="page-title-modern">
          <i class="bi bi-hospital me-3"></i>
          診所管理中心
        </h1>
        
        <div class="clinic-info-header">
          <div class="clinic-avatar">
            <i class="bi bi-building"></i>
          </div>
          <div class="clinic-details">
            <div class="clinic-name">
              <span>{{ clinic.clinic_name }}</span>
              {% if clinic.is_verified %}
                <span class="verified-badge">
                  <i class="bi bi-patch-check"></i>
                  已驗證
                </span>
              {% endif %}
            </div>
            <div class="clinic-meta">
              <span><i class="bi bi-geo-alt me-1"></i>{{ clinic.clinic_address }}</span>
              <span class="mx-2">•</span>
              <span><i class="bi bi-telephone me-1"></i>{{ clinic.clinic_phone }}</span>
              <span class="mx-2">•</span>
              <span><i class="bi bi-envelope me-1"></i>{{ clinic.clinic_email }}</span>
            </div>
            <div class="admin-info">
              <i class="bi bi-person-badge me-2"></i>
              <span>管理員：{{ vet_profile.user.get_full_name|default:vet_profile.user.username }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="quick-actions">
          <div class="action-buttons-modern">
            <a href="{% url 'add_doctor' %}" class="btn-modern btn-primary-modern">
              <i class="bi bi-person-plus"></i>
              <span>新增醫師</span>
            </a>
            <a href="{% url 'clinic_appointments' %}" class="btn-modern btn-secondary-modern">
              <i class="bi bi-calendar-check"></i>
              <span>管理預約</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 統計數據區域 -->
  <div class="stats-section">
    <div class="row">
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stat-card stat-primary">
          <div class="stat-card-body">
            <div class="stat-content">
              <div class="stat-info">
                <h3 class="stat-number">{{ today_appointments }}</h3>
                <p class="stat-label">今日預約</p>
              </div>
              <div class="stat-icon">
                <i class="bi bi-calendar-day"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stat-card stat-warning">
          <div class="stat-card-body">
            <div class="stat-content">
              <div class="stat-info">
                <h3 class="stat-number">{{ pending_appointments }}</h3>
                <p class="stat-label">待確認預約</p>
                <div class="stat-change">
                  {% if pending_appointments > 0 %}
                    <i class="bi bi-exclamation-circle"></i>
                    <span>需要處理</span>
                  {% else %}
                    <i class="bi bi-check-circle"></i>
                    <span>全部已處理</span>
                  {% endif %}
                </div>
              </div>
              <div class="stat-icon">
                <i class="bi bi-hourglass-split"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stat-card stat-success">
          <div class="stat-card-body">
            <div class="stat-content">
              <div class="stat-info">
                <h3 class="stat-number">{{ doctors_count }}</h3>
                <p class="stat-label">醫師團隊</p>
                <div class="stat-change">
                  <i class="bi bi-people"></i>
                  <span>活躍醫師</span>
                </div>
              </div>
              <div class="stat-icon">
                <i class="bi bi-person-hearts"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="stat-card stat-info">
          <div class="stat-card-body">
            <div class="stat-content">
              <div class="stat-info">
                <h3 class="stat-number">{{ total_appointments_this_month }}</h3>
                <p class="stat-label">本月總預約</p>
              </div>
              <div class="stat-icon">
                <i class="bi bi-bar-chart"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 主要功能區域 -->
  <div class="main-content-section">
    <div class="row">
      
      <!-- 左側：管理功能 -->
      <div class="col-lg-8">
        
        <!-- 管理功能卡片 -->
        <div class="management-section">
          <h2 class="section-title">
            <i class="bi bi-gear me-2"></i>
            診所管理
          </h2>
          
          <div class="row">
            <!-- 醫師管理 -->
            <div class="col-md-6 mb-4">
              <div class="feature-card">
                <div class="feature-icon doctor-icon">
                  <i class="bi bi-people"></i>
                </div>
                <div class="feature-content">
                  <h4 class="feature-title">醫師管理</h4>
                  <p class="feature-description">新增、編輯醫師資料，執照驗證管理</p>
                  <div class="feature-stats">
                    <span class="stat-item">
                      <strong>{{ doctors_count }}</strong> 位醫師
                    </span>
                  </div>
                </div>
                <div class="feature-actions">
                  <a href="{% url 'manage_doctors' %}" class="btn-feature btn-primary">
                    <i class="bi bi-arrow-right"></i>
                    管理醫師
                  </a>
                </div>
              </div>
            </div>
            
            <!-- 排班管理 -->
            <div class="col-md-6 mb-4">
              <div class="feature-card">
                <div class="feature-icon schedule-icon">
                  <i class="bi bi-calendar3"></i>
                </div>
                <div class="feature-content">
                  <h4 class="feature-title">排班管理</h4>
                  <p class="feature-description">設定醫師排班時間，管理看診時段</p>
                  <div class="feature-stats">
                    <span class="stat-item">
                      <strong id="activeSchedulesCount">--</strong> 個排班
                    </span>
                  </div>
                </div>
                <div class="feature-actions">
                  <a href="{% url 'manage_schedules' %}" class="btn-feature btn-success">
                    <i class="bi bi-arrow-right"></i>
                    管理排班
                  </a>
                </div>
              </div>
            </div>
            
            <!-- 預約管理 -->
            <div class="col-md-6 mb-4">
              <div class="feature-card">
                <div class="feature-icon appointment-icon">
                  <i class="bi bi-calendar-check"></i>
                </div>
                <div class="feature-content">
                  <h4 class="feature-title">預約管理</h4>
                  <p class="feature-description">查看、確認、取消預約，預約狀態管理</p>
                  <div class="feature-stats">
                    <span class="stat-item">
                      <strong>{{ pending_appointments }}</strong> 待處理
                    </span>
                  </div>
                </div>
                <div class="feature-actions">
                  <a href="{% url 'clinic_appointments' %}" class="btn-feature btn-info">
                    <i class="bi bi-arrow-right"></i>
                    管理預約
                  </a>
                </div>
              </div>
            </div>
            
            <!-- 診所設定 -->
            <div class="col-md-6 mb-4">
              <div class="feature-card">
                <div class="feature-icon settings-icon">
                  <i class="bi bi-sliders"></i>
                </div>
                <div class="feature-content">
                  <h4 class="feature-title">診所設定</h4>
                  <p class="feature-description">診所基本資料、營業時間設定</p>
                  <div class="feature-stats">
                    <span class="stat-item">
                      {% if clinic.is_verified %}
                        <i class="bi bi-check-circle text-success"></i> 已驗證
                      {% else %}
                        <i class="bi bi-hourglass text-warning"></i> 待驗證
                      {% endif %}
                    </span>
                  </div>
                </div>
                <div class="feature-actions">
                  <button class="btn-feature btn-secondary" onclick="showSettingsModal()">
                    <i class="bi bi-arrow-right"></i>
                    診所設定
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 近期預約列表 -->
        <div class="recent-appointments-section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="bi bi-clock-history me-2"></i>
              近期預約
            </h2>
            <a href="{% url 'clinic_appointments' %}" class="btn-link">
              查看全部 <i class="bi bi-arrow-right"></i>
            </a>
          </div>
          
          <div class="appointments-list">
            <div class="appointments-card">
              <div class="appointments-header">
                <div class="date-selector">
                  <button class="date-btn active" data-date="today">
                    今日 ({{ today_appointments }})
                  </button>
                  <button class="date-btn" data-date="tomorrow">
                    明日
                  </button>
                  <button class="date-btn" data-date="week">
                    本週
                  </button>
                </div>
              </div>
              
              <div class="appointments-body" id="appointmentsList">
                <!-- 預約列表將由JavaScript動態載入 -->
              </div>
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- 右側：快速資訊 -->
      <div class="col-lg-4">
        
        <!-- 診所狀態 -->
        <div class="clinic-status-card">
          <h3 class="card-title">
            <i class="bi bi-activity me-2"></i>
            診所狀態
          </h3>
          
          <div class="status-items">
            <div class="status-item">
              <div class="status-icon online">
                <i class="bi bi-circle-fill"></i>
              </div>
              <div class="status-content">
                <div class="status-label">系統狀態</div>
                <div class="status-value">正常運行</div>
              </div>
            </div>
            
            <div class="status-item">
              <div class="status-icon">
                <i class="bi bi-calendar-event"></i>
              </div>
              <div class="status-content">
                <div class="status-label">營業狀態</div>
                <div class="status-value" id="businessStatus">
                  <span class="status-indicator"></span>
                  <span class="status-text">檢查中...</span>
                </div>
              </div>
            </div>
            
            <div class="status-item">
              <div class="status-icon">
                <i class="bi bi-wifi"></i>
              </div>
              <div class="status-content">
                <div class="status-label">線上預約</div>
                <div class="status-value">
                  <span class="status-indicator online"></span>
                  開放中
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 快速操作 -->
        <div class="quick-actions-card">
          <h3 class="card-title">
            <i class="bi bi-lightning me-2"></i>
            快速操作
          </h3>
          
          <div class="quick-actions-list">
            <button class="quick-action-btn" onclick="showAddDoctorModal()">
              <div class="action-icon">
                <i class="bi bi-person-plus"></i>
              </div>
              <div class="action-content">
                <div class="action-title">新增醫師</div>
                <div class="action-desc">新增診所醫師成員</div>
              </div>
            </button>
            
            <button class="quick-action-btn" onclick="showAddScheduleModal()">
              <div class="action-icon">
                <i class="bi bi-calendar-plus"></i>
              </div>
              <div class="action-content">
                <div class="action-title">新增排班</div>
                <div class="action-desc">快速設定看診時間</div>
              </div>
            </button>
            
            <button class="quick-action-btn" onclick="viewTodayAppointments()">
              <div class="action-icon">
                <i class="bi bi-list-check"></i>
              </div>
              <div class="action-content">
                <div class="action-title">今日預約</div>
                <div class="action-desc">查看今日所有預約</div>
              </div>
            </button>
            
            <button class="quick-action-btn" onclick="showNotifications()">
              <div class="action-icon">
                <i class="bi bi-bell"></i>
              </div>
              <div class="action-content">
                <div class="action-title">通知中心</div>
                <div class="action-desc">查看系統通知</div>
              </div>
            </button>
          </div>
        </div>
        
        <!-- 系統提示 -->
        <div class="tips-card">
          <h3 class="card-title">
            <i class="bi bi-lightbulb me-2"></i>
            使用提示
          </h3>
          
          <div class="tips-list">
            <div class="tip-item">
              <div class="tip-icon">
                <i class="bi bi-info-circle"></i>
              </div>
              <div class="tip-content">
                <strong>排班設定：</strong>建議提前設定未來兩週的排班，讓病患能提前預約。
              </div>
            </div>
            
            <div class="tip-item">
              <div class="tip-icon">
                <i class="bi bi-shield-check"></i>
              </div>
              <div class="tip-content">
                <strong>執照驗證：</strong>新增的醫師需要完成執照驗證才能填寫醫療記錄。
              </div>
            </div>
            
            <div class="tip-item">
              <div class="tip-icon">
                <i class="bi bi-envelope"></i>
              </div>
              <div class="tip-content">
                <strong>預約通知：</strong>系統會自動發送確認信給預約的病患。
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- 診所設定 Modal -->
  <div id="settingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
      <div class="modal-header">
        <h3>診所設定</h3>
        <button class="modal-close" onclick="closeSettingsModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="settings-tabs">
          <button class="tab-btn active" data-tab="basic">基本資料</button>
          <button class="tab-btn" data-tab="business">營業時間</button>
          <button class="tab-btn" data-tab="notification">通知設定</button>
        </div>
        
        <div class="tab-content" id="basicTab">
          <form id="clinicSettingsForm">
            {% csrf_token %}
            <div class="form-group">
              <label>診所名稱</label>
              <input type="text" class="form-control" value="{{ clinic.clinic_name }}" readonly>
              <small class="form-text">診所名稱需與農委會登記一致，無法修改</small>
            </div>
            
            <div class="form-group">
              <label>診所電話</label>
              <input type="tel" class="form-control" value="{{ clinic.clinic_phone }}" name="clinic_phone">
            </div>
            
            <div class="form-group">
              <label>診所信箱</label>
              <input type="email" class="form-control" value="{{ clinic.clinic_email }}" name="clinic_email">
            </div>
            
            <div class="form-group">
              <label>診所地址</label>
              <textarea class="form-control" name="clinic_address" rows="2">{{ clinic.clinic_address }}</textarea>
            </div>
          </form>
        </div>
        
        <!-- 營業時間設定標籤頁內容 --->
        <div class="tab-content" id="businessTab" style="display: none;">
          <div class="business-hours-container">
            
            <!-- 營業時間編輯區域 -->
            <div class="business-hours-editor">
              <div class="editor-header mb-4">
                <h5 class="mb-2">
                  <i class="bi bi-calendar-week me-2"></i>
                  每週營業時間設定
                </h5>
                <p class="text-muted mb-0">設定診所每天的營業時間，可以為每天新增多個時段</p>
              </div>
              
              <div class="days-container">
                <!-- 週一到週日的設定 -->
                <div class="day-card" data-day="0">
                  <div class="day-header">
                    <div class="day-info">
                      <h6 class="day-name">週一</h6>
                      <div class="day-status">
                        <label class="status-toggle">
                          <input type="checkbox" class="day-enabled" checked>
                          <span class="toggle-slider"></span>
                          <span class="status-text">營業</span>
                        </label>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary add-period-btn" onclick="addPeriod(0)">
                      <i class="bi bi-plus"></i>
                      新增時段
                    </button>
                  </div>
                  <div class="periods-container" data-day="0"></div>
                </div>

                <div class="day-card" data-day="1">
                  <div class="day-header">
                    <div class="day-info">
                      <h6 class="day-name">週二</h6>
                      <div class="day-status">
                        <label class="status-toggle">
                          <input type="checkbox" class="day-enabled" checked>
                          <span class="toggle-slider"></span>
                          <span class="status-text">營業</span>
                        </label>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary add-period-btn" onclick="addPeriod(1)">
                      <i class="bi bi-plus"></i>
                      新增時段
                    </button>
                  </div>
                  <div class="periods-container" data-day="1"></div>
                </div>

                <div class="day-card" data-day="2">
                  <div class="day-header">
                    <div class="day-info">
                      <h6 class="day-name">週三</h6>
                      <div class="day-status">
                        <label class="status-toggle">
                          <input type="checkbox" class="day-enabled" checked>
                          <span class="toggle-slider"></span>
                          <span class="status-text">營業</span>
                        </label>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary add-period-btn" onclick="addPeriod(2)">
                      <i class="bi bi-plus"></i>
                      新增時段
                    </button>
                  </div>
                  <div class="periods-container" data-day="2"></div>
                </div>

                <div class="day-card" data-day="3">
                  <div class="day-header">
                    <div class="day-info">
                      <h6 class="day-name">週四</h6>
                      <div class="day-status">
                        <label class="status-toggle">
                          <input type="checkbox" class="day-enabled" checked>
                          <span class="toggle-slider"></span>
                          <span class="status-text">營業</span>
                        </label>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary add-period-btn" onclick="addPeriod(3)">
                      <i class="bi bi-plus"></i>
                      新增時段
                    </button>
                  </div>
                  <div class="periods-container" data-day="3"></div>
                </div>

                <div class="day-card" data-day="4">
                  <div class="day-header">
                    <div class="day-info">
                      <h6 class="day-name">週五</h6>
                      <div class="day-status">
                        <label class="status-toggle">
                          <input type="checkbox" class="day-enabled" checked>
                          <span class="toggle-slider"></span>
                          <span class="status-text">營業</span>
                        </label>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary add-period-btn" onclick="addPeriod(4)">
                      <i class="bi bi-plus"></i>
                      新增時段
                    </button>
                  </div>
                  <div class="periods-container" data-day="4"></div>
                </div>

                <div class="day-card" data-day="5">
                  <div class="day-header">
                    <div class="day-info">
                      <h6 class="day-name">週六</h6>
                      <div class="day-status">
                        <label class="status-toggle">
                          <input type="checkbox" class="day-enabled" checked>
                          <span class="toggle-slider"></span>
                          <span class="status-text">營業</span>
                        </label>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary add-period-btn" onclick="addPeriod(5)">
                      <i class="bi bi-plus"></i>
                      新增時段
                    </button>
                  </div>
                  <div class="periods-container" data-day="5"></div>
                </div>

                <div class="day-card" data-day="6">
                  <div class="day-header">
                    <div class="day-info">
                      <h6 class="day-name">週日</h6>
                      <div class="day-status">
                        <label class="status-toggle">
                          <input type="checkbox" class="day-enabled">
                          <span class="toggle-slider"></span>
                          <span class="status-text">休息</span>
                        </label>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary add-period-btn" onclick="addPeriod(6)">
                      <i class="bi bi-plus"></i>
                      新增時段
                    </button>
                  </div>
                  <div class="periods-container" data-day="6"></div>
                </div>
              </div>
            </div>

            <!-- 營業時間預覽 -->
            <div class="preview-section mt-4">
              <h5 class="mb-3">
                <i class="bi bi-eye me-2"></i>
                營業時間總覽
              </h5>
              <div class="preview-card">
                <div id="businessHoursPreview">
                  <!-- 預覽內容將由 JavaScript 生成 -->
                </div>
              </div>
            </div>

          </div>
        </div>
        
        <div class="tab-content" id="notificationTab" style="display: none;">
          <p class="text-muted">通知設定功能開發中...</p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-modern btn-outline-modern" onclick="closeSettingsModal()">
          取消
        </button>
        <button type="button" class="btn-modern btn-primary-modern" onclick="saveClinicSettings()">
          <i class="bi bi-check"></i>
          儲存設定
        </button>
      </div>
    </div>
  </div>

</div>

<!-- 隱藏的 CSRF Token -->
<form id="ajaxForm" style="display: none;">
  {% csrf_token %}
</form>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/clinic/dashboard.js' %}"></script>
<script src="{% static 'js/clinic/business-hours.js' %}"></script>
<script>
// 傳遞 Django 數據到 JavaScript
window.dashboardData = {
  clinic: {
    id: {{ clinic.id }},
    name: '{{ clinic.clinic_name|escapejs }}',
    phone: '{{ clinic.clinic_phone|escapejs }}',
    email: '{{ clinic.clinic_email|escapejs }}',
    address: '{{ clinic.clinic_address|escapejs }}',
    isVerified: {{ clinic.is_verified|yesno:"true,false" }}
  },
  stats: {
    todayAppointments: {{ today_appointments }},
    pendingAppointments: {{ pending_appointments }},
    doctorsCount: {{ doctors_count }},
    totalAppointmentsThisMonth: {{ total_appointments_this_month }}
  },
  urls: {
    appointments: '{% url "clinic_appointments" %}',
    doctors: '{% url "manage_doctors" %}',
    schedules: '{% url "manage_schedules"%}', 
    addDoctor: '{% url "add_doctor" %}'
  },
  csrfToken: '{{ csrf_token }}'
};

// 顯示訊息
{% if messages %}
  {% for message in messages %}
    {% if message.tags == 'success' %}
      showSuccessMessage('{{ message|escapejs }}');
    {% elif message.tags == 'error' %}
      showErrorMessage('{{ message|escapejs }}');
    {% elif message.tags == 'warning' %}
      showWarningMessage('{{ message|escapejs }}');
    {% endif %}
  {% endfor %}
{% endif %}

// 營業時間初始化
document.addEventListener('DOMContentLoaded', function() {
    // 當切換到營業時間標籤時初始化
    const businessTab = document.querySelector('[data-tab="business"]');
    if (businessTab) {
        businessTab.addEventListener('click', function() {
            setTimeout(() => {
                if (typeof initializeBusinessHours === 'function') {
                    initializeBusinessHours();
                }
            }, 100);
        });
    }
});
</script>
{% endblock %}