{% extends "base.html" %}
{% load form_tags %}

{% block title %}編輯寵物資料{% endblock %}

{% block extra_css %}
<style>
    body.edit-pet-page {
        padding: 20px;
        background-color: #f7f7f7;
    }
    form {
        background: white;
        padding: 2em;
        border-radius: 10px;
        max-width: 600px;
        margin: auto;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .form-control {
        margin-bottom: 5px;
    }
    .form-other-group{
      display:none;
      margin-bottom:0px;
    }
    label {
        display: block;
        margin-top: 1em;
        font-weight: bold;
        margin-bottom: 0.5em;
    }
    input, select, textarea {
        width: 100%;
        padding: 0.5em;
        border-radius: 5px;
        border: 1px solid #ccc;
        margin-bottom: 1em;
    }
    .text-danger p {
        color: red;
        margin: 0.2em 0 0;
    }
    .current-image {
        margin-top: 1em;
        text-align: center;
    }
    .current-image img {
        max-width: 100%;
        max-height: 200px;
        object-fit: contain;
    }
    .button-row {
        display: flex;
        justify-content: space-between;
        margin-top: 2em;
    }
    .button-row button,
    .button-row a button {
        padding: 0.6em 1.5em;
        border: none;
        border-radius: 6px;
        font-size: 1em;
        cursor: pointer;
    }
    .button-row button[type="submit"] {
        background-color: #3498db;
        color: #fff;
    }
    .button-row a button {
        background-color: #95a5a6;
        color: #fff;
    }
    .button-row button:hover {
        opacity: 0.9;
    }
    /* 隱藏 Django 預設清除 checkbox 和文字 */
    input[type="checkbox"][name$="-clear"],
    label[for$="-clear"],
    a[href$="-clear"] {
        display: none !important;
    }

    /* 隱藏圖片路徑文字（如有） */
    .current-image + a {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<h2 style="text-align: center;">編輯寵物資料</h2>

<form method="post" enctype="multipart/form-data" id="edit-form">
    {% csrf_token %}

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <!-- 種類 -->
    <div class="form-group">
      <label for="species_select"><strong>種類</strong></label>
      <select id="species_select" class="form-control">
        <option value="">請選擇</option>
        <option value="狗">狗</option>
        <option value="貓">貓</option>
        <option value="其他">其他</option>
      </select>
    </div>
    <div id="species_other_group" class="form-other-group">
      {{ form.species_other }}
        {% if form.species_other.errors %}
        <div class="text-danger">{{ form.species_other.errors }}</div>
        {% endif %}
    </div>
    {{ form.species }}
    {% if form.species.errors %}
    <div class="text-danger">{{ form.species.errors }}</div>
    {% endif %}

    <!-- 品種 -->
    <div class="form-group">
      <label for="breed_select"><strong>品種</strong></label>
      <select id="breed_select" class="form-control">
        <option value="">請選擇</option>
      </select>
    </div>
    <div id="breed_other_group" class="form-other-group">
      {{ form.breed_other }}
        {% if form.breed_other.errors %}
        <div class="text-danger">{{ form.breed_other.errors }}</div>
        {% endif %}
    </div>
    {{ form.breed }}
   {% if form.breed.errors %}
    <div class="text-danger">{{ form.breed.errors }}</div>
    {% endif %}

    <label for="id_name">名字</label>
    {{ form.name }}
    {% if form.name.errors %}
        <div class="text-danger">{% for error in form.name.errors %}<p>{{ error }}</p>{% endfor %}</div>
    {% endif %}

    <label for="id_sterilization_status">絕育狀態</label>
    {{ form.sterilization_status }}
    {% if form.sterilization_status.errors %}
    <div class="text-danger">{{ form.sterilization_status.errors }}</div>
    {% endif %}

    <label for="id_chip">晶片號碼</label>
    {{ form.chip }}
    {% if form.chip.errors %}
    <div class="text-danger">{{ form.chip.errors }}</div>
    {% endif %}

    <label for="id_birth_date">出生日期</label>
    {{ form.birth_date }}
    {% if form.birth_date.errors %}
        <div class="text-danger">{% for error in form.birth_date.errors %}<p>{{ error }}</p>{% endfor %}</div>
    {% endif %}

    <label for="id_gender">性別</label>
    {{ form.gender }}
    {% if form.gender.errors %}
    <div class="text-danger">{{ form.gender.errors }}</div>
    {% endif %}

    <label for="id_weight">體重（公斤）</label>
    {{ form.weight }}
    {% if form.weight.errors %}
        <div class="text-danger">{% for error in form.weight.errors %}<p>{{ error }}</p>{% endfor %}</div>
    {% endif %}

    <label for="id_feature">特徵</label>
    {{ form.feature }}
    {% if form.feature.errors %}
    <div class="text-danger">{{ form.feature.errors }}</div>
    {% endif %}

    <label for="id_picture">圖片</label>

    {% if pet.picture %}
        <div class="current-image">
            <img src="{{ pet.picture.url }}" alt="目前圖片" id="current-preview">
        </div>
    {% else %}
        <div class="current-image">
            <p>尚未上傳圖片。</p>
            <img id="current-preview" style="display:none;" />
        </div>
    {% endif %}

<!-- 僅顯示檔案選擇按鈕，隱藏檔案路徑與清除文字 -->
<input type="file" name="picture" accept="image/*" id="id_picture">

    {% if form.picture.errors %}
        <div class="text-danger">{% for error in form.picture.errors %}<p>{{ error }}</p>{% endfor %}</div>
    {% endif %}

    <div class="button-row">
        <a href="{% url 'pet_list' %}"><button type="button">返回</button></a>
        <button type="submit">保存更改</button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('id_picture');
    const preview = document.getElementById('current-preview');

    if (input && preview) {
        input.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }


// 種類、品種 後端預填值
    const speciesSelect = document.getElementById('species_select');
    const speciesOtherGroup = document.getElementById('species_other_group');
    const speciesOtherInput = document.getElementById('id_species_other');
    const hiddenSpecies = document.getElementById('id_species');

    const breedSelect = document.getElementById('breed_select');
    const breedOtherGroup = document.getElementById('breed_other_group');
    const breedOtherInput = document.getElementById('id_breed_other');
    const hiddenBreed = document.getElementById('id_breed');

    const dogBreeds = {{ dog_choices|safe }};
    const catBreeds = {{ cat_choices|safe }};

    // 後端傳進來的原始值
    const initialSpecies = hiddenSpecies.value;
    const initialBreed = hiddenBreed.value;

    function updateSpecies(setInitial=false) {
        const value = speciesSelect.value;
        hiddenSpecies.value = value;

        speciesOtherGroup.style.display = value === '其他' ? 'block' : 'none';
        if (value !== '其他' && !setInitial) speciesOtherInput.value = '';

        let breeds = [['', '請選擇']];
        if (value === '狗') breeds = breeds.concat(dogBreeds);
        if (value === '貓') breeds = breeds.concat(catBreeds);
        if (value === '其他') breeds.push(['其他', '其他']);

        breedSelect.innerHTML = breeds.map(o =>
            `<option value="${o[0]}">${o[1]}</option>`
        ).join('');

        if (setInitial && initialBreed) {
            breedSelect.value = initialBreed;
        }
        updateBreed(setInitial);
    }

    function updateBreed(setInitial=false) {
        const value = breedSelect.value;
        hiddenBreed.value = value;

        breedOtherGroup.style.display = value === '其他' ? 'block' : 'none';
        if (value !== '其他' && !setInitial) breedOtherInput.value = '';
    }

    speciesSelect.addEventListener('change', () => updateSpecies(false));
    breedSelect.addEventListener('change', () => updateBreed(false));

// 初始化選項
if (initialSpecies) {
    if (initialSpecies === '狗' || initialSpecies === '貓' || initialSpecies === '其他') {
        speciesSelect.value = initialSpecies;
    } else {
        // 如果是使用者自填的
        speciesSelect.value = '其他';
        hiddenSpecies.value = '其他';
        speciesOtherInput.value = initialSpecies;  // 顯示到「其他種類」輸入框
    }
}
updateSpecies(true);

if (initialBreed) {
    const dogBreeds = {{ dog_choices|safe }};
    const catBreeds = {{ cat_choices|safe }};
    const validBreeds = dogBreeds.concat(catBreeds).map(b => b[0]).concat(['其他']);

    if (validBreeds.includes(initialBreed)) {
        breedSelect.value = initialBreed;
    } else {
        breedSelect.value = '其他';
        hiddenBreed.value = '其他';
        breedOtherInput.value = initialBreed;  // 顯示到「其他品種」輸入框
    }
}
updateBreed(true);



// 表單送出檢查
document.getElementById('petForm').addEventListener('submit', function(e) {
  const species = speciesSelect.value;
  const speciesOther = document.getElementById('id_species_other')?.value.trim();
  const breed = breedSelect.value;
  const breedOther = document.getElementById('id_breed_other')?.value.trim();

  if (!species) {
    alert('請選擇寵物種類！');
    e.preventDefault();
    return;
  }

  if (species === '其他' && !speciesOther) {
    alert('請填寫自訂種類！');
    e.preventDefault();
    return;
  }

  if (!breed) {
    alert('請選擇寵物品種！');
    e.preventDefault();
    return;
  }

  if (breed === '其他' && !breedOther) {
    alert('請填寫自訂品種！');
    e.preventDefault();
    return;
  }
});



});
</script>
{% endblock %}
