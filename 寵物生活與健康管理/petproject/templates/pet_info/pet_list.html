<!-- templates/pet_info/pet_list.html -->
{% extends "pet_info/base.html" %}
{% block title %}飼主主頁{% endblock %}

{% block extra_head %}
<style>
    h2 {
        color: #333;
    }
    .pet-list {
        margin-top: 20px;
    }
    .pet-list li {
        background-color: #fff;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    .pet-details {
        display: none;
        margin-top: 10px;
        background-color: #f1f1f1;
        padding: 15px;
        border-radius: 5px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        border: none;
        transition: all 0.3s ease;
    }

    .btn-pet { color: #007bff; background-color: #fff; border: 1px solid #007bff; }
    .btn-pet:hover { background-color: #007bff; color: white; }

    .btn-edit { background-color: #ffc107; color: white; }
    .btn-edit:hover { background-color: #e0a800; }

    .btn-delete { background-color: #dc3545; color: white; }
    .btn-delete:hover { background-color: #c82333; }

    .btn-daily { background-color: #17a2b8; color: white; }
    .btn-daily:hover { background-color: #138496; }

    .btn-close { background-color: #6c757d; color: white; }
    .btn-close:hover { background-color: #5a6268; }

    .btn-primary { background-color: #28a745; color: white; }
    .btn-primary:hover { background-color: #218838; }

    .action-buttons {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .pet-details p {
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        white-space: normal;
    }
/* 限制特定文字欄位（例如特徵）最多顯示 3 行，太多會裁切 */
        .pet-details .feature-text {
            display: -webkit-box;
            -webkit-line-clamp: 3;        /* 顯示最多 3 行 */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }


    .feature-text.collapsed {
      display: inline-block;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .feature-text.expanded {
      white-space: normal;
      max-width: none;
      cursor: pointer;
    }

    .message-popup {
      position: fixed;
      top: 20px;
      left: 40%;
      z-index: 9999;
      min-width: 300px;
      max-width: 90%;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      animation: fadein 0.5s ease;
      text-align: center;
    }

    .message {
      margin: 0.5em 0;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    /* 不同訊息類別配色 */
    .message.success {
      background-color: #28a745;  /* 綠色 */
    }
    .message.error {
      background-color: #dc3545;  /* 紅色 */
    }
    .message.warning {
      background-color: #ffc107;  /* 黃色 */
      color: #212529;
    }
    .message.info {
      background-color: #17a2b8;  /* 藍色 */
    }

    /* 淡入動畫 */
    @keyframes fadein {
      from {opacity: 0; transform: translateY(-10px);}
      to {opacity: 1; transform: translateY(0);}
    }

</style>
{% endblock %}

{% block content %}
<input type="hidden" id="appointment-digest" value="{{ appointment_digest }}">

<h2>歡迎來到飼主主頁</h2>
<p>在這裡你可以新增寵物資料或查看已填過的寵物資料。</p>

<a href="{% url 'add_pet' %}" class="btn btn-primary">➕ 新增寵物資料</a>

<!-- 新增、編輯、刪除 訊息 -->
{% if messages %}
      <div id="message-container" class="message-popup">
        {% for message in messages %}
          <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

<div class="pet-list">
    <h3>已填過的寵物資料</h3>
    <ul>
      {% for pet in pets %}
        <li>
            <button class="btn btn-pet" onclick="togglePetDetails({{ pet.id }})">{{ pet.name }}</button>
            <div id="details-{{ pet.id }}" class="pet-details">
                <p><strong>品種：</strong>{{ pet.breed }}</p>
                <p><strong>絕育狀態：</strong>{{ pet.get_sterilization_status_display }}</p>
                <p><strong>晶片號碼：</strong>{{ pet.chip }}</p>
                <p><strong>出生日期：</strong>
                        {% if pet.birth_date %}
                            {{ pet.birth_date|date:"Y 年 m 月 d 日" }}
                          {% else %}
                            尚未填寫
                          {% endif %}
                    </p>
                <p><strong>體重：</strong>{{ pet.weight }} 公斤</p>
                <p><strong>特徵：</strong>
                  <span id="feature-{{ pet.id }}" class="feature-text collapsed">{{ pet.feature }}</span>
                  <button class="toggle-feature-btn" onclick="toggleFeature({{ pet.id }})">展開</button>
                </p>
                <p><strong>性別：</strong>{{ pet.get_gender_display }}</p>
                <p><strong>圖片：</strong></p>
                {% if pet.picture %}
                    <p><img src="{{ pet.picture.url }}" alt="pet image" style="max-width: 200px;"></p>
                {% else %}
                    <p>尚未上傳圖片</p>
                {% endif %}

                {% if pet.future_appointments %}
                    <div style="margin-top: 10px; background-color: #f1f9ff; padding: 10px; border-left: 4px solid #007bff;">
                        <strong>📅 預約資訊：</strong>
                        <ul style="margin-top: 5px;">
                            {% for appt in pet.future_appointments %}
                            <li>
                                {{ appt.date }} {{ appt.time }}｜{{ appt.vet.clinic_name|default:"未填寫診所名稱" }}
                                （{{ appt.vet.user.last_name|default:"" }}{{ appt.vet.user.first_name|default:"" }}{% if not appt.vet.user.last_name and not appt.vet.user.first_name %}{{ appt.vet.user.username }}{% endif %}）
                                <form method="post" action="{% url 'cancel_appointment' appt.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" style="background:none; border:none; color:#dc3545; font-weight:bold; cursor:pointer;" title="取消預約">
                                        ❌
                                    </button>
                                </form>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <p style="color: #888; font-style: italic;">尚無預約紀錄</p>
                {% endif %}

                <div class="action-buttons">
                    <a href="{% url 'edit_pet' pet.id %}" class="btn btn-edit">✏️ 修改</a>
                    <a href="{% url 'delete_pet' pet.id %}" class="btn btn-delete">🗑️ 刪除</a>
                    <a href="{% url 'create_appointment' %}?pet_id={{ pet.id }}" class="btn btn-daily">📅 預約獸醫</a>
                    <button class="btn btn-close" onclick="togglePetDetails({{ pet.id }})">❌ 關閉</button>
                </div>
            </div>
        </li>
      {% empty %}
        <li>尚無寵物資料，快來新增你的寵物吧！</li>
      {% endfor %}
    </ul>
</div>

<script>
    function togglePetDetails(petId) {
        var details = document.getElementById("details-" + petId);
        details.style.display = (details.style.display === "none" || details.style.display === "") ? "block" : "none";
      }

      document.addEventListener('DOMContentLoaded', () => {
        // 特徵文字展開／收合
        document.querySelectorAll('.feature-text').forEach(span => {
          const maxLength = 30;
          if (span.textContent.length <= maxLength) {
            span.classList.remove('collapsed');
            span.style.cursor = 'default';
            return;
          }
          span.classList.add('collapsed');
          span.addEventListener('click', () => {
            span.classList.toggle('collapsed');
            span.classList.toggle('expanded');
          });
        });

        // 訊息淡出
        const msgContainer = document.getElementById('message-container');
        if (msgContainer) {
          setTimeout(() => {
            msgContainer.style.transition = 'opacity 0.5s ease';
            msgContainer.style.opacity = '0';
            setTimeout(() => msgContainer.remove(), 500);
          }, 3000);
        }
      });


    function toggleNotice() {
        const box = document.getElementById("notification-box");
        const isVisible = box.style.display === "block";
        box.style.display = isVisible ? "none" : "block";
    }

    function markAsRead() {
        const box = document.getElementById("notification-box");
        const count = document.getElementById("notif-count");
        const digest = document.getElementById("appointment-digest")?.value || "";
        box.classList.remove("unread");
        box.classList.add("read");
        if (count) count.style.display = "none";
        localStorage.setItem("last_read_digest", digest);
    }

    window.addEventListener("DOMContentLoaded", function () {
        const box = document.getElementById("notification-box");
        const count = document.getElementById("notif-count");
        const digest = document.getElementById("appointment-digest")?.value || "";
        const lastDigest = localStorage.getItem("last_read_digest");

        const isRead = digest && digest === lastDigest;

        if (isRead) {
            box.classList.remove("unread");
            box.classList.add("read");
            if (count) count.style.display = "none";
        } else if (digest) {
            box.classList.remove("read");
            box.classList.add("unread");
            if (count) count.style.display = "inline-block";
        }

        const markReadBtn = document.getElementById("mark-read-btn");
        if (markReadBtn) {
            markReadBtn.addEventListener("click", markAsRead);
        }
    });
</script>
{% endblock %}
