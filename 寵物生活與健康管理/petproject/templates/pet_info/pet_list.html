<!-- templates/pet_info/pet_list.html -->
{% extends "pet_info/base.html" %}
{% block title %}é£¼ä¸»ä¸»é {% endblock %}

{% block extra_head %}
<style>
    h2 {
        color: #333;
    }
    .pet-list {
        margin-top: 20px;
    }
    .pet-list li {
        background-color: #fff;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    .pet-details {
        display: none;
        margin-top: 10px;
        background-color: #f1f1f1;
        padding: 15px;
        border-radius: 5px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        border: none;
        transition: all 0.3s ease;
    }

    .btn-pet { color: #007bff; background-color: #fff; border: 1px solid #007bff; }
    .btn-pet:hover { background-color: #007bff; color: white; }

    .btn-edit { background-color: #ffc107; color: white; }
    .btn-edit:hover { background-color: #e0a800; }

    .btn-delete { background-color: #dc3545; color: white; }
    .btn-delete:hover { background-color: #c82333; }

    .btn-daily { background-color: #17a2b8; color: white; }
    .btn-daily:hover { background-color: #138496; }

    .btn-close { background-color: #6c757d; color: white; }
    .btn-close:hover { background-color: #5a6268; }

    .btn-primary { background-color: #28a745; color: white; }
    .btn-primary:hover { background-color: #218838; }

    .action-buttons {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .pet-details p {
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        white-space: normal;
    }

    .feature-text {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: max-height 0.3s ease;
    }
    .feature-text.collapsed { -webkit-line-clamp: 3; }
    .feature-text.expanded { -webkit-line-clamp: unset; }
</style>
{% endblock %}

{% block content %}
<input type="hidden" id="appointment-digest" value="{{ appointment_digest }}">

<h2>æ­¡è¿ä¾†åˆ°é£¼ä¸»ä¸»é </h2>
<p>åœ¨é€™è£¡ä½ å¯ä»¥æ–°å¢å¯µç‰©è³‡æ–™æˆ–æŸ¥çœ‹å·²å¡«éçš„å¯µç‰©è³‡æ–™ã€‚</p>

<a href="{% url 'add_pet' %}" class="btn btn-primary">â• æ–°å¢å¯µç‰©è³‡æ–™</a>

<div class="pet-list">
    <h3>å·²å¡«éçš„å¯µç‰©è³‡æ–™</h3>
    <ul>
      {% for pet in pets %}
        <li>
            <button class="btn btn-pet" onclick="togglePetDetails({{ pet.id }})">{{ pet.name }}</button>
            <div id="details-{{ pet.id }}" class="pet-details">
                <p><strong>å“ç¨®ï¼š</strong>{{ pet.breed }}</p>
                <p><strong>çµ•è‚²ç‹€æ…‹ï¼š</strong>{{ pet.get_sterilization_status_display }}</p>
                <p><strong>æ™¶ç‰‡è™Ÿç¢¼ï¼š</strong>{{ pet.chip }}</p>
                <p><strong>å‡ºç”Ÿæ—¥æœŸï¼š</strong>{{ pet.year_of_birth }} å¹´ {{ pet.month_of_birth }} æœˆ {{ pet.day_of_birth }} æ—¥</p>
                <p><strong>é«”é‡ï¼š</strong>{{ pet.weight }} å…¬æ–¤</p>
                <p><strong>ç‰¹å¾µï¼š</strong>
                  <span id="feature-{{ pet.id }}" class="feature-text collapsed">{{ pet.feature }}</span>
                  <button class="toggle-feature-btn" onclick="toggleFeature({{ pet.id }})">å±•é–‹</button>
                </p>
                <p><strong>æ€§åˆ¥ï¼š</strong>{{ pet.get_gender_display }}</p>
                <p><strong>åœ–ç‰‡ï¼š</strong></p>
                {% if pet.picture %}
                    <p><img src="{{ pet.picture.url }}" alt="pet image" style="max-width: 200px;"></p>
                {% else %}
                    <p>å°šæœªä¸Šå‚³åœ–ç‰‡</p>
                {% endif %}

                {% if pet.future_appointments %}
                    <div style="margin-top: 10px; background-color: #f1f9ff; padding: 10px; border-left: 4px solid #007bff;">
                        <strong>ğŸ“… é ç´„è³‡è¨Šï¼š</strong>
                        <ul style="margin-top: 5px;">
                            {% for appt in pet.future_appointments %}
                            <li>
                                {{ appt.date }} {{ appt.time }}ï½œ{{ appt.vet.clinic_name|default:"æœªå¡«å¯«è¨ºæ‰€åç¨±" }}
                                ï¼ˆ{{ appt.vet.user.last_name|default:"" }}{{ appt.vet.user.first_name|default:"" }}{% if not appt.vet.user.last_name and not appt.vet.user.first_name %}{{ appt.vet.user.username }}{% endif %}ï¼‰
                                <form method="post" action="{% url 'cancel_appointment' appt.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" style="background:none; border:none; color:#dc3545; font-weight:bold; cursor:pointer;" title="å–æ¶ˆé ç´„">
                                        âŒ
                                    </button>
                                </form>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <p style="color: #888; font-style: italic;">å°šç„¡é ç´„ç´€éŒ„</p>
                {% endif %}

                <div class="action-buttons">
                    <a href="{% url 'edit_pet' pet.id %}" class="btn btn-edit">âœï¸ ä¿®æ”¹</a>
                    <a href="{% url 'delete_pet' pet.id %}" class="btn btn-delete">ğŸ—‘ï¸ åˆªé™¤</a>
                    <a href="{% url 'create_appointment' %}?pet_id={{ pet.id }}" class="btn btn-daily">ğŸ“… é ç´„ç¸é†«</a>
                    <button class="btn btn-close" onclick="togglePetDetails({{ pet.id }})">âŒ é—œé–‰</button>
                </div>
            </div>
        </li>
      {% empty %}
        <li>å°šç„¡å¯µç‰©è³‡æ–™ï¼Œå¿«ä¾†æ–°å¢ä½ çš„å¯µç‰©å§ï¼</li>
      {% endfor %}
    </ul>
</div>

<script>
    function togglePetDetails(petId) {
        var details = document.getElementById("details-" + petId);
        details.style.display = (details.style.display === "none" || details.style.display === "") ? "block" : "none";
    }

    function toggleFeature(petId) {
        const span = document.getElementById("feature-" + petId);
        const btn = span.nextElementSibling;

        if (span.classList.contains("collapsed")) {
            span.classList.remove("collapsed");
            span.classList.add("expanded");
            btn.innerText = "æ”¶åˆ";
        } else {
            span.classList.remove("expanded");
            span.classList.add("collapsed");
            btn.innerText = "å±•é–‹";
        }
    }

    function toggleNotice() {
        const box = document.getElementById("notification-box");
        const isVisible = box.style.display === "block";
        box.style.display = isVisible ? "none" : "block";
    }

    function markAsRead() {
        const box = document.getElementById("notification-box");
        const count = document.getElementById("notif-count");
        const digest = document.getElementById("appointment-digest")?.value || "";
        box.classList.remove("unread");
        box.classList.add("read");
        if (count) count.style.display = "none";
        localStorage.setItem("last_read_digest", digest);
    }


    window.addEventListener("DOMContentLoaded", function () {
        const box = document.getElementById("notification-box");
        const count = document.getElementById("notif-count");
        const digest = document.getElementById("appointment-digest")?.value || "";
        const lastDigest = localStorage.getItem("last_read_digest");

        const isRead = digest && digest === lastDigest;

        if (isRead) {
            box.classList.remove("unread");
            box.classList.add("read");
            if (count) count.style.display = "none";
        } else if (digest) {
            box.classList.remove("read");
            box.classList.add("unread");
            if (count) count.style.display = "inline-block";
        }

        const markReadBtn = document.getElementById("mark-read-btn");
        if (markReadBtn) {
            markReadBtn.addEventListener("click", markAsRead);
        }
    });
</script>
{% endblock %}

        function toggleFeature(petId) {
            const span = document.getElementById("feature-" + petId);
            const btn = span.nextElementSibling;

            if (span.classList.contains("collapsed")) {
                span.classList.remove("collapsed");
                span.classList.add("expanded");
                btn.innerText = "æ”¶åˆ";
            } else {
                span.classList.remove("expanded");
                span.classList.add("collapsed");
                btn.innerText = "å±•é–‹";
            }
        }
    </script>
</body>
</html>

