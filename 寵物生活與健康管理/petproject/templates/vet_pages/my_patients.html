
{% extends "vet_pages/base.html" %}

{% block title %}我的看診寵物{% endblock %}

{% block back_button %}
  <a href="{% url 'vet_home' %}" class="back-home">← 回主控台</a>
{% endblock %}

{% block header %}<h1 class="section-title">🐾 我的看診寵物</h1>{% endblock %}

{% block extra_css %}
<style>
  .record-card {
    background-color: #f9f9f9;
    border: 2px solid #cce5ff;
    padding: 16px;
    margin-bottom: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease-in-out;
  }
  .record-card:hover {
    background-color: #e9f7ff;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
  }
  .record-more { display: none; }
  .pet-header {
    cursor: pointer;
    background-color: #eef6ff;
    padding: 10px 14px;
    margin: 15px 0;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
  }

  .add-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 15px;
  }
  .add-buttons .btn {
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    color: white;
    text-decoration: none;
    transition: background-color 0.3s ease;
  }
  .btn-medical { background-color: #4db6ac; }
  .btn-medical:hover { background-color: #009688; }

  .btn-vaccine { background-color: #42a5f5; }
  .btn-vaccine:hover { background-color: #1e88e5; }

  .btn-deworm { background-color: #ab47bc; }
  .btn-deworm:hover { background-color: #8e24aa; }

  .btn-report { background-color: #ef5350; }
  .btn-report:hover { background-color: #e53935; }

  .search-container {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  .search-container input[type="text"] {
    flex: 1;
    min-width: 200px;
    padding: 8px 14px;
    border: 2px solid #90caf9;
    border-radius: 20px;
    font-size: 15px;
    outline: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: border-color 0.3s ease;
  }
  .search-container input[type="text"]:focus {
    border-color: #42a5f5;
  }
  .btn-search {
    background-color: #42a5f5;
    color: white;
    border-radius: 20px;
    font-weight: bold;
    padding: 8px 16px;
    border: none;
    transition: background-color 0.3s ease;
    white-space: nowrap;
  }
  .btn-search:hover {
    background-color: #1e88e5;
  }
</style>


{% endblock %}

{% block content %}

<form method="get" class="search-bar">
  <div class="search-container">

  <input type="text" name="q" placeholder="🔍 搜尋寵物或飼主..." value="{{ request.GET.q }}">
  <button type="submit" class="btn btn-search">🔍 搜尋</button></div>
</form>

{% if pets %}
<ul>
  {% for pet in pets %}
  <li>
    <div class="pet-card">
      <div class="pet-header" onclick="togglePetDetails(this)">
        {{ pet.name }}（飼主：{{ pet.owner.last_name }}{{ pet.owner.first_name|default:pet.owner.username }}）
      </div>
      
<div class="pet-details" style="display: none;">
  <div class="add-buttons">
    <a href="{% url 'create_medical_record' pet.id %}" class="btn btn-medical">➕ 新增病歷</a>
    <a href="{% url 'add_vaccine' pet.id %}" class="btn btn-vaccine">💉 新增疫苗</a>
    <a href="{% url 'add_deworm' pet.id %}" class="btn btn-deworm">🪱 新增驅蟲</a>
    <a href="{% url 'add_report' pet.id %}" class="btn btn-report">📎 新增報告</a>
  </div>

        <h4>病歷紀錄</h4>
        {% for record in pet.medicalrecord_set.all|dictsortreversed:"visit_date" %}
          <div class="record-card medical-record" {% if forloop.counter > 1 %}style="display: none;"{% endif %}>
            <p><strong>🗓️ 日期：</strong>{{ record.visit_date }}</p>
            <p><strong>📍 地點：</strong>{{ record.clinic_location }}</p>
            <p><strong>🦠 診斷：</strong>{{ record.diagnosis|default:"未填寫" }}</p>
            <p><strong>💊 治療：</strong>{{ record.treatment|default:"未填寫" }}</p>
            <p><strong>👨‍⚕️ 醫師：</strong>{{ record.vet.user.last_name }}{{ record.vet.user.first_name }}</p>
            <a href="{% url 'edit_medical_record' pet.id record.id %}">✏️編輯</a>
            <a href="{% url 'delete_medical_record' record.id %}" onclick="return confirm('確定刪除這筆病歷紀錄嗎？')">🗑️刪除</a>
          </div>
        {% endfor %}
        {% if pet.medicalrecord_set.count > 1 %}
          <button onclick="toggleRecords('medical-record', this)" class="btn btn-secondary">顯示更多病歷紀錄</button>
        {% endif %}

        <h4>疫苗紀錄</h4>
        {% for record in pet.vaccine_records.all|dictsortreversed:"date" %}
          <div class="record-card vaccine-record" {% if forloop.counter > 1 %}style="display: none;"{% endif %}>
            <p><strong>💉 疫苗：</strong>{{ record.name }}</p>
            <p><strong>📆 日期：</strong>{{ record.date }}</p>
            <p><strong>📍 地點：</strong>{{ record.location }}</p>
            <p><strong>👨‍⚕️ 醫師：</strong>{{ record.vet.user.last_name }}{{ record.vet.user.first_name }}</p>
            <a href="{% url 'edit_vaccine' pet.id record.id %}">✏️編輯</a>
            <a href="{% url 'delete_vaccine' record.id %}" onclick="return confirm('確定刪除這筆疫苗紀錄嗎？')">🗑️刪除</a>
          </div>
        {% endfor %}
        {% if pet.vaccine_records.count > 1 %}
          <button onclick="toggleRecords('vaccine-record', this)" class="btn btn-secondary">顯示更多疫苗紀錄</button>
        {% endif %}

        <h4>驅蟲紀錄</h4>
        {% for record in pet.deworm_records.all|dictsortreversed:"date" %}
          <div class="record-card deworm-record" {% if forloop.counter > 1 %}style="display: none;"{% endif %}>
            <p><strong>🪱 品牌：</strong>{{ record.name }}</p>
            <p><strong>📆 日期：</strong>{{ record.date }}</p>
            <p><strong>📍 地點：</strong>{{ record.location }}</p>
            <p><strong>👨‍⚕️ 醫師：</strong>{{ record.vet.user.last_name }}{{ record.vet.user.first_name }}</p>
            <a href="{% url 'edit_deworm' pet.id record.id %}">✏️編輯</a>
            <a href="{% url 'delete_deworm' record.id %}" onclick="return confirm('確定刪除這筆驅蟲紀錄嗎？')">🗑️刪除</a>
          </div>
        {% endfor %}
        {% if pet.deworm_records.count > 1 %}
          <button onclick="toggleRecords('deworm-record', this)" class="btn btn-secondary">顯示更多驅蟲紀錄</button>
        {% endif %}

        <h4>報告</h4>
        {% for report in pet.reports.all|dictsortreversed:"date_uploaded" %}
          <div class="record-card report-record" {% if forloop.counter > 1 %}style="display: none;"{% endif %}>
            <p><strong>📄 標題：</strong>{{ report.title }}</p>
            <p><strong>📎 檔案：</strong><a href="{{ report.pdf.url }}" target="_blank">{{ report.pdf.name }}</a></p>
            <a href="{% url 'delete_report' report.id %}" onclick="return confirm('確定刪除這份報告嗎？')">🗑️刪除</a>
          </div>
        {% endfor %}
        {% if pet.reports.count > 1 %}
          <button onclick="toggleRecords('report-record', this)" class="btn btn-secondary">顯示更多報告</button>
        {% endif %}
      </div>
    </div>
  </li>
  {% endfor %}
</ul>
{% else %}
<p>目前沒有看診寵物紀錄。</p>
{% endif %}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
<script>
  function toggleRecords(className, button) {
    const elements = button.closest('.pet-details').querySelectorAll(`.${className}`);
    const isHidden = elements[1].style.display === 'none';
    elements.forEach((el, index) => {
      if (index > 0) el.style.display = isHidden ? 'block' : 'none';
    });
    button.textContent = isHidden ? '隱藏' + button.textContent.replace('顯示更多', '') : '顯示更多' + button.textContent.replace('隱藏', '');
  }

  function togglePetDetails(header) {
    const details = header.nextElementSibling;
    const isHidden = details.style.display === 'none' || details.style.display === '';
    details.style.display = isHidden ? 'block' : 'none';
  }
</script>
{% endblock %}
