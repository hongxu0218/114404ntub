{% extends "vet_pages/base.html" %}

{% block title %}我的看診寵物{% endblock %}

{% block back_button %}
  <a href="{% url 'vet_home' %}" class="back-home">← 回主控台</a>
{% endblock %}

{% block header %}🐾 我的看診寵物{% endblock %}

{% block extra_css %}
<style>
  .record-card {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-left: 5px solid #4db6ac;
    padding: 16px 20px;
    margin: 20px 0;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    transition: box-shadow 0.3s ease;
  }

  .record-card:hover {
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
  }

  .record-card p {
    margin: 8px 0;
    line-height: 1.6;
    font-size: 16px;
  }

  h4 {
    margin-top: 24px;
    font-size: 18px;
    color: #444;
  }
</style>
{% endblock %}

{% block content %}
{% if pets %}
    <ul>
    {% for pet in pets %}
        <li>
          <div class="pet-card">
            <h3>{{ pet.name }}（飼主：{{ pet.owner.last_name }}{{ pet.owner.first_name|default:pet.owner.username }}）</h3>
            - <a href="{% url 'create_medical_record' pet.id %}">新增病例</a>
            - <a href="{% url 'add_vaccine' pet.id %}">新增疫苗</a>
            - <a href="{% url 'add_deworm' pet.id %}">新增驅蟲</a>
            - <a href="{% url 'add_report' pet.id %}">新增報告</a>
            
            <h4>病例紀錄</h4>
            {% with latest_record=pet.medicalrecord_set.last %}
              {% if latest_record %}
                <div class="record-card">
                  <p><strong>📅 看診日期：</strong>{{ latest_record.visit_date }}</p>
                  <p><strong>🏥 看診地點：</strong>{{ latest_record.clinic_location }}</p>
                  <p><strong>🩺 診斷結果：</strong>{{ latest_record.diagnosis|default:"未填寫" }}</p>
                  <p><strong>💊 治療內容：</strong>{{ latest_record.treatment|default:"未填寫" }}</p>
                  <p><strong>👨‍⚕️ 看診獸醫：</strong>{{ latest_record.vet.user.last_name }}{{ latest_record.vet.user.first_name }}</p>
                </div>

                <button class="toggle-more-btn" onclick="toggleMore(this)">顯示更多病例紀錄</button>

                <div class="record-more" style="display:none;">
                  {% for record in pet.medicalrecord_set.all|dictsortreversed:"visit_date" %}
                    {% if record != latest_record %}
                      <div class="record-card">
                        <p><strong>📅 看診日期：</strong>{{ record.visit_date }}</p>
                        <p><strong>🏥 看診地點：</strong>{{ record.clinic_location }}</p>
                        <p><strong>🩺 診斷結果：</strong>{{ record.diagnosis|default:"未填寫" }}</p>
                        <p><strong>💊 治療內容：</strong>{{ record.treatment|default:"未填寫" }}</p>
                        <p><strong>👨‍⚕️ 看診獸醫：</strong>{{ record.vet.user.last_name }}{{ record.vet.user.first_name }}</p>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% else %}
                <p>無病例紀錄</p>
              {% endif %}
            {% endwith %}


            <h4>疫苗紀錄</h4>
            <ul>
              {% for record in pet.vaccine_records.all|dictsortreversed:"date" %}
                <li>
                  疫苗品牌：{{ record.name }}<br>
                  施打時間：{{ record.date }}<br>
                  施打地點：{{ record.location }}<br>
                  施打獸醫：{{ record.vet.user.last_name }}{{ record.vet.user.first_name }}<br>

                  <a href="{% url 'edit_vaccine' pet.id record.id %}">✏️編輯</a>
                  <a href="{% url 'delete_vaccine' record.id %}" onclick="return confirm('確定刪除這筆疫苗紀錄嗎？')">🗑️刪除</a>
                </li>
              {% empty %}
                <li>無疫苗紀錄</li>
              {% endfor %}
            </ul>

            <h4>驅蟲紀錄</h4>
            <ul>
              {% for record in pet.deworm_records.all|dictsortreversed:"date" %}
                <li>
                  驅蟲品牌：{{ record.name }}<br>
                  施打時間：{{ record.date }}<br>
                  施打地點：{{ record.location }}<br>
                  施打獸醫：{{ record.vet.user.last_name }}{{ record.vet.user.first_name }}<br>

                  <a href="{% url 'edit_deworm' pet.id record.id %}">✏️編輯</a>
                  <a href="{% url 'delete_deworm' record.id %}" onclick="return confirm('確定刪除這筆驅蟲紀錄嗎？')">🗑️刪除</a>
                </li>
              {% empty %}
                <li>無驅蟲紀錄</li>
              {% endfor %}
            </ul>

            <h4>報告</h4>
            <ul>
              {% for report in pet.reports.all|dictsortreversed:"date_uploaded" %}
              <li>
                <strong>標題：</strong>{{ report.title }}<br>
                <strong>檔案：</strong><a href="{{ report.pdf.url }}" target="_blank">{{ report.pdf }}</a><br>

                <a href="{% url 'delete_report' report.id %}" onclick="return confirm('確定刪除這份報告嗎？')">🗑️刪除</a>
              </li>
              {% empty %}
                <li>無報告</li>
              {% endfor %}
            </ul>
        </div>
    </li>
    {% endfor %}
    </ul>
{% else %}
    <p>目前沒有看診寵物紀錄。</p>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  function toggleMore(btn) {
    const moreDiv = btn.nextElementSibling;
    if (moreDiv.style.display === "none") {
      moreDiv.style.display = "block";
      btn.textContent = "隱藏其他紀錄";
    } else {
      moreDiv.style.display = "none";
      btn.textContent = "顯示更多病例紀錄";
    }
  }
</script>
{% endblock %}