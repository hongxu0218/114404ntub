{% extends 'base.html' %}
{% load static %}

{% block title %}ç¸é†«å¸«å·¥ä½œå° - {{ vet_profile.user.get_full_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vet_pages/vet-home.css' %}">
{% endblock %}

{% block content %}
<div class="vet-home-container">
  
  <!-- ç¸é†«å¸«å€‹äººä¿¡æ¯é ­éƒ¨ -->
  <div class="vet-header-modern">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="vet-welcome-title">
          <i class="bi bi-heart-pulse"></i>
          æ­¡è¿å›ä¾†ï¼ŒDr. {{ vet_profile.user.get_full_name|default:vet_profile.user.username }}
        </h1>
        
        <div class="vet-info-header">
          <div class="vet-avatar">
            {% if vet_profile.user.get_full_name %}
              {{ vet_profile.user.get_full_name|first }}
            {% else %}
              {{ vet_profile.user.username|first|upper }}
            {% endif %}
          </div>
          <div class="vet-details">
            <div class="vet-name">
              <span>{{ vet_profile.user.get_full_name|default:vet_profile.user.username }}</span>
              {% if vet_profile.license_verified %}
                <span class="vet-badge">
                  <i class="bi bi-patch-check"></i>
                  åŸ·ç…§å·²é©—è­‰
                </span>
              {% endif %}
            </div>
            <div class="vet-speciality">
              <i class="bi bi-award me-1"></i>
              <span>å°ˆç§‘ï¼š{{ vet_profile.speciality|default:"ä¸€èˆ¬ç¸é†«" }}</span>
              {% if vet_profile.years_of_experience %}
                <span class="mx-2">â€¢</span>
                <span>{{ vet_profile.years_of_experience }}å¹´ç¶“é©—</span>
              {% endif %}
            </div>
            <div class="vet-clinic-info">
              <i class="bi bi-building me-2"></i>
              <span>{{ vet_profile.clinic.clinic_name }}</span>
              <span class="mx-2">â€¢</span>
              <span>{{ vet_profile.clinic.clinic_address }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="vet-actions">
          <div class="vet-action-buttons">
            <a href="{% url 'vet_appointments' %}" class="btn-vet-modern btn-vet-primary">
              <i class="bi bi-calendar-check"></i>
              <span>æˆ‘çš„é ç´„</span>
            </a>
            <a href="{% url 'my_patients' %}" class="btn-vet-modern btn-vet-accent">
              <i class="bi bi-heart"></i>
              <span>æˆ‘çš„ç—…æ‚£</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- çµ±è¨ˆæ•¸æ“šå€åŸŸ -->
  <div class="vet-stats-section">
    <div class="row">
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="vet-stat-card stat-appointments">
          <div class="vet-stat-card-body">
            <div class="vet-stat-content">
              <div class="vet-stat-info">
                <h3 class="vet-stat-number" id="todayAppointmentsCount">{{ today_appointments_count|default:0 }}</h3>
                <p class="vet-stat-label">ä»Šæ—¥é ç´„</p>
                <div class="vet-stat-change positive">
                  <i class="bi bi-arrow-up"></i>
                  <span>æ¯”æ˜¨æ—¥ +{{ appointments_change|default:0 }}</span>
                </div>
              </div>
              <div class="vet-stat-icon">
                <i class="bi bi-calendar-day"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="vet-stat-card stat-patients">
          <div class="vet-stat-card-body">
            <div class="vet-stat-content">
              <div class="vet-stat-info">
                <h3 class="vet-stat-number" id="totalPatientsCount">{{ total_patients_count|default:0 }}</h3>
                <p class="vet-stat-label">æˆ‘çš„ç—…æ‚£</p>
                <div class="vet-stat-change positive">
                  <i class="bi bi-heart"></i>
                  <span>æœ¬æœˆæ–°å¢ {{ new_patients_this_month|default:0 }}</span>
                </div>
              </div>
              <div class="vet-stat-icon">
                <i class="bi bi-heart-pulse"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="vet-stat-card stat-records">
          <div class="vet-stat-card-body">
            <div class="vet-stat-content">
              <div class="vet-stat-info">
                <h3 class="vet-stat-number" id="medicalRecordsCount">{{ medical_records_count|default:0 }}</h3>
                <p class="vet-stat-label">é†«ç™‚è¨˜éŒ„</p>
                <div class="vet-stat-change positive">
                  <i class="bi bi-file-medical"></i>
                  <span>æœ¬é€±æ–°å¢ {{ records_this_week|default:0 }}</span>
                </div>
              </div>
              <div class="vet-stat-icon">
                <i class="bi bi-clipboard-data"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="vet-stat-card stat-schedule">
          <div class="vet-stat-card-body">
            <div class="vet-stat-content">
              <div class="vet-stat-info">
                <h3 class="vet-stat-number" id="workingHoursCount">{{ working_hours_this_week|default:0 }}</h3>
                <p class="vet-stat-label">æœ¬é€±å·¥æ™‚</p>
                <div class="vet-stat-change">
                  <i class="bi bi-clock"></i>
                  <span>æ¨™æº–å·¥æ™‚</span>
                </div>
              </div>
              <div class="vet-stat-icon">
                <i class="bi bi-alarm"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
  <div class="row">
    
    <!-- å·¦å´ï¼šä»Šæ—¥è¡Œç¨‹ -->
    <div class="col-lg-8">
      
      <!-- ä»Šæ—¥è¡Œç¨‹å€åŸŸ -->
      <div class="today-schedule-section">
        <div class="schedule-header">
          <h2 class="section-title-vet">
            <i class="bi bi-calendar-event me-2"></i>
            ä»Šæ—¥è¡Œç¨‹
          </h2>
          <div class="schedule-date">
            <i class="bi bi-calendar3 me-1"></i>
            {{ today_date|date:"Yå¹´mæœˆdæ—¥ l" }}
          </div>
        </div>
        
        <div class="schedule-timeline">
          <!-- è¡Œç¨‹é …ç›®å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
          <div class="loading-state">
            <div class="loading-spinner"></div>
            <span>è¼‰å…¥ä»Šæ—¥è¡Œç¨‹ä¸­...</span>
          </div>
        </div>
      </div>
      
      <!-- å¿«é€ŸåŠŸèƒ½å€åŸŸ -->
      <div class="vet-quick-actions-section">
        <h2 class="section-title-vet">
          <i class="bi bi-lightning me-2"></i>
          å¿«é€ŸåŠŸèƒ½
        </h2>
        
        <div class="quick-actions-grid">
          <!-- æˆ‘çš„ç—…æ‚£ -->
          <div class="quick-action-card" data-action="patients">
            <div class="quick-action-icon patients">
              <i class="bi bi-heart"></i>
            </div>
            <div class="quick-action-content">
              <h4 class="quick-action-title">æˆ‘çš„ç—…æ‚£</h4>
              <p class="quick-action-desc">æŸ¥çœ‹å’Œç®¡ç†æ‚¨è² è²¬çš„æ‰€æœ‰ç—…æ‚£è³‡æ–™</p>
            </div>
          </div>
          
          <!-- å»ºç«‹é†«ç™‚è¨˜éŒ„ -->
          <div class="quick-action-card" data-action="records">
            <div class="quick-action-icon records">
              <i class="bi bi-file-medical"></i>
            </div>
            <div class="quick-action-content">
              <h4 class="quick-action-title">å»ºç«‹è¨˜éŒ„</h4>
              <p class="quick-action-desc">ç‚ºç—…æ‚£å»ºç«‹æ–°çš„é†«ç™‚è¨˜éŒ„å’Œè¨ºæ–·</p>
            </div>
          </div>
          
          <!-- é ç´„ç®¡ç† -->
          <div class="quick-action-card" data-action="appointments">
            <div class="quick-action-icon appointments">
              <i class="bi bi-calendar-check"></i>
            </div>
            <div class="quick-action-content">
              <h4 class="quick-action-title">é ç´„ç®¡ç†</h4>
              <p class="quick-action-desc">æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„é ç´„å®‰æ’</p>
            </div>
          </div>
          
          <!-- å€‹äººæª”æ¡ˆ -->
          <div class="quick-action-card" data-action="profile">
            <div class="quick-action-icon profile">
              <i class="bi bi-person-gear"></i>
            </div>
            <div class="quick-action-content">
              <h4 class="quick-action-title">å€‹äººæª”æ¡ˆ</h4>
              <p class="quick-action-desc">ç·¨è¼¯æ‚¨çš„å°ˆæ¥­è³‡æ–™å’Œåå¥½è¨­å®š</p>
            </div>
          </div>
        </div>
      </div>
      
    </div>
    
    <!-- å³å´ï¼šç—…æ‚£æ¦‚è¦½ -->
    <div class="col-lg-4">
      
      <!-- æˆ‘çš„ç—…æ‚£æ¦‚è¦½ -->
      <div class="patients-overview-section">
        <div class="patients-header">
          <h3 class="section-title-vet">
            <i class="bi bi-heart me-2"></i>
            æˆ‘çš„ç—…æ‚£
          </h3>
          <a href="{% url 'my_patients' %}" class="btn-vet-modern btn-vet-outline btn-sm">
            <i class="bi bi-arrow-right"></i>
            æŸ¥çœ‹å…¨éƒ¨
          </a>
        </div>
        
        <div class="patients-filters">
          <button class="filter-btn active" data-filter="all">
            å…¨éƒ¨
          </button>
          <button class="filter-btn" data-filter="recent">
            æœ€è¿‘å°±è¨º
          </button>
          <button class="filter-btn" data-filter="followup">
            éœ€è¿½è¹¤
          </button>
          <button class="filter-btn" data-filter="new">
            æ–°ç—…æ‚£
          </button>
        </div>
        
        <div class="patients-list">
          <!-- ç—…æ‚£åˆ—è¡¨å°‡ç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
          <div class="loading-state">
            <div class="loading-spinner"></div>
            <span>è¼‰å…¥ç—…æ‚£è³‡æ–™ä¸­...</span>
          </div>
        </div>
      </div>
      
    </div>
  </div>

</div>

<!-- éš±è—çš„ CSRF Token -->
<form id="vetAjaxForm" style="display: none;">
  {% csrf_token %}
</form>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/vet_pages/vet-home.js' %}"></script>
<script>
// å‚³é Django æ•¸æ“šåˆ° JavaScript
window.vetData = {
  vet: {
    id: {{ vet_profile.id }},
    name: '{{ vet_profile.user.get_full_name|default:vet_profile.user.username|escapejs }}',
    email: '{{ vet_profile.user.email|escapejs }}',
    speciality: '{{ vet_profile.speciality|default:"ä¸€èˆ¬ç¸é†«"|escapejs }}',
    licenseVerified: {{ vet_profile.license_verified|yesno:"true,false" }},
    yearsOfExperience: {{ vet_profile.years_of_experience|default:0 }},
    clinic: {
      id: {{ vet_profile.clinic.id }},
      name: '{{ vet_profile.clinic.clinic_name|escapejs }}',
      address: '{{ vet_profile.clinic.clinic_address|escapejs }}'
    }
  },
  stats: {
    todayAppointments: {{ today_appointments_count|default:0 }},
    totalPatients: {{ total_patients_count|default:0 }},
    medicalRecords: {{ medical_records_count|default:0 }},
    workingHours: {{ working_hours_this_week|default:0 }},
    appointmentsChange: {{ appointments_change|default:0 }},
    newPatientsThisMonth: {{ new_patients_this_month|default:0 }},
    recordsThisWeek: {{ records_this_week|default:0 }}
  },
  urls: {
    appointments: '{% url "vet_appointments" %}',
    myPatients: '{% url "my_patients" %}',
    createRecord: '{% url "create_medical_record" %}',
    medicalRecords: '{% url "vet_appointments" %}', // æš«æ™‚æŒ‡å‘é ç´„é é¢
    scheduleManagement: '{% url "vet_appointments" %}', // æš«æ™‚æŒ‡å‘é ç´„é é¢
    profileEdit: '/vet/profile/edit/', // éœ€è¦å¯¦éš›çš„ URL
    patientDetail: '{% url "pet_detail" 0 %}'.replace('0', ''), // ç§»é™¤æ•¸å­—ä»¥å‚™å¾ŒçºŒæ›¿æ›
    todaySchedule: '/api/vet/today-schedule/' // API ç«¯é»
  },
  csrfToken: '{{ csrf_token }}',
  today: '{{ today_date|date:"Y-m-d" }}'
};

// é¡¯ç¤ºè¨Šæ¯
{% if messages %}
  {% for message in messages %}
    {% if message.tags == 'success' %}
      showSuccessMessage('{{ message|escapejs }}');
    {% elif message.tags == 'error' %}
      showErrorMessage('{{ message|escapejs }}');
    {% elif message.tags == 'warning' %}
      showWarningMessage('{{ message|escapejs }}');
    {% elif message.tags == 'info' %}
      showInfoMessage('{{ message|escapejs }}');
    {% endif %}
  {% endfor %}
{% endif %}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„èª¿è©¦æª¢æŸ¥
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¥ ç¸é†«å¸«ä¸»é è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è¨ºæ–·...');
    
    // æª¢æŸ¥é—œéµå…ƒç´ 
    const keyElements = {
        statsCards: document.querySelectorAll('.vet-stat-card'),
        scheduleTimeline: document.querySelector('.schedule-timeline'),
        patientsList: document.querySelector('.patients-list'),
        quickActions: document.querySelectorAll('.quick-action-card'),
        filterButtons: document.querySelectorAll('.filter-btn')
    };
    
    console.log('âœ… é—œéµå…ƒç´ æª¢æŸ¥ï¼š');
    console.log('  - çµ±è¨ˆå¡ç‰‡:', keyElements.statsCards.length, 'å€‹');
    console.log('  - è¡Œç¨‹æ™‚é–“è»¸:', keyElements.scheduleTimeline ? 'å­˜åœ¨' : 'âš  ç¼ºå¤±');
    console.log('  - ç—…æ‚£åˆ—è¡¨:', keyElements.patientsList ? 'å­˜åœ¨' : 'âš  ç¼ºå¤±');
    console.log('  - å¿«é€Ÿæ“ä½œ:', keyElements.quickActions.length, 'å€‹');
    console.log('  - ç¯©é¸æŒ‰éˆ•:', keyElements.filterButtons.length, 'å€‹');
    
    // æª¢æŸ¥æ•¸æ“š
    console.log('ğŸ“Š ç¸é†«å¸«æ•¸æ“š:', window.vetData);
    
    // æª¢æŸ¥é—œéµåŠŸèƒ½
    const functions = [
        'viewMyPatients',
        'createMedicalRecord', 
        'viewTodayAppointments',
        'loadTodaySchedule',
        'loadPatientsOverview'
    ];
    
    console.log('ğŸ”§ åŠŸèƒ½æª¢æŸ¥ï¼š');
    functions.forEach(func => {
        console.log(`  - ${func}:`, typeof window[func] === 'function' ? 'å¯ç”¨' : 'âš  ç¼ºå¤±');
    });
    
    console.log('ğŸ‰ ç¸é†«å¸«ä¸»é è¨ºæ–·å®Œæˆ');
});

// æ­¡è¿è¨Šæ¯
setTimeout(() => {
    const currentHour = new Date().getHours();
    let greeting = '';
    
    if (currentHour < 12) {
        greeting = 'æ—©å®‰ï¼ŒDr. {{ vet_profile.user.get_full_name|default:vet_profile.user.username }}ï¼æº–å‚™é–‹å§‹æ–°çš„ä¸€å¤©äº†å—ï¼Ÿ';
    } else if (currentHour < 18) {
        greeting = 'åˆå®‰ï¼ŒDr. {{ vet_profile.user.get_full_name|default:vet_profile.user.username }}ï¼ä»Šå¤©è¾›è‹¦äº†ï¼';
    } else {
        greeting = 'æ™šå®‰ï¼ŒDr. {{ vet_profile.user.get_full_name|default:vet_profile.user.username }}ï¼æ„Ÿè¬æ‚¨çš„ä»˜å‡ºï¼';
    }
    
    showInfoMessage(greeting);
}, 2000);

// å…¼å®¹æ€§å‡½æ•¸ï¼ˆä¿ç•™åŸæœ‰å‡½æ•¸åï¼‰
function viewVetAppointments() {
    viewTodayAppointments();
}

function viewVetPatients() {
    viewMyPatients();
}

function openCreateRecord() {
    createMedicalRecord();
}

// å°å‡ºå¿…è¦çš„å…¨åŸŸå‡½æ•¸
window.viewVetAppointments = viewVetAppointments;
window.viewVetPatients = viewVetPatients;
window.openCreateRecord = openCreateRecord;

console.log('âœ… ç¸é†«å¸«ä¸»é æ¨¡æ¿è¼‰å…¥å®Œæˆï¼ˆæ”¯æ´å®Œæ•´åŠŸèƒ½å’Œæ•¸æ“šåŒæ­¥ï¼‰');
</script>
{% endblock %}