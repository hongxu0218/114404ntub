{% extends "account/base.html" %}
{% load i18n %}

{% block title %}修改密碼｜毛日好 Paw&Day{% endblock %}

{% block extra_css %}
<style>
* {
    box-sizing: border-box;
}

.password-change-container {
    max-width: 540px;
    margin: 60px auto 40px;
    padding: 0 20px;
}

.breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 40px;
    font-size: 14px;
    color: #6b7280;
}

.breadcrumb a {
    color: #374151;
    text-decoration: none;
    transition: color 0.15s ease;
}

.breadcrumb a:hover {
    color: #111827;
}

.breadcrumb-separator {
    color: #d1d5db;
    font-size: 12px;
}

.form-container {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 32px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
}

.page-header {
    margin-bottom: 32px;
    text-align: center;
    padding-bottom: 24px;
    border-bottom: 1px solid #f3f4f6;
}

.page-header h1 {
    font-size: 24px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0 0 8px 0;
    letter-spacing: -0.02em;
}

.page-header .subtitle {
    color: #6b7280;
    font-size: 15px;
    font-weight: 400;
    margin: 0;
}

.form-group {
    margin-bottom: 24px;
    position: relative;
}

.form-group:last-of-type {
    margin-bottom: 32px;
}

.form-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 6px;
    line-height: 1.25;
}

.password-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.form-input {
    width: 100%;
    padding: 12px 16px;
    padding-right: 48px; /* 為眼睛圖標留空間 */
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 16px;
    line-height: 1.5;
    color: #111827;
    background-color: #ffffff;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-input.error {
    border-color: #ef4444;
}

.form-input.error:focus {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.form-input.success {
    border-color: #10b981;
}

.password-toggle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #6b7280;
    transition: color 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.password-toggle:hover {
    color: #374151;
}

.password-toggle:focus {
    outline: none;
    color: #3b82f6;
}

.password-toggle svg {
    width: 20px;
    height: 20px;
}

.password-requirements {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 20px;
    margin: 24px 0;
}

.requirements-title {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin: 0 0 12px 0;
}

.requirements-list {
    margin: 0;
    padding: 0;
    list-style: none;
}

.requirements-list li {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 6px;
    padding-left: 20px;
    position: relative;
    line-height: 1.4;
}

.requirements-list li::before {
    content: "•";
    position: absolute;
    left: 0;
    color: #9ca3af;
    font-weight: bold;
}

.error-message {
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 6px;
    padding: 12px 16px;
    margin-top: 8px;
    margin-bottom: 16px;
}

.error-message-text {
    font-size: 14px;
    color: #dc2626;
    margin: 0;
    line-height: 1.4;
}

.success-message {
    background-color: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 6px;
    padding: 12px 16px;
    margin-bottom: 24px;
}

.success-message-text {
    font-size: 14px;
    color: #166534;
    margin: 0;
    line-height: 1.4;
}

.form-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
    flex-direction: column;
}

.btn {
    padding: 12px 24px;
    border-radius: 6px;
    font-size: 15px;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.15s ease;
    border: 1px solid transparent;
    cursor: pointer;
    line-height: 1.5;
}

.btn-primary {
    background-color: #3b82f6;
    color: #ffffff;
    border-color: #3b82f6;
}

.btn-primary:hover {
    background-color: #2563eb;
    border-color: #2563eb;
}

.btn-primary:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
}

.btn-secondary {
    background-color: #ffffff;
    color: #374151;
    border-color: #d1d5db;
}

.btn-secondary:hover {
    background-color: #f9fafb;
    color: #111827;
    text-decoration: none;
}

.btn-secondary:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.25);
}

.security-notice {
    background-color: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 6px;
    padding: 20px;
    margin-top: 24px;
}

.security-notice-title {
    font-size: 14px;
    font-weight: 600;
    color: #1e40af;
    margin: 0 0 12px 0;
}

.security-notice-list {
    margin: 0;
    padding: 0 0 0 16px;
    color: #1e40af;
}

.security-notice-list li {
    font-size: 13px;
    margin-bottom: 6px;
    line-height: 1.4;
}

.password-match-indicator {
    font-size: 13px;
    margin-top: 6px;
    padding: 4px 0;
    transition: all 0.15s ease;
}

.password-match-indicator.hidden {
    opacity: 0;
}

.password-match-indicator.success {
    color: #10b981;
}

.password-match-indicator.error {
    color: #ef4444;
}

@media (min-width: 640px) {
    .form-actions {
        flex-direction: row;
        justify-content: flex-end;
    }
    
    .btn {
        width: auto;
        min-width: 120px;
    }
}

@media (max-width: 639px) {
    .password-change-container {
        margin: 40px auto 20px;
        padding: 0 16px;
    }
    
    .form-container {
        padding: 24px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="password-change-container">
    <!-- 導航路徑 -->
    <nav class="breadcrumb">
        <a href="{% url 'home' %}">首頁</a>
        <span class="breadcrumb-separator">›</span>
        <a href="{% url 'edit_profile' %}">帳號設定</a>
        <span class="breadcrumb-separator">›</span>
        <span>修改密碼</span>
    </nav>

    <div class="form-container">
        <!-- 頁面標題（移到框框內） -->
        <div class="page-header">
            <h1>修改密碼</h1>
            <p class="subtitle">為確保帳號安全，請定期更新您的密碼</p>
        </div>

        <!-- 成功訊息 -->
        {% if messages %}
            {% for message in messages %}
                {% if message.tags == 'success' %}
                    <div class="success-message">
                        <p class="success-message-text">{{ message }}</p>
                    </div>
                {% else %}
                    <div class="error-message">
                        <p class="error-message-text">{{ message }}</p>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}

        <form method="POST" action="{% url 'account_change_password' %}" id="passwordChangeForm">
            {% csrf_token %}
            
            <!-- 表單錯誤訊息 -->
            {% if form.non_field_errors %}
                <div class="error-message">
                    {% for error in form.non_field_errors %}
                        <p class="error-message-text">{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- 目前密碼 -->
            <div class="form-group">
                <label for="id_oldpassword" class="form-label">
                    目前密碼
                </label>
                <div class="password-input-wrapper">
                    <input 
                        type="password" 
                        name="oldpassword" 
                        id="id_oldpassword"
                        class="form-input{% if form.oldpassword.errors %} error{% endif %}"
                        placeholder="請輸入目前密碼"
                        required
                        autocomplete="current-password">
                    <button type="button" class="password-toggle" onclick="togglePassword('id_oldpassword', this)">
                        <!-- 隱藏狀態的眼睛圖標 -->
                        <svg class="eye-closed" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L12 12m-2.122-2.122L7.758 7.758M21 21l-3.6-3.6m0 0a10.05 10.05 0 01-3.15 2.425c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 012.963-4.387m5.893 8.25L21 21"></path>
                        </svg>
                        <!-- 顯示狀態的眼睛圖標 -->
                        <svg class="eye-open" style="display: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </button>
                </div>
                {% if form.oldpassword.errors %}
                    <div class="error-message">
                        {% for error in form.oldpassword.errors %}
                            <p class="error-message-text">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- 新密碼 -->
            <div class="form-group">
                <label for="id_password1" class="form-label">
                    新密碼
                </label>
                <div class="password-input-wrapper">
                    <input 
                        type="password" 
                        name="password1" 
                        id="id_password1"
                        class="form-input{% if form.password1.errors %} error{% endif %}"
                        placeholder="請輸入新密碼"
                        required
                        autocomplete="new-password">
                    <button type="button" class="password-toggle" onclick="togglePassword('id_password1', this)">
                        <svg class="eye-closed" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L12 12m-2.122-2.122L7.758 7.758M21 21l-3.6-3.6m0 0a10.05 10.05 0 01-3.15 2.425c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 012.963-4.387m5.893 8.25L21 21"></path>
                        </svg>
                        <svg class="eye-open" style="display: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </button>
                </div>
                {% if form.password1.errors %}
                    <div class="error-message">
                        {% for error in form.password1.errors %}
                            <p class="error-message-text">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- 密碼要求說明 -->
            <div class="password-requirements">
                <h3 class="requirements-title">密碼安全要求</h3>
                <ul class="requirements-list">
                    <li>密碼長度至少 8 個字元</li>
                    <li>不能與個人資訊過於相似</li>
                    <li>不能使用常見或簡單的密碼</li>
                    <li>不能全部都是數字</li>
                </ul>
            </div>

            <!-- 確認新密碼 -->
            <div class="form-group">
                <label for="id_password2" class="form-label">
                    確認新密碼
                </label>
                <div class="password-input-wrapper">
                    <input 
                        type="password" 
                        name="password2" 
                        id="id_password2"
                        class="form-input{% if form.password2.errors %} error{% endif %}"
                        placeholder="請再次輸入新密碼"
                        required
                        autocomplete="new-password">
                    <button type="button" class="password-toggle" onclick="togglePassword('id_password2', this)">
                        <svg class="eye-closed" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L12 12m-2.122-2.122L7.758 7.758M21 21l-3.6-3.6m0 0a10.05 10.05 0 01-3.15 2.425c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 012.963-4.387m5.893 8.25L21 21"></path>
                        </svg>
                        <svg class="eye-open" style="display: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                    </button>
                </div>
                <div id="passwordMatchIndicator" class="password-match-indicator hidden"></div>
                {% if form.password2.errors %}
                    <div class="error-message">
                        {% for error in form.password2.errors %}
                            <p class="error-message-text">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- 表單操作按鈕 -->
            <div class="form-actions">
                <a href="{% url 'edit_profile' %}" class="btn btn-secondary">
                    取消
                </a>
                <button type="submit" class="btn btn-primary">
                    更新密碼
                </button>
            </div>
        </form>

        <!-- 安全提醒 -->
        <div class="security-notice">
            <h3 class="security-notice-title">安全提醒</h3>
            <ul class="security-notice-list">
                <li>建議每 3-6 個月更新一次密碼</li>
                <li>請勿在多個網站使用相同密碼</li>
                <li>密碼更新後，請在其他裝置重新登入</li>
                <li>如發現帳號異常活動，請立即聯絡客服</li>
            </ul>
        </div>
    </div>
</div>

<script>
// 密碼顯示/隱藏切換功能
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const eyeClosed = button.querySelector('.eye-closed');
    const eyeOpen = button.querySelector('.eye-open');
    
    if (input.type === 'password') {
        input.type = 'text';
        eyeClosed.style.display = 'none';
        eyeOpen.style.display = 'block';
    } else {
        input.type = 'password';
        eyeClosed.style.display = 'block';
        eyeOpen.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const password1Input = document.getElementById('id_password1');
    const password2Input = document.getElementById('id_password2');
    const matchIndicator = document.getElementById('passwordMatchIndicator');
    
    function checkPasswordMatch() {
        const password1 = password1Input.value;
        const password2 = password2Input.value;
        
        if (password2.length === 0) {
            matchIndicator.classList.add('hidden');
            password2Input.classList.remove('success', 'error');
            return;
        }
        
        matchIndicator.classList.remove('hidden');
        
        if (password1 === password2) {
            matchIndicator.textContent = '密碼相符';
            matchIndicator.className = 'password-match-indicator success';
            password2Input.classList.remove('error');
            password2Input.classList.add('success');
        } else {
            matchIndicator.textContent = '密碼不相符';
            matchIndicator.className = 'password-match-indicator error';
            password2Input.classList.remove('success');
            password2Input.classList.add('error');
        }
    }
    
    password1Input.addEventListener('input', checkPasswordMatch);
    password2Input.addEventListener('input', checkPasswordMatch);
    
    // 表單提交驗證
    document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
        const password1 = password1Input.value;
        const password2 = password2Input.value;
        
        if (password1 !== password2) {
            e.preventDefault();
            password2Input.focus();
            matchIndicator.textContent = '密碼不相符，請重新確認';
            matchIndicator.className = 'password-match-indicator error';
        }
    });
});
</script>
{% endblock %}