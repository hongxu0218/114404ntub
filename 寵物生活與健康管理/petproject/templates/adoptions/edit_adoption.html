{% extends "base.html" %}
{% load form_tags %}
{% load static %}

{% block title %}編輯待領養寵物{% endblock %}

{% block extra_css %}
<style>
main {
    padding: 40px 20px;
    background-color: #fff8f0;
}
form {
    background: white;
    padding: 2em;
    border-radius: 10px;
    max-width: 700px;
    margin: auto;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h2 {
    text-align: center;
    margin-bottom: 1em;
}
label {
    display: block;
    margin-top: 2.5em;
    font-weight: bold;
}
input, select, textarea {
    width: 100%;
    padding: 0.5em;
    margin-top: 0.5em;
    border-radius: 5px;
    border: 1px solid #ccc;
}
.text-danger {
    color: red;
    font-size: 0.9em;
}

/* 新增圖片樣式 */
.img-upload-block {
    margin-top: 1.5em;
}
.preview-row {
    display: flex;
    align-items: center;
    gap: 1em;
    margin-bottom: 0.5em;
}
.preview-img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 0 3px rgba(0,0,0,0.1);
    max-height: 120px;
}
.filename {
    font-size: 0.9em;
    color: #555;
}

.button-row {
    display: flex;
    gap: 1em;
    margin-top: 2em;
}
.button-row .back-btn {
    flex: 2;
    background-color: #aaa;
    color: #fff;
}
.button-row .submit-btn {
    flex: 8;
    background-color: #ffaa00;
    color: #fff;
}
.button-row button {
    padding: 0.6em 1.5em;
    border: none;
    border-radius: 6px;
    font-size: 1em;
    cursor: pointer;
    font-weight: bold;
}
.button-row button:hover {
    opacity: 0.9;
}

.clearable-file-current {
  display: none;
}
  .label-bold {
  font-weight: bold;
}

.current-image {
  position: relative;
  display: inline-block;
}

.delete-img-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background-color: #dc3545;
  border: none;
  color: white;
  font-weight: bold;
  font-size: 14px;
  cursor: pointer;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.form-other-group{
  display:none;
  margin-bottom:0px;
}
#feature-other-group label {
  font-size: 0;     /* 文字大小為 0，不會顯示文字 */
  margin: 0;        /* 移除外距 */
  padding: 0;       /* 移除內距 */
  height: 0;        /* 高度壓縮 */
  line-height: 0;   /* 行高壓縮 */
}

#physical-condition-other-group label {
  font-size: 0;     /* 文字大小為 0，不會顯示文字 */
  margin: 0;        /* 移除外距 */
  padding: 0;       /* 移除內距 */
  height: 0;        /* 高度壓縮 */
  line-height: 0;   /* 行高壓縮 */
}
#adoption-condition-other-group label {
  font-size: 0;     /* 文字大小為 0，不會顯示文字 */
  margin: 0;        /* 移除外距 */
  padding: 0;       /* 移除內距 */
  height: 0;        /* 高度壓縮 */
  line-height: 0;   /* 行高壓縮 */
}


</style>
{% endblock %}

{% block content %}
<h2>編輯送養寵物</h2>
{# 非欄位錯誤只顯示一次在上方 #}
  {% if adoption_form.non_field_errors %}
    <div class="alert alert-danger">
      {% for error in adoption_form.non_field_errors %}
        <p>{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}

<form method="post" enctype="multipart/form-data" id="edit-adoption-form">
  {% csrf_token %}

  <!-- 種類 -->
  <div class="form-group">
    <label for="species_select"><strong>種類</strong></label>
    <select id="species_select" class="form-control" required>
      <option value="">請選擇</option>
      <option value="狗">狗</option>
      <option value="貓">貓</option>
      <option value="其他">其他</option>
    </select>
  </div>
  <!-- 其他種類 -->
  <div id="species_other_group" class="form-other-group">
    {{ adoption_form.species_other }}
    {% if adoption_form.species_other.errors %}
    <div class="text-danger">{{ adoption_form.species_other.errors }}</div>
    {% endif %}
  </div>
  <!-- 後端隱藏欄位 -->
  <input type="hidden" name="species" id="id_species" value="{{ adoption_form.species.value|default_if_none:'' }}">
  {% if adoption_form.species.errors %}
    <div class="text-danger">{{ adoption_form.species.errors }}</div>
  {% endif %}

  <!-- 品種 (前端顯示) -->
  <div class="form-group">
    <label for="breed_select"><strong>品種</strong></label>
    <select id="breed_select" class="form-control" required>
      <option value="">請選擇</option>
      <!-- 預設先空，會依種類動態更新 -->
    </select>
  </div>
  <!-- 其他品種 -->
  <div id="breed_other_group" class="form-other-group">
    {{ adoption_form.breed_other }}
    {% if adoption_form.breed_other.errors %}
    <div class="text-danger">{{ adoption_form.breed_other.errors }}</div>
    {% endif %}
  </div>
  <!-- 後端實際存的 breed（隱藏） -->
  <input type="hidden" name="breed" id="id_breed" value="{{ adoption_form.breed.value|default_if_none:'' }}">
    {% if adoption_form.breed.errors %}
    <div class="text-danger">{{ adoption_form.breed.errors }}</div>
    {% endif %}


  <!-- 疫苗 vaccine (前端顯示) -->
  <div class="form-group">
    <label for="vaccine_select"><strong>疫苗</strong></label>
    <select id="vaccine_select" class="form-control" required>
      <option value="">請選擇</option>
      <!-- 預設先空，會依種類動態更新 -->
    </select>
  </div>
  <!-- 其他疫苗 -->
  <div id="vaccine_other_group" class="form-other-group">
    {{ adoption_form.vaccine_other }}
    {% if adoption_form.vaccine_other.errors %}
    <div class="text-danger">{{ adoption_form.vaccine_other.errors }}</div>
    {% endif %}
  </div>
  <!-- 後端實際存的 vaccine（隱藏） -->
  <input type="hidden" name="vaccine" id="id_vaccine" value="{{ adoption_form.vaccine.value|default_if_none:'' }}">
    {% if adoption_form.vaccine.errors %}
    <div class="text-danger">{{ adoption_form.vaccine.errors }}</div>
    {% endif %}



  <!-- 名字 -->
  <label for="id_name">名字</label>
  {{ adoption_form.name }}<div class="text-danger">{{ adoption_form.name.errors }}</div>

  <!-- 絕育狀態 -->
  <label for="id_sterilization_status">絕育狀態</label>
  {{ adoption_form.sterilization_status }}
  <div class="text-danger">{{ adoption_form.sterilization_status.errors }}</div>


  <!-- 晶片 -->
  <label for="id_chip">晶片號碼</label>
  {{ adoption_form.chip }}<div class="text-danger">{{ adoption_form.chip.errors }}</div>

  <!-- 出生日期 -->
  <label for="id_birth_date">出生日期</label>
  {{ adoption_form.birth_date }}
  <div class="text-danger">{{ adoption_form.birth_date.errors }}</div>

  <!-- 性別 -->
  <label for="id_gender">性別</label>
  {{ adoption_form.gender }}<div class="text-danger">{{ adoption_form.gender.errors }}</div>

  <!-- 體重 -->
  <label for="id_weight">體重</label>
  {{ adoption_form.weight }}<div class="text-danger">{{ adoption_form.weight.errors }}</div>

<!-- 疫苗 vaccine -->





<!-- 個性特徵 -->
<div class="form-group">
  <label for="id_feature_choice"><strong>個性特徵</strong></label>
  {{ adoption_form.feature_choice }}
  {% if adoption_form.feature_choice.errors %}
  <div class="text-danger">
    {{ adoption_form.feature_choice.errors }}
  </div>
  {% endif %}
</div>
<!-- 其他說明輸入框（初始隱藏） -->
<div class="form-group" id="feature-other-group" style="display: none;">
  <label for="id_feature_other"></label>
  {{ adoption_form.feature_other }}
  {% if adoption_form.feature_other.errors %}
    <div class="text-danger">
      {% for error in adoption_form.feature_other.errors %}
        <p>{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}
</div>


<!-- 健康狀況 -->
<div class="form-group">
  <label for="id_physical_condition_choice"><strong>健康狀況</strong></label>
  {{ adoption_form.physical_condition_choice }}
  {% if adoption_form.physical_condition_choice.errors %}
  <div class="text-danger">
    {{ adoption_form.physical_condition_choice.errors }}
  </div>
  {% endif %}
</div>
<!-- 其他說明輸入框（初始隱藏） -->
<div class="form-group" id="physical-condition-other-group" style="display: none;">
  <label for="id_physical_condition_other"></label>
  {{ adoption_form.physical_condition_other }}
  {% if adoption_form.physical_condition_other.errors %}
    <div class="text-danger">
      {% for error in adoption_form.physical_condition_other.errors %}
        <p>{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}
</div>


<!-- 領養條件 -->
<div class="form-group">
  <label for="id_adoption_condition_choice"><strong>領養條件</strong></label>
  {{ adoption_form.adoption_condition_choice }}
  {% if adoption_form.adoption_condition_choice.errors %}
  <div class="text-danger">
    {{ adoption_form.adoption_condition_choice.errors }}
  </div>
  {% endif %}
</div>
<!-- 其他說明輸入框（初始隱藏） -->
<div class="form-group" id="adoption-condition-other-group" style="display: none;">
  <label for="id_adoption_condition_other"></label>
  {{ adoption_form.adoption_condition_other }}
  {% if adoption_form.adoption_condition_other.errors %}
    <div class="text-danger">
      {% for error in adoption_form.adoption_condition_other.errors %}
        <p>{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}
</div>

  <!-- 領養地點 -->
  <label for="id_adopt_place">領養地點</label>
  {{ adoption_form.adopt_place }}
  {% if adoption_form.adopt_place.errors %}
    <div class="text-danger">
      {{ adoption_form.adopt_place.errors }}
    </div>
  {% endif %}


  <!-- 聯絡電話 -->
  <label for="id_phone">手機號碼</label>
  {{ adoption_form.phone }}
  {% if adoption_form.phone.errors %}
    <div class="text-danger">
      {{ adoption_form.phone.errors }}
    </div>
  {% endif %}

  <!-- LINE ID -->
  <label for="id_line_id">LINE ID</label>
  {{ adoption_form.line_id }}
  {% if adoption_form.line_id.errors %}
    <div class="text-danger">
      {{ adoption_form.line_id.errors }}
    </div>
  {% endif %}



{% for pic in picture_fields %}
  <label class="label-bold" for="id_{{ pic.name }}">圖片 {{ pic.index }}</label>
  <div class="current-image">
    <img id="preview{{ pic.index }}" class="preview-img"
         {% if pic.image and pic.image.name %}
           src="{{ pic.image.url }}" style="display: block;"
         {% else %}
           src="" style="display: none;"
         {% endif %}>

    {% if pic.image and pic.image.name %}
      <button type="button" class="delete-img-btn"
              onclick="confirmDeleteImage({{ adoption.id }}, '{{ pic.name }}')">×</button>
    {% endif %}

    <span id="filename{{ pic.index }}" class="filename-span">
      {% if pic.image and pic.image.name %}
        {% endif %}
    </span>
    {% if adoption_form.adopt_picture1.errors %}
    <div class="text-danger">
      {{ adoption_form.adopt_picture1.errors }}
    </div>
  {% endif %}
  </div>

  <input type="file" name="{{ pic.name }}" accept="image/*" id="id_{{ pic.name }}">

{% endfor %}



  <div class="button-row">
    <a href="{% url 'adoption_petDetail' adoption.id %}">
      <button type="button" class="back-btn">返回</button>
    </a>
    <button type="submit" class="submit-btn">儲存修改</button>
  </div>
</form>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script>
  window.dog_choices = JSON.parse('{{ dog_choices|escapejs }}');
  window.cat_choices = JSON.parse('{{ cat_choices|escapejs }}');



document.addEventListener('DOMContentLoaded', function () {

  const form = document.querySelector('edit-adoption-form');

// 種類、品種 後端預填值
    const speciesSelect = document.getElementById('species_select');
    const speciesOtherGroup = document.getElementById('species_other_group');
    const speciesOtherInput = document.getElementById('id_species_other');
    const hiddenSpecies = document.getElementById('id_species');

    const breedSelect = document.getElementById('breed_select');
    const breedOtherGroup = document.getElementById('breed_other_group');
    const breedOtherInput = document.getElementById('id_breed_other');
    const hiddenBreed = document.getElementById('id_breed');

    const vaccineSelect = document.getElementById('vaccine_select');
    const vaccineOtherGroup = document.getElementById('vaccine_other_group');
    const vaccineOtherInput = document.getElementById('id_vaccine_other');
    const hiddenVaccine = document.getElementById('id_vaccine');

    const dogBreeds = {{ dog_choices|safe }};
    const catBreeds = {{ cat_choices|safe }};
    const dogVaccines = {{ dogvaccine_choices|safe }};
    const catVaccines = {{ catvaccine_choices|safe }};

    // 後端傳進來的原始值
    const initialSpecies = hiddenSpecies.value;
    const initialBreed = hiddenBreed.value;
    const initialVaccine = hiddenVaccine.value;

    function updateSpecies(setInitial=false) {
        const value = speciesSelect.value;
        hiddenSpecies.value = value;

        speciesOtherGroup.style.display = value === '其他' ? 'block' : 'none';
        if (value !== '其他' && !setInitial) speciesOtherInput.value = '';

        let breeds = [['', '請選擇']];
        if (value === '狗') breeds = breeds.concat(dogBreeds);
        if (value === '貓') breeds = breeds.concat(catBreeds);
        if (value === '其他') breeds.push(['其他', '其他']);

        breedSelect.innerHTML = breeds.map(o =>
            `<option value="${o[0]}">${o[1]}</option>`
        ).join('');

        if (setInitial && initialBreed) {
            breedSelect.value = initialBreed;
        }

        let vaccines = [['', '請選擇']];
        if (value === '狗') vaccines = vaccines.concat(dogVaccines);
        if (value === '貓') vaccines = vaccines.concat(catVaccines);
        if (value === '其他') vaccines.push(['其他', '其他']);

        vaccineSelect.innerHTML = vaccines.map(o =>
            `<option value="${o[0]}">${o[1]}</option>`
        ).join('');

        if (setInitial && initialVaccine) {
            vaccineSelect.value = initialVaccine;
        }

        updateBreed(setInitial);
        updateVaccine(setInitial);
    }

    function updateBreed(setInitial=false) {
        const value = breedSelect.value;
        hiddenBreed.value = value;

        breedOtherGroup.style.display = value === '其他' ? 'block' : 'none';
        if (value !== '其他' && !setInitial) breedOtherInput.value = '';
    }
    function updateVaccine(setInitial=false) {
        const value = vaccineSelect.value;
        hiddenVaccine.value = value;

        vaccineOtherGroup.style.display = value === '其他' ? 'block' : 'none';
        if (value !== '其他' && !setInitial) vaccineOtherInput.value = '';
    }

    speciesSelect.addEventListener('change', () => updateSpecies(false));
    breedSelect.addEventListener('change', () => updateBreed(false));
    vaccineSelect.addEventListener('change', () => updateVaccine(false));

// 初始化選項
if (initialSpecies) {
    if (initialSpecies === '狗' || initialSpecies === '貓' || initialSpecies === '其他') {
        speciesSelect.value = initialSpecies;
    } else {
        // 如果是使用者自填的
        speciesSelect.value = '其他';
        hiddenSpecies.value = '其他';
        speciesOtherInput.value = initialSpecies;  // 顯示到「其他種類」輸入框
    }
}
updateSpecies(true);

if (initialBreed) {
    const dogBreeds = {{ dog_choices|safe }};
    const catBreeds = {{ cat_choices|safe }};
    const validBreeds = dogBreeds.concat(catBreeds).map(b => b[0]).concat(['其他']);

    if (validBreeds.includes(initialBreed)) {
        breedSelect.value = initialBreed;
    } else {
        breedSelect.value = '其他';
        hiddenBreed.value = '其他';
        breedOtherInput.value = initialBreed;  // 顯示到「其他品種」輸入框
    }
}
updateBreed(true);

if (initialVaccine) {
    const dogVaccines = {{ dogvaccine_choices|safe }};
    const catVaccines = {{ catvaccine_choices|safe }};
    const validVaccines = dogVaccines.concat(catVaccines).map(b => b[0]).concat(['其他']);

    if (validVaccines.includes(initialVaccine)) {
        vaccineSelect.value = initialVaccine;
    } else {
        vaccineSelect.value = '其他';
        hiddenVaccine.value = '其他';
        vaccineOtherInput.value = initialVaccine;  // 顯示到「其他品種」輸入框
    }
}
updateVaccine(true);


    // ===== 提交前同步 hidden =====
    if (form) {
        form.addEventListener('submit', function (e) {
            hiddenSpecies.value = speciesSelect.value === '其他' ? speciesOtherInput.value.trim() : speciesSelect.value;
            hiddenBreed.value = breedSelect.value === '其他' ? breedOtherInput.value.trim() : breedSelect.value;
            hiddenVaccine.value = vaccineSelect.value === '其他' ? vaccineOtherInput.value.trim() : vaccineSelect.value;

            const enteredName = nameInput.value.trim().toLowerCase();
            if (otherPetNames.includes(enteredName)) {
                const confirmAdd = confirm("已有這個名字的毛孩，還是確定新增嗎？");
                if (!confirmAdd) e.preventDefault();
            }
        });
    }


    // ===== 圖片預覽 =====
  // 圖片預覽，支援多張圖片預覽
  const previewMap = {
    'id_adopt_picture1': 'preview1',
    'id_adopt_picture2': 'preview2',
    'id_adopt_picture3': 'preview3',
    'id_adopt_picture4': 'preview4'
  };

  Object.entries(previewMap).forEach(([inputId, previewId]) => {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);

    if (input && preview) {
      input.addEventListener('change', function () {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(input.files[0]);
        }
      });
    }
  });
function setupOtherToggle(selectId, groupId, inputId) {
    const selectEl = document.getElementById(selectId);
    const groupEl = document.getElementById(groupId);
    const inputEl = document.getElementById(inputId);

    if (!selectEl || !groupEl || !inputEl) {
        console.warn("⚠️ 找不到元素:", selectId, groupId, inputId);
        return;
    }

    function toggle() {
        let value = selectEl.value ? selectEl.value.trim() : "";

        // 抓取目前 <select> 的所有 option
        const options = Array.from(selectEl.options).map(o => o.value.trim());

        // 規則：
        // 1. 選到 "其他" → 顯示輸入框
        // 2. 或者選到的值不在 options 裡 → 當作 "其他"
        if (value === "其他" || (value && !options.includes(value))) {
            groupEl.style.display = "block";
            if (value !== "其他") inputEl.value = value; // 預填原始值
        } else {
            groupEl.style.display = "none";
            inputEl.value = "";
        }
    }

    selectEl.addEventListener("change", toggle);
    toggle(); // 初次載入
}

    setupOtherToggle('id_feature_choice', 'feature-other-group', 'id_feature_other');
    setupOtherToggle('id_physical_condition_choice', 'physical-condition-other-group', 'id_physical_condition_other');
    setupOtherToggle('id_adoption_condition_choice', 'adoption-condition-other-group', 'id_adoption_condition_other');



});
</script>
{% endblock %}
