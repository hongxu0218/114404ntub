{% extends "base.html" %}
{% load static %}

{% block title %}Êñ∞Â¢ûÂæÖÈ†òÈ§äÂØµÁâ©{% endblock %}

{% block extra_css %}
<style>
main {
    padding: 40px 20px;
    background-color: #fff8f0;
}

form {
    background: white;
    padding: 2em;
    border-radius: 10px;
    max-width: 700px;
    margin: auto;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

h2 {
    text-align: center;
    margin-bottom: 1em;
}

label {
    display: block;
    margin-top: 2.5em;
    font-weight: bold;
}

input, select, textarea {
    width: 100%;
    padding: 0.5em;
    margin-top: 0.5em;
    border-radius: 5px;
    border: 1px solid #ccc;
}

.text-danger {
    color: red;
    font-size: 0.9em;
}

#image-preview {
    display: none;
    margin-top: 1em;
    max-width: 100%;
    max-height: 300px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.button-row {
    display: flex;
    gap: 1em;
    margin-top: 2em;
}

.button-row .back-btn {
    flex: 1;
    background-color: #aaa;
    color: #fff;
}

.button-row .submit-btn {
    flex: 8;
    background-color: #ffaa00;
    color: #fff;
}

.button-row button {
    padding: 0.6em 1.5em;
    border: none;
    border-radius: 6px;
    font-size: 1em;
    cursor: pointer;
    font-weight: bold;
}

.button-row button:hover {
    opacity: 0.9;
}

  .preview-img {
    display: none;
    max-height: 120px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

</style>
{% endblock %}

{% block content %}
<h2>Êñ∞Â¢ûÈÄÅÈ§äÂØµÁâ©</h2>

<form method="post" enctype="multipart/form-data" id="add-adoption-form" novalidate>
  {% csrf_token %}

{% if form.errors %}
  <div class="alert alert-danger">
    <ul>
      {% for field, errors in form.errors.items %}
        <li><strong>{{ field }}:</strong>
          <ul>
            {% for error in errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </li>
      {% endfor %}
      {% if form.non_field_errors %}
        <li><strong>‰∏ÄËà¨ÈåØË™§:</strong>
          <ul>
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </li>
      {% endif %}
    </ul>
  </div>
{% endif %}
  <!-- Á®ÆÈ°û -->
  <div class="form-group">
    <label for="species_select"><strong>Á®ÆÈ°û</strong></label>
    <select id="species_select" class="form-control" required>
      <option value="">Ë´ãÈÅ∏Êìá</option>
      <option value="Áãó">Áãó</option>
      <option value="Ë≤ì">Ë≤ì</option>
      <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
    </select>
  </div>
  <!-- ÂÖ∂‰ªñÁ®ÆÈ°û -->
  <div id="species_other_group" class="form-other-group">
    {{ adoption_form.species_other }}
    {% if adoption_form.species_other.errors %}
    <div class="text-danger">{{ adoption_form.species_other.errors }}</div>
    {% endif %}
  </div>
  <!-- ÂæåÁ´ØÈö±ËóèÊ¨Ñ‰Ωç -->
  {{ adoption_form.species }}
    {% if adoption_form.species.errors %}
    <div class="text-danger">{{ adoption_form.species.errors }}</div>
    {% endif %}

  <!-- ÂìÅÁ®Æ (ÂâçÁ´ØÈ°ØÁ§∫) -->
  <div class="form-group">
    <label for="breed_select"><strong>ÂìÅÁ®Æ</strong></label>
    <select id="breed_select" class="form-control" required>
      <option value="">Ë´ãÈÅ∏Êìá</option>
      <!-- È†êË®≠ÂÖàÁ©∫ÔºåÊúÉ‰æùÁ®ÆÈ°ûÂãïÊÖãÊõ¥Êñ∞ -->
    </select>
  </div>
  <!-- ÂÖ∂‰ªñÂìÅÁ®Æ -->
  <div id="breed_other_group" class="form-other-group">
    {{ adoption_form.breed_other }}
    {% if adoption_form.breed_other.errors %}
    <div class="text-danger">{{ adoption_form.breed_other.errors }}</div>
    {% endif %}
  </div>
  <!-- ÂæåÁ´ØÂØ¶ÈöõÂ≠òÁöÑ breedÔºàÈö±ËóèÔºâ -->
  {{ adoption_form.breed }}
    {% if adoption_form.breed.errors %}
    <div class="text-danger">{{ adoption_form.breed.errors }}</div>
    {% endif %}

  <!-- ÂêçÂ≠ó -->
  <div class="form-group">
    {{ adoption_form.name.label_tag }}
    {{ adoption_form.name}}<div class="text-danger">{{ adoption_form.name.errors }}</div>
  </div>

  <!-- ÁµïËÇ≤ÁãÄÊÖã -->
  <div class="form-group">
    {{ adoption_form.sterilization_status.label_tag }}
    {{ adoption_form.sterilization_status }}
    <div class="text-danger">{{ adoption_form.sterilization_status.errors }}</div>
  </div>

  <!-- Êô∂ÁâáËôüÁ¢º -->
  <div class="form-group">
    {{ adoption_form.chip.label_tag }}
    {{ adoption_form.chip }}<div class="text-danger">{{ adoption_form.chip.errors }}</div>
  </div>

  <!-- ÁîüÊó• -->
  <div class="form-group">
    {{ adoption_form.birth_date.label_tag }}
    {{ adoption_form.birth_date }}
    <div class="text-danger">{{ adoption_form.birth_date.errors }}</div>
  </div>

  <!-- ÊÄßÂà• -->
  <div class="form-group">
    {{ adoption_form.gender.label_tag }}
    {{ adoption_form.gender }}<div class="text-danger">{{ adoption_form.gender.errors }}</div>
  </div>

  <!-- È´îÈáç -->
  <div class="form-group">
    {{ adoption_form.weight.label_tag }}
    {{ adoption_form.weight }}<div class="text-danger">{{ adoption_form.weight.errors }}</div>
  </div>


  <!-- Áñ´Ëãó vaccine (ÂâçÁ´ØÈ°ØÁ§∫) -->
  <div class="form-group">
    <label for="vaccine_select"><strong>Áñ´Ëãó</strong></label>
    <select id="vaccine_select" class="form-control" required>
      <option value="">Ë´ãÈÅ∏Êìá</option>
      <!-- È†êË®≠ÂÖàÁ©∫ÔºåÊúÉ‰æùÁ®ÆÈ°ûÂãïÊÖãÊõ¥Êñ∞ -->
    </select>
  </div>
  <!-- ÂÖ∂‰ªñÁñ´Ëãó -->
  <div id="vaccine_other_group" class="form-other-group">
    {{ adoption_form.vaccine_other }}
    {% if adoption_form.vaccine_other.errors %}
    <div class="text-danger">{{ adoption_form.vaccine_other.errors }}</div>
    {% endif %}
  </div>
  <!-- ÂæåÁ´ØÂØ¶ÈöõÂ≠òÁöÑ breedÔºàÈö±ËóèÔºâ -->
  {{ adoption_form.vaccine }}
    {% if adoption_form.vaccine.errors %}
    <div class="text-danger">{{ adoption_form.vaccine.errors }}</div>
    {% endif %}


<!-- ÂÄãÊÄßÁâπÂæµ -->
<div class="form-group">
  <label for="id_feature_choice"><strong>ÂÄãÊÄßÁâπÂæµ</strong></label>
  {{ adoption_form.feature_choice }}
  {% if adoption_form.feature_choice.errors %}
  <div class="text-danger">
    {{ adoption_form.feature_choice.errors }}
  </div>
  {% endif %}
</div>
<!-- ÂÖ∂‰ªñË™™ÊòéËº∏ÂÖ•Ê°ÜÔºàÂàùÂßãÈö±ËóèÔºâ -->
<div class="form-group" id="feature-other-group" style="display: none;">
  {{ adoption_form.feature_other }}
  {% if adoption_form.feature_other.errors %}
    <div class="text-danger">
      {% for error in adoption_form.feature_other.errors %}
        <p>{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}
</div>


<!-- ÂÅ•Â∫∑ÁãÄÊ≥Å -->
<div class="form-group">
  <label for="id_physical_condition_choice"><strong>ÂÅ•Â∫∑ÁãÄÊ≥Å</strong></label>
  {{ adoption_form.physical_condition_choice }}
  {% if adoption_form.physical_condition_choice.errors %}
  <div class="text-danger">
    {{ adoption_form.physical_condition_choice.errors }}
  </div>
  {% endif %}
</div>
<!-- ÂÖ∂‰ªñË™™ÊòéËº∏ÂÖ•Ê°ÜÔºàÂàùÂßãÈö±ËóèÔºâ -->
<div class="form-group" id="physical-condition-other-group" style="display: none;">
  {{ adoption_form.physical_condition_other }}
  {% if adoption_form.physical_condition_other.errors %}
    <div class="text-danger">
      {% for error in adoption_form.physical_condition_other.errors %}
        <p>{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}
</div>


<!-- È†òÈ§äÊ¢ù‰ª∂ -->
<div class="form-group">
  <label for="id_adoption_condition_choice"><strong>È†òÈ§äÊ¢ù‰ª∂</strong></label>
  {{ adoption_form.adoption_condition_choice }}
  {% if adoption_form.adoption_condition_choice.errors %}
  <div class="text-danger">
    {{ adoption_form.adoption_condition_choice.errors }}
  </div>
  {% endif %}
</div>
<!-- ÂÖ∂‰ªñË™™ÊòéËº∏ÂÖ•Ê°ÜÔºàÂàùÂßãÈö±ËóèÔºâ -->
<div class="form-group" id="adoption-condition-other-group" style="display: none;">
  {{ adoption_form.adoption_condition_other }}
  {% if adoption_form.adoption_condition_other.errors %}
    <div class="text-danger">
      {% for error in adoption_form.adoption_condition_other.errors %}
        <p>{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}
</div>


  <!-- È†òÈ§äÂú∞Èªû -->
  <div class="form-group">
    {{ adoption_form.adopt_place.label_tag }}
    {{ adoption_form.adopt_place }}
    {% if adoption_form.adopt_place.errors %}
    <div class="text-danger">
      {{ adoption_form.adopt_place.errors }}
    </div>
  {% endif %}
  </div>





  <!-- ÊâãÊ©üËôüÁ¢º -->
  <div class="form-group">
    {{ adoption_form.phone.label_tag }}
    {{ adoption_form.phone }}
    {% if adoption_form.phone.errors %}
    <div class="text-danger">
      {{ adoption_form.phone.errors }}
    </div>
  {% endif %}
  </div>

  <!-- line_id -->
  <div class="form-group">
    {{ adoption_form.line_id.label_tag }}
    {{ adoption_form.line_id }}
    {% if adoption_form.line_id.errors %}
    <div class="text-danger">
      {{ adoption_form.line_id.errors }}
    </div>
  {% endif %}
  </div>


  <!-- ÂúñÁâá1 -->
  <div class="form-group">
    {{ adoption_form.adopt_picture1.label_tag }}
    <img class="preview-img" id="preview1" src="#" alt="È†êË¶ΩÂúñÁâá">
    {{ adoption_form.adopt_picture1 }}
    {% if adoption_form.adopt_picture1.errors %}
    <div class="text-danger">
      {{ adoption_form.adopt_picture1.errors }}
    </div>
  {% endif %}
  </div>
   <!-- ÂúñÁâá2 -->
  <div class="form-group">
    {{ adoption_form.adopt_picture2.label_tag }}
    <img class="preview-img" id="preview2" src="#" alt="È†êË¶ΩÂúñÁâá">
    {{ adoption_form.adopt_picture2 }}
  </div>
   <!-- ÂúñÁâá3 -->
  <div class="form-group">
    {{ adoption_form.adopt_picture3.label_tag }}
    <img class="preview-img" id="preview3" src="#" alt="È†êË¶ΩÂúñÁâá">

    {{ adoption_form.adopt_picture3 }}
  </div>
   <!-- ÂúñÁâá4 -->
  <div class="form-group">
    {{ adoption_form.adopt_picture4.label_tag }}
      <img class="preview-img" id="preview4" src="#" alt="È†êË¶ΩÂúñÁâá">
    {{ adoption_form.adopt_picture4 }}
  </div>


  <div class="button-row">
    <button type="button" onclick="location.href='{% url 'my_adoption' %}'" class="back-btn">ËøîÂõû</button>
    <button type="submit" class="submit-btn">Êñ∞Â¢û‰∏¶ÂàäÁôª</button>
  </div>
</form>
{% endblock %}


{% block extra_js %}
<script>

document.addEventListener("DOMContentLoaded", function () {
  // ÂúñÁâáÈ†êË¶ΩÔºåÊîØÊè¥Â§öÂºµÂúñÁâáÈ†êË¶Ω
const input = document.getElementById('id_adopt_picture1'); // ÊàñÂÖ∂‰ªñ input
const preview = document.getElementById('preview1');
if (input && preview) {
  input.addEventListener('change', function() {
    preview.innerHTML = ''; // Ê∏ÖÁ©∫ËàäÂúñÁâá
    for (let i = 0; i < input.files.length; i++) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '150px';
        img.style.marginRight = '5px';
        preview.appendChild(img);
      };
      reader.readAsDataURL(input.files[i]);
    }
  });
}



  // ÂêçÂ≠óÈáçË§áÊ™¢Êü•
  const form = document.getElementById("add-adoption-form");
  const nameInput = document.getElementById("id_name");

  // Âæû Django ÂÇ≥‰æÜÁöÑÂÖ∂‰ªñÂêçÂ≠óÔºåÁµ±‰∏ÄËΩâÂ∞èÂØ´
  const otherPetNames = {{ other_pet_names|default:"[]"|safe|escapejs }}.map(n => n.toLowerCase().trim());

  if (form && nameInput) {
    form.addEventListener("submit", function (event) {
      const enteredName = nameInput.value.trim().toLowerCase(); // üîë ËΩâÂ∞èÂØ´ + ÂéªÁ©∫Ê†º
      if (otherPetNames.includes(enteredName)) {
        const confirmAdd = confirm("Â∑≤ÊúâÈÄôÂÄãÂêçÂ≠óÁöÑÊØõÂ≠©ÔºåÈÇÑÊòØÁ¢∫ÂÆöÊñ∞Â¢ûÂóéÔºü");
        if (!confirmAdd) {
          event.preventDefault(); // ÂèñÊ∂àÈÄÅÂá∫
        }
      }
    });
  }

// --- ÂÄãÊÄßÁâπÂæµ/ÂÅ•Â∫∑ÁãÄÊ≥Å/È†òÈ§äÊ¢ù‰ª∂ ÁöÑÈ°ØÁ§∫ÂàáÊèõ ---
function setupOtherToggle(selectId, groupId, inputId) {
  const selectEl = document.getElementById(selectId);
  const groupEl = document.getElementById(groupId);
  const inputEl = document.getElementById(inputId);

  function toggle() {
    if (selectEl.value === 'ÂÖ∂‰ªñ') {
      groupEl.style.display = 'block';
    } else {
      groupEl.style.display = 'none';
      inputEl.value = '';
    }
  }

  selectEl.addEventListener('change', toggle);
  toggle(); // ÂàùÊ¨°ËºâÂÖ•Ê™¢Êü•
}

// ‰ΩøÁî®ÁØÑ‰æã
setupOtherToggle('id_feature_choice', 'feature-other-group', 'id_feature_other');
setupOtherToggle('id_physical_condition_choice', 'physical-condition-other-group', 'id_physical_condition_other');
setupOtherToggle('id_adoption_condition_choice', 'adoption-condition-other-group', 'id_adoption_condition_other');

  ////////////////////////ÂàÜÂâ≤Á∑ö////////////////////////////////////////

      // DOM ÂÖÉÁ¥†(Á®ÆÈ°û/ÂìÅÁ®Æ/Áñ´Ëãó)
    const speciesSelect = document.getElementById('species_select');
    const speciesOtherGroup = document.getElementById('species_other_group');
    const speciesOtherInput = document.getElementById('id_species_other');
    const hiddenSpecies = document.getElementById('id_species');

    const breedSelect = document.getElementById('breed_select');
    const breedOtherGroup = document.getElementById('breed_other_group');
    const breedOtherInput = document.getElementById('id_breed_other');
    const hiddenBreed = document.getElementById('id_breed');

    const vaccineSelect = document.getElementById('vaccine_select');
    const vaccineOtherGroup = document.getElementById('vaccine_other_group');
    const vaccineOtherInput = document.getElementById('id_vaccine_other');
    const hiddenVaccine = document.getElementById('id_vaccine');

    // ÂæåÁ´ØÂÇ≥ÂÖ•ÁöÑÈÅ∏È†Ö (Á¢∫‰øùÂú® views.py Áî® json.dumps ÂÇ≥ÂÖ•)
    const dogBreeds = {{ dog_choices|safe }};
    const catBreeds = {{ cat_choices|safe }};
    const dogVaccines = {{ dogvaccine_choices|safe }};
    const catVaccines = {{ catvaccine_choices|safe }};

    // ÂæåÁ´ØÂéüÂßãÂÄº
    const initialSpecies = hiddenSpecies.value;
    const initialBreed = hiddenBreed.value;
    const initialVaccine = hiddenVaccine.value;

    // ===== Êõ¥Êñ∞ÂìÅÁ®Æ =====
    function updateBreed(setInitial=false) {
        const value = breedSelect.value;
        hiddenBreed.value = value;

        breedOtherGroup.style.display = value === 'ÂÖ∂‰ªñ' ? 'block' : 'none';
        if (value === 'ÂÖ∂‰ªñ') {
            breedOtherInput.setAttribute("required", "required");
        } else {
            breedOtherInput.removeAttribute("required");
            if (!setInitial) breedOtherInput.value = '';
        }
    }

    // ===== Êõ¥Êñ∞Áñ´Ëãó =====
    function updateVaccine(setInitial=false) {
        const value = vaccineSelect.value;
        hiddenVaccine.value = value;

        vaccineOtherGroup.style.display = value === 'ÂÖ∂‰ªñ' ? 'block' : 'none';
        if (value === 'ÂÖ∂‰ªñ') {
            vaccineOtherInput.setAttribute("required", "required");
        } else {
            vaccineOtherInput.removeAttribute("required");
            if (!setInitial) vaccineOtherInput.value = '';
        }
    }

    // ===== Êõ¥Êñ∞Á®ÆÈ°û =====
function updateSpecies(setInitial=false) {
    const value = speciesSelect.value;
    hiddenSpecies.value = value;

    // Á®ÆÈ°û„ÄåÂÖ∂‰ªñ„ÄçËá™Â°´Ê°Ü
    speciesOtherGroup.style.display = value === 'ÂÖ∂‰ªñ' ? 'block' : 'none';
    if (value === 'ÂÖ∂‰ªñ') {
        speciesOtherInput.setAttribute("required", "required");
    } else {
        speciesOtherInput.removeAttribute("required");
        if (!setInitial) speciesOtherInput.value = '';
    }

    // Êõ¥Êñ∞ÂìÅÁ®ÆÈÅ∏È†Ö
    let breeds = [['', 'Ë´ãÈÅ∏Êìá']];
    if (value === 'Áãó') breeds = breeds.concat(dogBreeds);
    if (value === 'Ë≤ì') breeds = breeds.concat(catBreeds);
    if (value === 'ÂÖ∂‰ªñ') breeds.push(['ÂÖ∂‰ªñ', 'ÂÖ∂‰ªñ']);

    breedSelect.innerHTML = breeds.map(o =>
        `<option value="${o[0]}">${o[1]}</option>`
    ).join('');

    // Êõ¥Êñ∞Áñ´ËãóÈÅ∏È†Ö
    let vaccines = [['', 'Ë´ãÈÅ∏Êìá']];
    if (value === 'Áãó') vaccines = vaccines.concat(dogVaccines);
    if (value === 'Ë≤ì') vaccines = vaccines.concat(catVaccines);
    if (value === 'ÂÖ∂‰ªñ') vaccines.push(['ÂÖ∂‰ªñ', 'ÂÖ∂‰ªñ']);

    vaccineSelect.innerHTML = vaccines.map(o =>
        `<option value="${o[0]}">${o[1]}</option>`
    ).join('');

    // ‚òÖ Áï∂Á®ÆÈ°û=ÂÖ∂‰ªñÔºåËá™ÂãïÈÅ∏ÊìáÂìÅÁ®ÆÂíåÁñ´Ëãó„ÄåÂÖ∂‰ªñ„Äç‰∏¶È°ØÁ§∫Ëá™Â°´Ê°Ü
    if (value === 'ÂÖ∂‰ªñ' && !setInitial) {
        breedSelect.value = 'ÂÖ∂‰ªñ';
        vaccineSelect.value = 'ÂÖ∂‰ªñ';
        hiddenBreed.value = 'ÂÖ∂‰ªñ';
        hiddenVaccine.value = 'ÂÖ∂‰ªñ';
        breedOtherGroup.style.display = 'block';
        breedOtherInput.setAttribute("required", "required");
        vaccineOtherGroup.style.display = 'block';
        vaccineOtherInput.setAttribute("required", "required");
    }

    // ÂàùÂßãÂìÅÁ®Æ/Áñ´Ëãó
    if (setInitial && initialBreed) {
        const validBreeds = breeds.map(b => b[0]);
        if (validBreeds.includes(initialBreed)) {
            breedSelect.value = initialBreed;
        } else {
            breedSelect.value = 'ÂÖ∂‰ªñ';
            hiddenBreed.value = 'ÂÖ∂‰ªñ';
            breedOtherInput.value = initialBreed;
        }
    }

    if (setInitial && initialVaccine) {
        const validVaccines = vaccines.map(b => b[0]);
        if (validVaccines.includes(initialVaccine)) {
            vaccineSelect.value = initialVaccine;
        } else {
            vaccineSelect.value = 'ÂÖ∂‰ªñ';
            hiddenVaccine.value = 'ÂÖ∂‰ªñ';
            vaccineOtherInput.value = initialVaccine;
        }
    }

    updateBreed(setInitial);
    updateVaccine(setInitial);
}


    // ===== ‰∫ã‰ª∂Á∂ÅÂÆö =====
    speciesSelect.addEventListener('change', () => updateSpecies(false));
    breedSelect.addEventListener('change', () => updateBreed(false));
    vaccineSelect.addEventListener('change', () => updateVaccine(false));

    // ===== Êèê‰∫§ÂâçÂêåÊ≠•ÂÖ∂‰ªñËá™Â°´ÂÄºÂà∞ hidden =====
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function () {
            if (speciesSelect.value === 'ÂÖ∂‰ªñ') hiddenSpecies.value = speciesOtherInput.value.trim();
            if (breedSelect.value === 'ÂÖ∂‰ªñ') hiddenBreed.value = breedOtherInput.value.trim();
            if (vaccineSelect.value === 'ÂÖ∂‰ªñ') hiddenVaccine.value = vaccineOtherInput.value.trim();
        });
    }

    // ===== ÂàùÂßãÂåñ =====
    if (initialSpecies) {
        if (['Áãó','Ë≤ì','ÂÖ∂‰ªñ'].includes(initialSpecies)) {
            speciesSelect.value = initialSpecies;
        } else {
            speciesSelect.value = 'ÂÖ∂‰ªñ';
            hiddenSpecies.value = 'ÂÖ∂‰ªñ';
            speciesOtherInput.value = initialSpecies;
        }
    }
    updateSpecies(true);
});



</script>
{% endblock %}

