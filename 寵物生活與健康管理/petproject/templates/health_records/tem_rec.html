{% extends "base.html" %}
{% load static %}

{% block title %}體溫紀錄{% endblock %}

{% block extra_css %}
<style>
    main {
        padding: 2em;
        background-color: #f9f9f9;
    }

    h2, h3 {
        color: #2c3e50;
    }

    .btn {
        padding: 8px 16px;
        background-color: #95a5a6;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 16px;
        transition: background-color 0.2s ease;
        margin-right: 6px;
        display: inline-block;
    }

    .btn:hover {
        background-color: #7f8c8d;
    }

    .btn-primary {
        background-color: #3498db;
    }

    .btn-primary:hover {
        background-color: #2980b9;
    }

    .month-nav {
        text-align: center;
        margin: 20px 0;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 30px;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    thead {
        background-color: #ecf0f1;
    }

    th, td {
        border: 1px solid #e0e0e0;
        padding: 12px;
        text-align: center;
        color: #34495e;
    }

    .record-row:hover {
        background-color: #f5f5f5;
        cursor: pointer;
    }

    .actions {
        visibility: hidden;
        height: 0;
        overflow: hidden;
        transition: all 0.2s ease;
    }

    .actions.show {
        visibility: visible;
        height: auto;
        margin-top: 8px;
    }
    main {
        background-color: #fff7ed;
    }

</style>
{% endblock %}

{% block content %}
<h2>體溫紀錄 - {{ pet.name }}</h2>
<a href="{% url 'add_tem' pet_id=pet.id %}" class="btn btn-primary">＋ 新增體溫</a>

<div class="month-nav">
    <button onclick="changeMonth(-1)" class="btn">&lt;</button>
    <span id="currentMonth">{{ current_month_display }}</span>
    <button onclick="changeMonth(1)" class="btn" {% if is_current_month %}disabled{% endif %}>&gt;</button>
</div>

<canvas id="temperatureChart" height="100" style="margin-top: 30px;"></canvas>

<h3>詳細資料</h3>
<table>
    <thead>
        <tr>
            <th>紀錄時間</th>
            <th>體溫</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for record in records %}
        <tr class="record-row">
            <td>{{record.recorded_date}} {{ record.submitted_at }}</td>
            <td>{{ record.raw_content }}°C</td>
            <td>
                <div class="actions">
                    <a href="{% url 'edit_tem' pet_id=pet.id record_id=record.id %}" class="btn">修改</a>
                    <a href="{% url 'delete_tem' pet_id=pet.id record_id=record.id %}" class="btn" onclick="return confirm('確定要刪除這筆體溫資料嗎？')">刪除</a>
                </div>
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="3">無體溫資料</td></tr>
        {% endfor %}
    </tbody>
</table>

<a href="{% url 'health_rec' %}" class="btn" style="margin-top: 30px;">返回健康紀錄</a>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('temperatureChart').getContext('2d');
const temperatureChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for r in records %}'{{ r.date }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for r in records %}{{ r.temperature|default:'null' }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            borderColor: '#e74c3c',
            fill: false,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                title: { display: true, text: '日期' }
            },
            y: {
                title: { display: true, text: '體溫 (°C)' },
                beginAtZero: false
            }
        }
    }
});

document.addEventListener('DOMContentLoaded', function () {
    const rows = document.querySelectorAll('.record-row');
    rows.forEach(row => {
        row.addEventListener('click', () => {
            const actionDiv = row.querySelector('.actions');
            const isShown = actionDiv.classList.contains('show');
            document.querySelectorAll('.actions.show').forEach(div => div.classList.remove('show'));
            if (!isShown) actionDiv.classList.add('show');
        });
    });
});

function changeMonth(offset) {
    const currentMonth = '{{ current_month }}';
    const [year, month] = currentMonth.split('-').map(Number);
    const newDate = new Date(year, month - 1 + offset);
    const today = new Date();
    const maxDate = new Date(today.getFullYear(), today.getMonth());

    if (newDate > maxDate) {
        alert("不能查看未來月份");
        return;
    }

    const newMonthStr = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}`;
    window.location.href = `?month=${newMonthStr}`;
}
</script>
{% endblock %}
