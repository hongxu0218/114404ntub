
# 🐾 自動寄送預約提醒信（Django + Windows 工作排程器）

本說明將協助你在 Windows 11（含虛擬機）中，透過 Task Scheduler 每天自動寄出「明天要看診」的預約提醒信給飼主。

---

## 📁 專案結構需求

在 Django 專案的 `petapp` 目錄下，建立以下結構：

```
petapp/
├── management/
│   ├── __init__.py
│   └── commands/
│       ├── __init__.py
│       └── send_appointment_reminders.py
```

---

## 📜 指令內容（send_appointment_reminders.py）

```python
from django.core.management.base import BaseCommand
from django.utils.timezone import now
from django.core.mail import send_mail
from petapp.models import VetAppointment
from datetime import timedelta
from django.conf import settings

class Command(BaseCommand):
    help = 'Send email reminders to owners one day before appointments'

    def handle(self, *args, **kwargs):
        tomorrow = now().date() + timedelta(days=1)
        appointments = VetAppointment.objects.filter(date=tomorrow)

        for appt in appointments:
            owner = appt.owner
            pet = appt.pet
            vet = appt.vet

            subject = f"【毛日好】提醒您明日看診：{pet.name}"
            message = f"""親愛的 {owner.last_name or ''}{owner.first_name or owner.username}，您好：

這是您預約的提醒通知：

🐾 寵物：{pet.name}  
📅 日期：{appt.date}  
🕒 時間：{appt.time.strftime('%H:%M')}  
🏥 診所：{vet.clinic_name or '（未填寫）'}

請準時到診，如需取消請盡早操作，謝謝您！

— 毛日好（Paw&Day）系統
"""

            send_mail(
                subject,
                message,
                settings.DEFAULT_FROM_EMAIL,
                [owner.email],
                fail_silently=False
            )

        self.stdout.write(self.style.SUCCESS(f"已寄出 {appointments.count()} 封提醒信件"))
```

---

## 🛠 Windows 工作排程器設定步驟（每日自動寄信）

### 1️⃣ 開啟 Task Scheduler（工作排程器）
- 點「開始」> 搜尋「Task Scheduler」或「工作排程器」> 開啟

### 2️⃣ 建立新排程
- 點右邊「**建立基本工作...**」
- 命名為：`每日寄送預約提醒`
- 點「下一步」

### 3️⃣ 設定排程時間
- 選「每天」
- 選定執行時間，例如 `02:00 AM`
- 點「下一步」

### 4️⃣ 選擇動作
- 選「啟動程式」> 下一步

### 5️⃣ 填寫指令
- **程式或指令碼**：輸入 Python 的完整路徑，例如：
  ```
  C:\Users\你的使用者名稱\AppData\Local\Programs\Python\Python312\python.exe
  ```
- **新增引數**：
  ```
  manage.py send_appointment_reminders
  ```
- **啟動位置**：輸入你的 Django 專案路徑，例如：
  ```
  C:\Users\你的使用者名稱\OneDrive\桌面\petproject
  ```

### 6️⃣ 完成！可手動右鍵「執行」一次測試

---

## 🧪 測試指令

```bash
python manage.py send_appointment_reminders
```

執行成功會顯示：

```
已寄出 X 封提醒信件
```

---

## 💌 信件寄送設定提示

請確認 `settings.py` 中有正確設置寄信設定：

```python
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'your_email@gmail.com'
EMAIL_HOST_PASSWORD = 'your_app_password'  # 使用應用程式密碼
DEFAULT_FROM_EMAIL = 'your_email@gmail.com'
```

---

## ✅ 成果

- 每天凌晨會自動通知飼主「明天的預約」
- 提升準時看診率，避免漏診！

---

如需協助或想進一步加入 Google Calendar、簡訊通知等功能，請聯繫開發者 😺

